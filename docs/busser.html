<!DOCTYPE html>  <html> <head>   <title>busser.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               busser.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre> 
<span class="nv">util         = </span><span class="nx">require</span> <span class="s2">&quot;util&quot;</span>
<span class="nv">fs           = </span><span class="nx">require</span> <span class="s2">&quot;fs&quot;</span>
<span class="nv">http         = </span><span class="nx">require</span> <span class="s2">&quot;http&quot;</span>
<span class="nv">url          = </span><span class="nx">require</span> <span class="s2">&quot;url&quot;</span>
<span class="nv">path_module  = </span><span class="nx">require</span> <span class="s2">&quot;path&quot;</span>
<span class="nv">nconf        = </span><span class="nx">require</span> <span class="s2">&quot;nconf&quot;</span>
<span class="nv">prompt       = </span><span class="nx">require</span> <span class="s2">&quot;prompt&quot;</span>
<span class="nv">colors       = </span><span class="nx">require</span> <span class="s2">&quot;colors&quot;</span>
<span class="p">{</span><span class="nx">exec</span><span class="p">}</span>       <span class="o">=</span> <span class="nx">require</span> <span class="s2">&quot;child_process&quot;</span>
<span class="p">{</span><span class="nx">spawn</span><span class="p">}</span>      <span class="o">=</span> <span class="nx">require</span> <span class="s2">&quot;child_process&quot;</span>
<span class="nv">EventEmitter = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>
<span class="nv">uglify =</span>
  <span class="nv">parser: </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;uglify-js&quot;</span><span class="p">).</span><span class="nx">parser</span>
  <span class="nv">processor: </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;uglify-js&quot;</span><span class="p">).</span><span class="nx">uglify</span>

<span class="k">try</span>
  <span class="nv">less = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;less&quot;</span><span class="p">)</span>
<span class="k">catch</span> <span class="nx">e</span>
  <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;WARNING: &#39;less&#39; could not be required.&quot;</span>
  <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;         You won&#39;t be able to parse .less files.&quot;</span>
  <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;         Install it with `npm install less`.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Input Arguments Handling</h2>

<p><em>appTargets</em> are normal looking "filename" style app names as used in the busser.json
conf file, such as HelloWorld-dev, where the -dev is a user chosen suffix to
distinguish between another configuration of theirs, say HelloWorld-prod, as you can
see in the default conf/busser.json file. So, the regular expression here allows any
alphanumeric characters with numbers, dashes, or underscores.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">appTargetsValidator = </span><span class="sr">/^([A-Za-z0-9_\s\-])+(,[A-Za-z0-9_\s\-]+)*$/</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>See the user input-handling method, <em>parseActionsArgument</em>, for design of this regular
expression, which allows any combination of the action verbs build, save, and run, in
any order, and even jambed-up, as buildsave or buildsaverun.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">actionsValidator = </span><span class="sr">/^([\s*\&lt;build\&gt;*\s*]*[\s*\&lt;save\&gt;*\s*]*[\s*\&lt;run\&gt;*\s*]*)+(,[\s*\&lt;build\&gt;*\s*]*[\s*\&lt;save\&gt;*\s*]*[\s*\&lt;run\&gt;*\s*]*)*$/</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The <em>appTargets</em> input, having passed the validator above, is split
on comma, then the items are trimmed. Commas don't have to be present.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">parseAppTargetsArgument = </span><span class="nf">(appTargetsResult) -&gt;</span>
  <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="k">for</span> <span class="nx">target</span> <span class="k">in</span> <span class="nx">appTargetsResult</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Match for presence of build, save, run words and construct one of several
possible actionItems.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">parseActionsArgument = </span><span class="nf">(actionsResult) -&gt;</span>
  <span class="nv">actionsResult = </span><span class="nx">actionsResult</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>

  <span class="nv">actions = </span><span class="p">[]</span>
  <span class="nx">actions</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39;build&#39;</span> <span class="k">if</span> <span class="nx">actionsResult</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nx">actions</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39;save&#39;</span> <span class="k">if</span> <span class="nx">actionsResult</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
  <span class="nx">actions</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39;run&#39;</span> <span class="k">if</span> <span class="nx">actionsResult</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
       </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The possible combinations for actions are these four compound actionItems, 
as used internally. As noted above, the user has the freedom to type build,
save, run in any manner, as csv input, as blank-delimited, or as a compound
word with no blanks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">actionItems = </span><span class="s1">&#39;build&#39;</span>        <span class="k">if</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="s1">&#39;build&#39;</span> <span class="k">in</span> <span class="nx">actions</span>
  <span class="nv">actionItems = </span><span class="s2">&quot;buildsave&quot;</span>    <span class="k">if</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">2</span> <span class="o">and</span> <span class="s1">&#39;build&#39;</span> <span class="k">in</span> <span class="nx">actions</span> <span class="o">and</span> <span class="s1">&#39;save&#39;</span> <span class="k">in</span> <span class="nx">actions</span>
  <span class="nv">actionItems = </span><span class="s2">&quot;buildsave&quot;</span>    <span class="k">if</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="s1">&#39;save&#39;</span> <span class="k">in</span> <span class="nx">actions</span>
  <span class="nv">actionItems = </span><span class="s2">&quot;buildrun&quot;</span>     <span class="k">if</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">2</span> <span class="o">and</span> <span class="s1">&#39;build&#39;</span> <span class="k">in</span> <span class="nx">actions</span> <span class="o">and</span> <span class="s1">&#39;run&#39;</span> <span class="k">in</span> <span class="nx">actions</span>
  <span class="nv">actionItems = </span><span class="s2">&quot;buildrun&quot;</span>     <span class="k">if</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="s1">&#39;run&#39;</span> <span class="k">in</span> <span class="nx">actions</span>
  <span class="nv">actionItems = </span><span class="s2">&quot;buildsaverun&quot;</span> <span class="k">if</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">3</span> <span class="o">and</span> <span class="s1">&#39;build&#39;</span> <span class="k">in</span> <span class="nx">actions</span> <span class="o">and</span> <span class="s1">&#39;save&#39;</span> <span class="k">in</span> <span class="nx">actions</span> <span class="o">and</span> <span class="s1">&#39;run&#39;</span> <span class="k">in</span> <span class="nx">actions</span>

  <span class="nx">actionItems</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>File Extension and Type Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Use the node.js path module to pull the file extension from the path.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">extname = </span><span class="nf">(path) -&gt;</span>
  <span class="nx">path_module</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The <em>fileType</em> function is used to identify paths by their file extension.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fileType = </span><span class="nf">(path) -&gt;</span>
  <span class="nv">ext = </span><span class="nx">extname</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="k">return</span> <span class="s2">&quot;stylesheet&quot;</span> <span class="k">if</span> <span class="sr">/^\.(css|less)$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">ext</span>
  <span class="k">return</span> <span class="s2">&quot;script&quot;</span>     <span class="k">if</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">is</span> <span class="s2">&quot;.js&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">is</span> <span class="s2">&quot;.handlebars&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="sr">/tests\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="k">return</span> <span class="s2">&quot;test&quot;</span>       <span class="k">if</span> <span class="nx">ext</span> <span class="o">is</span> <span class="s2">&quot;.js&quot;</span> <span class="o">and</span> <span class="sr">/tests\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="k">return</span> <span class="s2">&quot;resource&quot;</span>   <span class="k">if</span> <span class="nx">ext</span> <span class="k">in</span> <span class="nx">ResourceFile</span><span class="p">.</span><span class="nx">resourceExtensions</span>
  <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><em>isStylesheet</em> and the others in this set of functions are for shorthand reference.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">isStylesheet = </span><span class="nf">(file) -&gt;</span> <span class="nx">fileType</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;stylesheet&quot;</span>
<span class="nv">isScript = </span>    <span class="nf">(file) -&gt;</span> <span class="nx">fileType</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;script&quot;</span>
<span class="nv">isTest = </span>      <span class="nf">(file) -&gt;</span> <span class="nx">fileType</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;test&quot;</span>
<span class="nv">isResource = </span>  <span class="nf">(file) -&gt;</span> <span class="nx">fileType</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;resource&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><em>fileClassType</em> is a utility function for use on the <strong>File</strong> class and its
derivatives.</p>

<p><em>fileClassType</em> uses instanceof, which would be true for superclasses, as
well as the actual class, so put subclasses before superclasses in the checks.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fileClassType = </span><span class="nf">(file) -&gt;</span>
  <span class="k">return</span> <span class="s2">&quot;VirtualStylesheetFile&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">VirtualStylesheetFile</span>
  <span class="k">return</span> <span class="s2">&quot;StylesheetFile&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">StylesheetFile</span>
  <span class="k">return</span> <span class="s2">&quot;VirtualScriptFile&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">VirtualScriptFile</span>
  <span class="k">return</span> <span class="s2">&quot;ScriptFile&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">ScriptFile</span>
  <span class="k">return</span> <span class="s2">&quot;ResourceFile&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">ResourceFile</span>
  <span class="k">return</span> <span class="s2">&quot;TestFile&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">TestFile</span>
  <span class="k">return</span> <span class="s2">&quot;RootContentHtmlFile&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">RootContentHtmlFile</span>
  <span class="k">return</span> <span class="s2">&quot;BootstrapVirtualScriptFile&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">BootstrapVirtualScriptFile</span>
  <span class="k">return</span> <span class="s2">&quot;File&quot;</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">instanceof</span> <span class="nx">File</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>Language Handling</h2>

<p><em>defaultLanguage</em> and <em>buildLanguage</em> are set as globals for now, but should
be handled in general busser.conf. [TODO]</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">defaultLanguage = </span><span class="s2">&quot;english&quot;</span>
<span class="nv">buildLanguage = </span><span class="s2">&quot;english&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><em>buildLanguageAbbreviations</em> is a global hash, where keys are language names
and values are abbreviations.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">buildLanguageAbbreviations =</span>
  <span class="nv">english: </span> <span class="s2">&quot;en&quot;</span>
  <span class="nv">french: </span>  <span class="s2">&quot;fr&quot;</span>
  <span class="nv">german: </span>  <span class="s2">&quot;de&quot;</span>
  <span class="nv">japanese: </span><span class="s2">&quot;ja&quot;</span>
  <span class="nv">spanish: </span> <span class="s2">&quot;es&quot;</span>
  <span class="nv">italian: </span> <span class="s2">&quot;it&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><em>buildLanguageAbbreviation</em> is a utility function for returning the abbreviation
matching the buildLanguage given in the configuration.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">buildLanguageAbbreviation = </span><span class="nf">(buildLanguage) -&gt;</span>
  <span class="k">if</span> <span class="nx">buildLanguage</span><span class="o">?</span>
    <span class="nx">buildLanguageAbbreviations</span><span class="p">[</span><span class="nx">buildLanguage</span><span class="p">]</span> <span class="k">if</span> <span class="nx">buildLanguage</span> <span class="k">of</span> <span class="nx">buildLanguageAbbreviations</span>
  <span class="k">else</span>
    <span class="s2">&quot;en&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><em>languageInPath</em> returns null or the language abbreviation in the path, where
the path "apps/myapp/en.lproj/main.js" would evaluate to "en". Use of a language
fullname, e.g., "english.lproj", is also possible.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">languageInPath = </span><span class="nf">(path) -&gt;</span>
  <span class="nv">match = </span><span class="sr">/([a-z]+)\.lproj\//</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">match</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h2>File Reading Queue System</h2>

<p>This section is for the system setting to allow a higher number of open
files during processing. See the mauritslamers versions of garcon for the history
of "upping" the values.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">openedFileDescriptorsCount = </span><span class="mi">0</span>

<span class="nv">maxSimultaneouslyOpenedFileDescriptors = </span><span class="mi">32</span>

<span class="nv">guessMaxSimultaneouslyOpenedFileDescriptors = </span><span class="o">-&gt;</span>
  <span class="nx">exec</span> <span class="s2">&quot;ulimit -n&quot;</span><span class="p">,</span> <span class="nf">(err, stdout, stderr) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">err</span><span class="o">?</span>
      <span class="nv">m = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
      <span class="nv">maxSimultaneouslyOpenedFileDescriptors = </span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="err">/16 &gt;= 4) then m/16 else 4) if m &gt; 0</span>

<span class="nx">guessMaxSimultaneouslyOpenedFileDescriptors</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p><em>queue</em>, <em>dequeue</em>, and <em>readFile</em>, are tied to the system settings for file descriptors 
above. Look at the content method in <strong>File</strong> and derivatives for calls to <em>readFile</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">queue = </span><span class="nf">(method) -&gt;</span>
  <span class="vi">@_queue = </span><span class="p">[]</span>  <span class="nx">unless</span> <span class="nx">@_queue</span>
  <span class="nx">@_queue</span><span class="p">.</span><span class="nx">push</span> <span class="nx">method</span>
  <span class="nx">dequeue</span><span class="p">()</span>

<span class="nv">dequeue = </span><span class="o">-&gt;</span>
  <span class="k">if</span> <span class="nx">@_queue</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">openedFileDescriptorsCount</span> <span class="o">&lt;</span> <span class="nx">maxSimultaneouslyOpenedFileDescriptors</span>
    <span class="nx">openedFileDescriptorsCount</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nv">method = </span><span class="nx">@_queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;readFile&quot;</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">method</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nf">(err, data) -&gt;</span>
        <span class="nx">method</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">data</span>
        <span class="nx">openedFileDescriptorsCount</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="nx">dequeue</span><span class="p">()</span>

<span class="nv">readFile = </span><span class="nf">(path, callback) -&gt;</span>
  <span class="nx">queue</span> <span class="p">[</span> <span class="s2">&quot;readFile&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>Date Handling</h2>

<p>This block of Date Format code is from the martoche version of garcon. The
mauritslamers version of garcon improves date handling.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Date Format 1.2.3
(c) 2007-2009 Steven Levithan <stevenlevithan.com>
MIT license</p>

<p>Includes enhancements by Scott Trenda <scott.trenda.net>
and Kris Kowal <cixar.com/~kris.kowal/></p>

<p>Accepts a date, a mask, or a date and a mask.
Returns a formatted version of the given date.
The date defaults to the current date/time.
The mask defaults to dateFormat.masks.default.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">dateFormat = </span><span class="o">-&gt;</span>
  <span class="nv">token = </span><span class="sr">/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|&quot;[^&quot;]*&quot;|&#39;[^&#39;]*&#39;/g</span>
  <span class="nv">timezone = </span><span class="sr">/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g</span>
  <span class="nv">timezoneClip = </span><span class="sr">/[^-+\dA-Z]/g</span>
  <span class="nv">pad = </span><span class="nf">(val, len) -&gt;</span>
    <span class="nv">val = </span><span class="nb">String</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
    <span class="nv">len = </span><span class="nx">len</span> <span class="o">or</span> <span class="mi">2</span>
    <span class="nv">val = </span><span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">val</span>  <span class="k">while</span> <span class="nx">val</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">len</span>
    <span class="nx">val</span>

  <span class="nf">(date, mask, utc) -&gt;</span>
    <span class="nv">dF = </span><span class="nx">dateFormat</span>
    <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="nb">Object</span><span class="o">::</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;[object String]&quot;</span> <span class="o">and</span> <span class="o">not</span> <span class="sr">/\d/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span>
      <span class="nv">mask = </span><span class="nx">date</span>
      <span class="nv">date = </span><span class="kc">undefined</span>
    <span class="nv">date = </span><span class="p">(</span><span class="k">if</span> <span class="nx">date</span> <span class="k">then</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="k">else</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">())</span>
    <span class="k">throw</span> <span class="nx">SyntaxError</span><span class="p">(</span><span class="s2">&quot;invalid date&quot;</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span>
    <span class="nv">mask = </span><span class="nb">String</span><span class="p">(</span><span class="nx">dF</span><span class="p">.</span><span class="nx">masks</span><span class="p">[</span><span class="nx">mask</span><span class="p">]</span> <span class="o">or</span> <span class="nx">mask</span> <span class="o">or</span> <span class="nx">dF</span><span class="p">.</span><span class="nx">masks</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nx">mask</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;UTC:&quot;</span>
      <span class="nv">mask = </span><span class="nx">mask</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
      <span class="nv">utc = </span><span class="kc">true</span>
    <span class="nv">_ = </span><span class="p">(</span><span class="k">if</span> <span class="nx">utc</span> <span class="k">then</span> <span class="s2">&quot;getUTC&quot;</span> <span class="k">else</span> <span class="s2">&quot;get&quot;</span><span class="p">)</span>
    <span class="nv">d = </span><span class="nx">date</span><span class="p">[</span><span class="nx">_</span> <span class="o">+</span> <span class="s2">&quot;Date&quot;</span><span class="p">]()</span>
    <span class="nv">D = </span><span class="nx">date</span><span class="p">[</span><span class="nx">_</span> <span class="o">+</span> <span class="s2">&quot;Day&quot;</span><span class="p">]()</span>
    <span class="nv">m = </span><span class="nx">date</span><span class="p">[</span><span class="nx">_</span> <span class="o">+</span> <span class="s2">&quot;Month&quot;</span><span class="p">]()</span>
    <span class="nv">y = </span><span class="nx">date</span><span class="p">[</span><span class="nx">_</span> <span class="o">+</span> <span class="s2">&quot;FullYear&quot;</span><span class="p">]()</span>
    <span class="nv">H = </span><span class="nx">date</span><span class="p">[</span><span class="nx">_</span> <span class="o">+</span> <span class="s2">&quot;Hours&quot;</span><span class="p">]()</span>
    <span class="nv">M = </span><span class="nx">date</span><span class="p">[</span><span class="nx">_</span> <span class="o">+</span> <span class="s2">&quot;Minutes&quot;</span><span class="p">]()</span>
    <span class="nv">s = </span><span class="nx">date</span><span class="p">[</span><span class="nx">_</span> <span class="o">+</span> <span class="s2">&quot;Seconds&quot;</span><span class="p">]()</span>
    <span class="nv">L = </span><span class="nx">date</span><span class="p">[</span><span class="nx">_</span> <span class="o">+</span> <span class="s2">&quot;Milliseconds&quot;</span><span class="p">]()</span>
    <span class="nv">o = </span><span class="p">(</span><span class="k">if</span> <span class="nx">utc</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">())</span>
    <span class="nv">flags =</span>
      <span class="nv">d: </span><span class="nx">d</span>
      <span class="nv">dd: </span><span class="nx">pad</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
      <span class="nv">ddd: </span><span class="nx">dF</span><span class="p">.</span><span class="nx">i18n</span><span class="p">.</span><span class="nx">dayNames</span><span class="p">[</span><span class="nx">D</span><span class="p">]</span>
      <span class="nv">dddd: </span><span class="nx">dF</span><span class="p">.</span><span class="nx">i18n</span><span class="p">.</span><span class="nx">dayNames</span><span class="p">[</span><span class="nx">D</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span>
      <span class="nv">m: </span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="nv">mm: </span><span class="nx">pad</span><span class="p">(</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="nv">mmm: </span><span class="nx">dF</span><span class="p">.</span><span class="nx">i18n</span><span class="p">.</span><span class="nx">monthNames</span><span class="p">[</span><span class="nx">m</span><span class="p">]</span>
      <span class="nv">mmmm: </span><span class="nx">dF</span><span class="p">.</span><span class="nx">i18n</span><span class="p">.</span><span class="nx">monthNames</span><span class="p">[</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]</span>
      <span class="nv">yy: </span><span class="nb">String</span><span class="p">(</span><span class="nx">y</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="nv">yyyy: </span><span class="nx">y</span>
      <span class="nv">h: </span><span class="nx">H</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">or</span> <span class="mi">12</span>
      <span class="nv">hh: </span><span class="nx">pad</span><span class="p">(</span><span class="nx">H</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">or</span> <span class="mi">12</span><span class="p">)</span>
      <span class="nv">H: </span><span class="nx">H</span>
      <span class="nv">HH: </span><span class="nx">pad</span><span class="p">(</span><span class="nx">H</span><span class="p">)</span>
      <span class="nv">M: </span><span class="nx">M</span>
      <span class="nv">MM: </span><span class="nx">pad</span><span class="p">(</span><span class="nx">M</span><span class="p">)</span>
      <span class="nv">s: </span><span class="nx">s</span>
      <span class="nv">ss: </span><span class="nx">pad</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
      <span class="nv">l: </span><span class="nx">pad</span><span class="p">(</span><span class="nx">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
      <span class="nv">L: </span><span class="nx">pad</span><span class="p">((</span><span class="k">if</span> <span class="nx">L</span> <span class="o">&gt;</span> <span class="mi">99</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">L</span> <span class="err">/ 10) else L))</span>
      <span class="nv">t: </span><span class="p">(</span><span class="k">if</span> <span class="nx">H</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="k">then</span> <span class="s2">&quot;a&quot;</span> <span class="k">else</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span>
      <span class="nv">tt: </span><span class="p">(</span><span class="k">if</span> <span class="nx">H</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="k">then</span> <span class="s2">&quot;am&quot;</span> <span class="k">else</span> <span class="s2">&quot;pm&quot;</span><span class="p">)</span>
      <span class="nv">T: </span><span class="p">(</span><span class="k">if</span> <span class="nx">H</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="k">then</span> <span class="s2">&quot;A&quot;</span> <span class="k">else</span> <span class="s2">&quot;P&quot;</span><span class="p">)</span>
      <span class="nv">TT: </span><span class="p">(</span><span class="k">if</span> <span class="nx">H</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="k">then</span> <span class="s2">&quot;AM&quot;</span> <span class="k">else</span> <span class="s2">&quot;PM&quot;</span><span class="p">)</span>
      <span class="nv">Z: </span><span class="p">(</span><span class="k">if</span> <span class="nx">utc</span> <span class="k">then</span> <span class="s2">&quot;UTC&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="nx">timezone</span><span class="p">)</span> <span class="o">or</span> <span class="p">[</span> <span class="s2">&quot;&quot;</span> <span class="p">]).</span><span class="nx">pop</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="nx">timezoneClip</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
      <span class="nv">o: </span><span class="p">(</span><span class="k">if</span> <span class="nx">o</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="s2">&quot;-&quot;</span> <span class="k">else</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">pad</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
      <span class="nv">S: </span><span class="p">[</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;st&quot;</span><span class="p">,</span> <span class="s2">&quot;nd&quot;</span><span class="p">,</span> <span class="s2">&quot;rd&quot;</span> <span class="p">][(</span><span class="k">if</span> <span class="nx">d</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="nx">d</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">-</span> <span class="nx">d</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">isnt</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="nx">d</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)]</span>

    <span class="nx">mask</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">token</span><span class="p">,</span> <span class="nf">($0) -&gt;</span>
      <span class="p">(</span><span class="k">if</span> <span class="nx">$0</span> <span class="k">of</span> <span class="nx">flags</span> <span class="k">then</span> <span class="nx">flags</span><span class="p">[</span><span class="nx">$0</span><span class="p">]</span> <span class="k">else</span> <span class="nx">$0</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">$0</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

<span class="nx">dateFormat</span><span class="p">()</span>

<span class="nv">dateFormat.masks =</span>
  <span class="nv">default: </span><span class="s2">&quot;ddd mmm dd yyyy HH:MM:ss&quot;</span>
  <span class="nv">shortDate: </span><span class="s2">&quot;m/d/yy&quot;</span>
  <span class="nv">mediumDate: </span><span class="s2">&quot;mmm d, yyyy&quot;</span>
  <span class="nv">longDate: </span><span class="s2">&quot;mmmm d, yyyy&quot;</span>
  <span class="nv">fullDate: </span><span class="s2">&quot;dddd, mmmm d, yyyy&quot;</span>
  <span class="nv">shortTime: </span><span class="s2">&quot;h:MM TT&quot;</span>
  <span class="nv">mediumTime: </span><span class="s2">&quot;h:MM:ss TT&quot;</span>
  <span class="nv">longTime: </span><span class="s2">&quot;h:MM:ss TT Z&quot;</span>
  <span class="nv">isoDate: </span><span class="s2">&quot;yyyy-mm-dd&quot;</span>
  <span class="nv">isoTime: </span><span class="s2">&quot;HH:MM:ss&quot;</span>
  <span class="nv">isoDateTime: </span><span class="s2">&quot;yyyy-mm-dd&#39;T&#39;HH:MM:ss&quot;</span>
  <span class="nv">isoUtcDateTime: </span><span class="s2">&quot;UTC:yyyy-mm-dd&#39;T&#39;HH:MM:ss&#39;Z&#39;&quot;</span>
  <span class="nv">httpDateTime: </span><span class="s2">&quot;ddd, d mmm yyyy HH:MM:ss o&quot;</span>

<span class="nv">dateFormat.i18n =</span>
  <span class="nv">dayNames: </span><span class="p">[</span> <span class="s2">&quot;Sun&quot;</span><span class="p">,</span> <span class="s2">&quot;Mon&quot;</span><span class="p">,</span> <span class="s2">&quot;Tue&quot;</span><span class="p">,</span> <span class="s2">&quot;Wed&quot;</span><span class="p">,</span> <span class="s2">&quot;Thu&quot;</span><span class="p">,</span> <span class="s2">&quot;Fri&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sunday&quot;</span><span class="p">,</span> <span class="s2">&quot;Monday&quot;</span><span class="p">,</span> <span class="s2">&quot;Tuesday&quot;</span><span class="p">,</span> <span class="s2">&quot;Wednesday&quot;</span><span class="p">,</span> <span class="s2">&quot;Thursday&quot;</span><span class="p">,</span> <span class="s2">&quot;Friday&quot;</span><span class="p">,</span> <span class="s2">&quot;Saturday&quot;</span> <span class="p">]</span>
  <span class="nv">monthNames: </span><span class="p">[</span> <span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="s2">&quot;Feb&quot;</span><span class="p">,</span> <span class="s2">&quot;Mar&quot;</span><span class="p">,</span> <span class="s2">&quot;Apr&quot;</span><span class="p">,</span> <span class="s2">&quot;May&quot;</span><span class="p">,</span> <span class="s2">&quot;Jun&quot;</span><span class="p">,</span> <span class="s2">&quot;Jul&quot;</span><span class="p">,</span> <span class="s2">&quot;Aug&quot;</span><span class="p">,</span> <span class="s2">&quot;Sep&quot;</span><span class="p">,</span> <span class="s2">&quot;Oct&quot;</span><span class="p">,</span> <span class="s2">&quot;Nov&quot;</span><span class="p">,</span> <span class="s2">&quot;Dec&quot;</span><span class="p">,</span> <span class="s2">&quot;January&quot;</span><span class="p">,</span> <span class="s2">&quot;February&quot;</span><span class="p">,</span> <span class="s2">&quot;March&quot;</span><span class="p">,</span> <span class="s2">&quot;April&quot;</span><span class="p">,</span> <span class="s2">&quot;May&quot;</span><span class="p">,</span> <span class="s2">&quot;June&quot;</span><span class="p">,</span> <span class="s2">&quot;July&quot;</span><span class="p">,</span> <span class="s2">&quot;August&quot;</span><span class="p">,</span> <span class="s2">&quot;September&quot;</span><span class="p">,</span> <span class="s2">&quot;October&quot;</span><span class="p">,</span> <span class="s2">&quot;November&quot;</span><span class="p">,</span> <span class="s2">&quot;December&quot;</span> <span class="p">]</span>

<span class="nb">Date</span><span class="o">::</span><span class="nv">format = </span><span class="nf">(mask, utc) -&gt;</span>
  <span class="nx">dateFormat</span> <span class="k">this</span><span class="p">,</span> <span class="nx">mask</span><span class="p">,</span> <span class="nx">utc</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>String Substitution</h2>

<p><em>gsub</em>, from Ruby, is added to the prototyp of String here. See:
http://flochip.com/2011/09/06/rubys-string-gsub-in-javascript/</p>

<p>[TODO] Is there another web reference needed for this? </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">String</span><span class="o">::</span><span class="nv">gsub = </span><span class="nf">(re, callback) -&gt;</span>
  <span class="nv">result = </span><span class="s2">&quot;&quot;</span>
  <span class="nv">source = </span><span class="k">this</span>
  <span class="k">while</span> <span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nv">match = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span>
      <span class="nv">source = </span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">source</span>
      <span class="nv">source = </span><span class="s2">&quot;&quot;</span>
  <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h1>File Handler System</h1>

<h2>Handler</h2>

<p>Synopsis: </p>

<p>A <strong>Handler</strong> handles some type of file or content processing, for reading file
  content, for minifying, for text replacement, etc.</p>

<p>Constructor:</p>

<p>Parameters:</p>

<pre><code>@name -- the name of the one of the properties in the Busser class for handlers,
         e.g., ifModifiedSince, contentType, minify, join.

@exec -- the method to do the work, perhaps involving other functions or classes.

@next -- a link to the next handler.
</code></pre>

<p><strong>Handler</strong> exec functions are held in the <strong>Busser</strong> class. <strong>HandlerSet</strong> instances are 
  created by calls to <strong>Busser</strong>, with a subset of available handlers.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Handler</span>
  <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
    <span class="vi">@name = </span><span class="s2">&quot;&quot;</span>
    <span class="vi">@next = </span><span class="kc">null</span>
    <span class="vi">@exec = </span><span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span>

    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h2>HandlerSet</h2>

<p>Synopsis: </p>

<p><strong>HandlerSet</strong> is a container for handlers which work on files and content in a 
  SproutCore project to build an system for development or deployment. A <strong>HandlerSet</strong>
  consists of a linked-list of handlers built from the available set. A <strong>HandlerSet</strong>
  instance is fired with exec(). A HandlerSet contains one or more handlers.</p>

<p>Constructor:</p>

<p>Parameters:</p>

<pre><code>@name -- for reference in labeling each HandlerSet singleton instance, e.g.
         stylesheetHandlerSet or joinHandlerSet.

@urlPrefix -- to be prepended to resulting paths.
</code></pre>

<p>Each <strong>Handler</strong> instance has exec and next, which are called during traversal
  from a HandlerSet exec call.</p>

<p>The exec() method fires on the head handler, beginning an "async waterfall,"
  wherein the sequence of handlers is called in succession, each one passing along
  a callback function. When the final "tail" handler executes, there is a return 
  through callbacks back up to the head handler. In the end, the handler has 
  performed one or more operations, finally returning the data via the head callback.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">HandlerSet</span>
  <span class="nv">constructor: </span><span class="nf">(@name, @urlPrefix=&quot;/&quot;) -&gt;</span>
    <span class="vi">@handlers  = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p><em>head</em> returns the first handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">head: </span><span class="o">-&gt;</span>
    <span class="nx">@handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@handlers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><em>exec</em> fires on the head handler. The file and callback parameters are always used;
request is used during server operations for passing a modification time.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
    <span class="nv">headHandler = </span><span class="nx">@head</span><span class="p">()</span>
    <span class="nx">headHandler</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>Busser</h2>

<p>The <strong>Busser</strong> class is the workhorse for the build system. It contains the
code for available handlers and related utility functions. The handlerSet
method is used to create <strong>HandlerSet</strong> instances with a subset of available
handlers, instantiated and returned as a singly-linked-list.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Busser</span>
  <span class="nx">constructor</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>The handlerSet method returns a HandlerSet instance that contains a linked-list
of Handler objects, instantiated and ready for processing.</p>

<p>Parameters:</p>

<p>name -- handlerSet instance label.</p>

<p>urlPrefix -- default is "/"... [TODO] should be customizable for apps? 
                                         Also, check when this should be used...</p>

<p>handlerNames -- an array of handler names from the list of those available.
                   These are the names of handlers, keys to properties of the Busser
                   class.</p>

<p>A new <strong>HandlerSet</strong> instance is created with the name and urlPrefix. Then
a list of handlers is created from handlerNames, setting handlerSet.handlers, the
linked-list of handlers. All but the last handler have their next property set.
The @[handlerName].exec reference, seen in Handler creation calls, is a lookup to the
given handler property definition in the Busser class. If you examine, for example,
the ifModifiedSince property in the Busser class, you will see an exec function,
which is given a parameter in creating a new Handler instance of that type.</p>

<p>The completed <strong>HandlerSet</strong> instance, with linked-list of handlers, is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handlerSet: </span><span class="nf">(name, urlPrefix, handlerNames) -&gt;</span>
    <span class="nx">urlPrefix</span> <span class="o">?=</span> <span class="s2">&quot;/&quot;</span>

    <span class="nv">handlerSet = </span><span class="k">new</span> <span class="nx">HandlerSet</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">urlPrefix</span>

    <span class="k">for</span> <span class="nx">handlerName</span> <span class="k">in</span> <span class="nx">handlerNames</span>
      <span class="nx">handlerSet</span><span class="p">.</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Handler</span>
        <span class="nv">name: </span><span class="nx">handlerName</span>
        <span class="nv">next: </span><span class="kc">null</span>
        <span class="nv">exec: </span><span class="err">@</span><span class="p">[</span><span class="nx">handlerName</span><span class="p">].</span><span class="nx">exec</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Set handler.next for all but the last handler, which will have the default next = null.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">handler.next = </span><span class="nx">handlerSet</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="k">for</span> <span class="nx">handler</span><span class="p">,</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">handlerSet</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">handlerSet</span><span class="p">.</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nx">handlerSet</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><em>mtimeScanner</em> is a static utility function that takes a list of files,
scans each file for modification time, finding the max (most recent),
then calls the callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@mtimeScanner: </span><span class="nf">(files, callback) -&gt;</span>
    <span class="nv">mtime = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>The <strong>Scanner</strong> class scans files for modification time, keeping a
maxMtime value that is returned upon completion of the scan.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">Scanner</span> <span class="k">extends</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span>
      <span class="nv">constructor: </span><span class="nf">(@files=[]) -&gt;</span>
        <span class="vi">@count = </span><span class="nx">@files</span><span class="p">.</span><span class="nx">length</span>
        <span class="vi">@maxMtime = </span><span class="mi">0</span>

      <span class="nv">scan: </span><span class="o">-&gt;</span>
        <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@files</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
              <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;WARNING: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span>
            <span class="k">else</span>
              <span class="vi">@maxMtime = </span><span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span>  <span class="k">if</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span> <span class="o">&gt;</span> <span class="nx">@maxMtime</span>
            <span class="nx">@count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="nx">@emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">@maxMtime</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@count</span> <span class="o">&lt;=</span> <span class="mi">0</span>
        <span class="nx">@emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nx">@maxMtime</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@count</span> <span class="o">&lt;=</span> <span class="mi">0</span>
  
    <span class="nv">scanner = </span><span class="k">new</span> <span class="nx">Scanner</span><span class="p">(</span><span class="nx">files</span><span class="p">)</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nf">(mtime) -&gt;</span>
      <span class="nx">callback</span> <span class="nx">mtime</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The <em>ifModifiedSince</em> handler checks if a file's children have been modified since
a time given in the request argument. If no request is passed, then control
passes on, without checking, to the next handler, if there is one.</p>

<p>This handler can be used at the head of a handler set as a gatekeeper to processs
only those files that have been modified.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ifModifiedSince:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="nv">files = </span><span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">children</span><span class="o">?</span> <span class="k">then</span> <span class="nx">file</span><span class="p">.</span><span class="nx">children</span> <span class="k">else</span> <span class="p">[</span> <span class="nx">file</span> <span class="p">]</span>

      <span class="k">if</span> <span class="o">not</span> <span class="nx">request</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;if-modified-since&quot;</span><span class="p">]</span><span class="o">?</span>
        <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
          <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
            <span class="nx">callback</span> <span class="nx">response</span>
        <span class="k">else</span>
          <span class="nx">callback</span> <span class="nv">status: </span><span class="mi">304</span>
      <span class="k">else</span>
        <span class="nx">Busser</span><span class="p">.</span><span class="nx">mtimeScanner</span> <span class="nx">files</span><span class="p">,</span> <span class="nf">(mtime) -&gt;</span>
          <span class="k">if</span> <span class="nx">mtime</span> <span class="o">&gt;</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;if-modified-since&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
              <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
                <span class="nv">response.lastModified = </span><span class="p">(</span><span class="k">if</span> <span class="nx">mtime</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="kc">undefined</span> <span class="k">else</span> <span class="nx">mtime</span><span class="p">)</span>
                <span class="nx">callback</span> <span class="nx">response</span>
            <span class="k">else</span>
              <span class="nx">callback</span> <span class="nv">status: </span><span class="mi">304</span>
          <span class="k">else</span>
            <span class="nx">callback</span> <span class="nv">status: </span><span class="mi">304</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>The <em>cache</em> handler creates a cache if it doesn't exist. The first time
control passes through here for a given file, the downstream response for
the file is cached. Subsequent calls for the file will get the cached value.</p>

<p>The <em>cache</em> handler can be used at the head of a handler set to avoid unneeded
processing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cache:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="nx">@cache</span> <span class="o">?=</span> <span class="p">{}</span>

      <span class="k">if</span> <span class="o">not</span> <span class="nx">@cache</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
        <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
          <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@cache</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span>
            <span class="nx">callback</span> <span class="nx">response</span>
        <span class="k">else</span>
          <span class="nx">@cache</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>   <span class="c1"># Or &quot;&quot;? [TODO]</span>
          <span class="nx">callback</span> <span class="nx">@cache</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nx">callback</span> <span class="nx">@cache</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>The <em>contentType</em> handler adds the content type of the file to the response for
the handler set.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">contentType:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="nv">contentTypes =</span>
        <span class="s2">&quot;.js&quot;</span><span class="o">:</span> <span class="s2">&quot;text/javascript; charset=utf-8&quot;</span>
        <span class="s2">&quot;.css&quot;</span><span class="o">:</span> <span class="s2">&quot;text/css; charset=utf-8&quot;</span>
        <span class="s2">&quot;.png&quot;</span><span class="o">:</span> <span class="s2">&quot;image/png&quot;</span>
        <span class="s2">&quot;.jpg&quot;</span><span class="o">:</span> <span class="s2">&quot;image/jpeg&quot;</span>
        <span class="s2">&quot;.gif&quot;</span><span class="o">:</span> <span class="s2">&quot;image/gif&quot;</span>
        <span class="s2">&quot;.json&quot;</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span>
        <span class="s2">&quot;.svg&quot;</span><span class="o">:</span> <span class="s2">&quot;image/svg+xml&quot;</span>
    
      <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
        <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="nv">response.contentType = </span><span class="nx">contentTypes</span><span class="p">[</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)]</span>
          <span class="nx">callback</span> <span class="nx">response</span>
      <span class="k">else</span>
        <span class="nx">callback</span> <span class="nv">contentType: </span><span class="nx">contentTypes</span><span class="p">[</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p><em>minifyStylesheet</em> is a static utility method that uses yuicompressor
to minify data. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@minifyStylesheet: </span><span class="nf">(dataToMinify, callback) -&gt;</span>
    <span class="k">class</span> <span class="nx">Minifier</span> <span class="k">extends</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span>
      <span class="nv">constructor: </span><span class="nf">(@incomingData) -&gt;</span>
        <span class="vi">@minifiedData = </span><span class="s1">&#39;&#39;</span>

      <span class="nv">minify: </span><span class="o">-&gt;</span>
        <span class="nv">min = </span><span class="nx">spawn</span><span class="p">(</span><span class="s2">&quot;java&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;-jar&quot;</span><span class="p">,</span> <span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;yuicompressor-2.4.7.jar&quot;</span><span class="p">),</span> <span class="s2">&quot;--type&quot;</span><span class="p">,</span> <span class="s2">&quot;css&quot;</span> <span class="p">])</span>
        <span class="nx">min</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">newData</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@minifiedData</span> <span class="o">+=</span> <span class="nx">newData</span>
        <span class="nx">min</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
          <span class="nx">util</span><span class="p">.</span><span class="nx">print</span> <span class="nx">data</span>
        <span class="nx">min</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;ERROR: Minifier exited with code #{code}&quot;</span> <span class="k">if</span> <span class="nx">code</span> <span class="o">isnt</span> <span class="mi">0</span>
          <span class="nx">@emit</span> <span class="s1">&#39;end&#39;</span>
        <span class="nx">min</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">write</span> <span class="nx">@incomingData</span>
        <span class="nx">min</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

    <span class="nv">minifier = </span><span class="k">new</span> <span class="nx">Minifier</span><span class="p">(</span><span class="nx">dataToMinify</span><span class="p">)</span>
    <span class="nx">minifier</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">callback</span> <span class="nx">minifier</span><span class="p">.</span><span class="nx">minifiedData</span>
    <span class="nx">minifier</span><span class="p">.</span><span class="nx">minify</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p><em>minifyScript</em> is a static utility method that uses uglify to minify data. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@minifyScript: </span><span class="nf">(dataToMinify, callback) -&gt;</span>
    <span class="k">class</span> <span class="nx">Minifier</span> <span class="k">extends</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span>
      <span class="nv">constructor: </span><span class="nf">(@incomingData) -&gt;</span>
        <span class="vi">@minifiedData = </span><span class="s1">&#39;&#39;</span>

      <span class="nv">minify: </span><span class="o">-&gt;</span>
        <span class="nv">ast = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">@incomingData</span><span class="p">)</span>
        <span class="nv">ast = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">ast_mangle</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
        <span class="nv">ast = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">ast_squeeze</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
        <span class="vi">@minifiedData = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">gen_code</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span>
        <span class="nx">@emit</span> <span class="s1">&#39;end&#39;</span>

    <span class="nv">minifier = </span><span class="k">new</span> <span class="nx">Minifier</span><span class="p">(</span><span class="nx">dataToMinify</span><span class="p">)</span>
    <span class="nx">minifier</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">callback</span> <span class="nx">minifier</span><span class="p">.</span><span class="nx">minifiedData</span>
    <span class="nx">minifier</span><span class="p">.</span><span class="nx">minify</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>The <em>minify</em> handler minifies the downstream response for stylesheets and scripts. 
Stylesheets are minified with yuicompressor. Scripts are minified with uglify.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">minify:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
        <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="k">if</span> <span class="nx">isStylesheet</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
            <span class="nx">Busser</span><span class="p">.</span><span class="nx">minifyStylesheet</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(minifiedData) -&gt;</span>
              <span class="nv">response.data = </span><span class="nx">minifiedData</span>
              <span class="nx">callback</span> <span class="nx">response</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">isScript</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
            <span class="nx">Busser</span><span class="p">.</span><span class="nx">minifyScript</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(minifiedData) -&gt;</span>
              <span class="nv">response.data = </span><span class="nx">minifiedData</span>
              <span class="nx">callback</span> <span class="nx">response</span>
      <span class="k">else</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="k">throw</span> <span class="nx">err</span>
          <span class="k">else</span>
            <span class="nx">Busser</span><span class="p">.</span><span class="nx">minifyScript</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(minifiedData) -&gt;</span>
              <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">minifiedData</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>The <em>rewriteSuper</em> handler replaces instances of sc_super in SproutCore javascript
with the magic equivalent: arguments.callee.base.apply(this,arguments).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rewriteSuper:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
        <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="k">if</span> <span class="sr">/sc_super\(\s*[^\)\s]+\s*\)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;ERROR in #{file.path}: sc_super() should not be called with arguments. Modify the arguments array instead.&quot;</span>
          <span class="nv">response.data = </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/sc_super\(\)/g</span><span class="p">,</span> <span class="s2">&quot;arguments.callee.base.apply(this,arguments)&quot;</span><span class="p">)</span>
          <span class="nx">callback</span> <span class="nx">response</span>
      <span class="k">else</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="k">throw</span> <span class="nx">err</span>
          <span class="k">else</span>
            <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/sc_super\(\)/g</span><span class="p">,</span> <span class="s2">&quot;arguments.callee.base.apply(this,arguments)&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p><em>rewriteStatic</em> is a static utility method, pardon the pun, that replaces sc<em>static or
static</em>url, and their file references, with references to files in the resources 
directory, per the format argument.</p>

<p>A warning is given if the file in the reference is not found. The reference is tested
against the path of the containing framework.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@rewriteStatic: </span><span class="nf">(format, file, data) -&gt;</span>
    <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;(sc_static|static_url)\\(\\s*[&#39;\&quot;](resources/){0,1}(.+?)[&#39;\&quot;]\\s*\\)&quot;</span><span class="p">)</span>
    <span class="nv">dirname = </span><span class="nx">file</span><span class="p">.</span><span class="nx">framework</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">data</span><span class="o">?</span>
      <span class="nv">resourceUrls = </span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">framework</span><span class="p">.</span><span class="nx">resourceFiles</span><span class="p">)</span>
      <span class="nv">data = </span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nx">gsub</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(match) -&gt;</span>
        <span class="nv">path = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">if</span> <span class="nx">path</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">resourceUrls</span>
          <span class="k">for</span> <span class="nx">prefix</span> <span class="k">in</span> <span class="p">[</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span> <span class="p">]</span>
            <span class="k">for</span> <span class="nx">extname</span> <span class="k">in</span> <span class="nx">ResourceFile</span><span class="p">.</span><span class="nx">resourceExtensions</span>
              <span class="nv">alternatePath = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">dirname</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="nx">extname</span><span class="p">)</span>
              <span class="k">if</span> <span class="nx">alternatePath</span> <span class="k">in</span> <span class="nx">resourceUrls</span>
                <span class="nv">path = </span><span class="nx">alternatePath</span>
                <span class="k">break</span>
    
          <span class="nx">unless</span> <span class="nx">path</span> <span class="k">in</span> <span class="nx">resourceUrls</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;WARNING: #{path} referenced in #{file.path} but was not found.&quot;</span>
        <span class="nx">format</span><span class="p">.</span><span class="nx">replace</span> <span class="s2">&quot;%@&quot;</span><span class="p">,</span> <span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@urlPrefix</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>The <em>rewriteStaticInStylesheet</em> handler calls the <em>rewriteStatic</em> method with the
format url('%@') for url references in stylesheets.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rewriteStaticInStylesheet:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
        <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="nv">response.data = </span><span class="nx">Busser</span><span class="p">.</span><span class="nx">rewriteStatic</span> <span class="s2">&quot;url(&#39;%@&#39;)&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
          <span class="nx">callback</span> <span class="nx">response</span>
      <span class="k">else</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="k">throw</span> <span class="nx">err</span>
          <span class="k">else</span>
            <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">Busser</span><span class="p">.</span><span class="nx">rewriteStatic</span> <span class="s2">&quot;url(&#39;%@&#39;)&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>The <em>rewriteStaticInScript</em> handler calls the <em>rewriteStatic</em> method with the
format '%@' for references in javascript.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rewriteStaticInScript:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
        <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="nv">response.data = </span><span class="nx">Busser</span><span class="p">.</span><span class="nx">rewriteStatic</span> <span class="s2">&quot;&#39;%@&#39;&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
          <span class="nx">callback</span> <span class="nx">response</span>
      <span class="k">else</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="k">throw</span> <span class="nx">err</span>
          <span class="k">else</span>
            <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">Busser</span><span class="p">.</span><span class="nx">rewriteStatic</span> <span class="s2">&quot;&#39;%@&#39;&quot;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>The <em>rewriteFile</em> handler replaces instances of direct file references, which
are found via <strong>FILE</strong>, with the file url.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rewriteFile:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
        <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="nv">response.data = </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/__FILE__/g</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">())</span>
          <span class="nx">callback</span> <span class="nx">response</span>
      <span class="k">else</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="k">throw</span> <span class="nx">err</span>
          <span class="k">else</span>
            <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/__FILE__/g</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>The <em>wrapTest</em> handler wraps the downstream reponse in an SC.filename reference,
which is found via <strong>FILE</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">wrapTest:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
        <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="nv">response.data = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                          function() {</span>
<span class="s2">                            SC.filename = \&quot;__FILE__\&quot;;</span>
<span class="s2">                            #{response.data}</span>
<span class="s2">                          })();</span>
<span class="s2">                          &quot;&quot;&quot;</span>
          <span class="nx">callback</span> <span class="nx">response</span>
      <span class="k">else</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="k">throw</span> <span class="nx">err</span>
          <span class="k">else</span>
            <span class="nv">data = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                   function() {</span>
<span class="s2">                     SC.filename = \&quot;__FILE__\&quot;;</span>
<span class="s2">                     #{data}</span>
<span class="s2">                   })();</span>
<span class="s2">                   &quot;&quot;&quot;</span>
            <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>The <em>join</em> handler joins any files coming through, and their children, into 
a cumulative data array, which is joined upon callback. The callback is fired
when the file count from downstream processing is met.</p>

<p>If the file has no children, the file's handlerSet is called to process and
return data. </p>

<p>If the file has children (It is a virtual file, not present on
disk in the original project), handlerSets for the children, which may in
turn also have children, are called, perhaps to return data resulting from
a large recursive sequence.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">join:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="nv">data = </span><span class="p">[]</span>

      <span class="k">if</span> <span class="o">not</span> <span class="nx">file</span><span class="p">.</span><span class="nx">children</span><span class="o">?</span> <span class="o">or</span> <span class="nx">file</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nx">file</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
      <span class="k">else</span>
        <span class="nv">filesForJoin = </span><span class="nx">file</span><span class="p">.</span><span class="nx">children</span>

        <span class="nv">count = </span><span class="nx">filesForJoin</span><span class="p">.</span><span class="nx">length</span>

        <span class="k">if</span> <span class="nx">count</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nx">callback</span> <span class="nv">data: </span><span class="s1">&#39;&#39;</span>
        <span class="k">else</span>
          <span class="nx">filesForJoin</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(file, i) -&gt;</span>
            <span class="nv">next = </span><span class="p">(</span><span class="k">if</span> <span class="nx">@next</span> <span class="k">then</span> <span class="nx">@next</span> <span class="k">else</span> <span class="nx">file</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">)</span>
            <span class="nx">next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(d) -&gt;</span>
              <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">data</span>
              <span class="nx">count</span> <span class="o">-=</span> <span class="mi">1</span>
              <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">data</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">count</span> <span class="o">is</span> <span class="mi">0</span>
            </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>The <em>symlink</em> handler can only be run by itself or at the tail end 
of a sequence of handlers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">symlink:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">symlink</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">.</span><span class="nx">symlink</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p><em>lessify</em> is a static utility method that applies less to data.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@lessify: </span><span class="nf">(path, data, callback) -&gt;</span>
    <span class="nv">parser = </span><span class="k">new</span> <span class="nx">less</span><span class="p">.</span><span class="nx">Parser</span><span class="p">(</span>
      <span class="nv">optimization: </span><span class="mi">0</span>
      <span class="nv">paths: </span><span class="p">[</span> <span class="nx">path</span> <span class="p">]</span>
    <span class="p">)</span>
    <span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(err, tree) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;ERROR: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span>
      <span class="k">else</span>
        <span class="k">try</span>
          <span class="nv">data = </span><span class="nx">tree</span><span class="p">.</span><span class="nx">toCSS</span><span class="p">()</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;ERROR: &quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span>
      <span class="nx">callback</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>The <em>less</em> handler applies the less parser to file data.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">less:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">less</span><span class="o">?</span> <span class="o">and</span> <span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;.less&quot;</span>
        <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
          <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
            <span class="nx">Busser</span><span class="p">.</span><span class="nx">lessify</span> <span class="nx">file</span><span class="p">.</span><span class="nx">framework</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(lessifiedData) -&gt;</span>
              <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">lessifiedData</span>
        <span class="k">else</span>
          <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
              <span class="k">throw</span> <span class="nx">err</span>
            <span class="k">else</span>
              <span class="nx">Busser</span><span class="p">.</span><span class="nx">lessify</span> <span class="nx">file</span><span class="p">.</span><span class="nx">framework</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(lessifiedData) -&gt;</span>
                <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">lessifiedData</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
          <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
            <span class="nx">callback</span> <span class="nx">response</span>
        <span class="k">else</span>
          <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
              <span class="k">throw</span> <span class="nx">err</span>
            <span class="k">else</span>
              <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>The <em>handlebars</em> handler treats handlebar template files by stringifying them
to prepare for a call to SC.Handlebars.compile(), by wrapping the stringified
data in an SC.TEMPLATES directive.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handlebars:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="k">if</span> <span class="nx">@next</span><span class="o">?</span>
        <span class="nx">@next</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
          <span class="k">if</span> <span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;.handlebars&quot;</span>
            <span class="nv">re = </span><span class="sr">/[^\/]+\/templates\/(.+)\.handlebars/</span>
            <span class="nv">filename = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
            <span class="nv">response.data = </span><span class="s2">&quot;SC.TEMPLATES[&#39;#{filename}&#39;] = SC.Handlebars.compile(#{JSON.stringify(response.data.toString(&quot;</span><span class="nx">utf8</span><span class="s2">&quot;))});&quot;</span>
            <span class="nx">callback</span> <span class="nx">response</span>
          <span class="k">else</span>
            <span class="nx">callback</span> <span class="nx">response</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;.handlebars&quot;</span>
          <span class="nv">re = </span><span class="sr">/[^\/]+\/templates\/(.+)\.handlebars/</span>
          <span class="nv">filename = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
          <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
              <span class="k">throw</span> <span class="nx">err</span>
            <span class="k">else</span>
              <span class="nx">callback</span> <span class="nv">data: </span><span class="s2">&quot;SC.TEMPLATES[&#39;#{filename}&#39;] = SC.Handlebars.compile(#{JSON.stringify(data.toString(&quot;</span><span class="nx">utf8</span><span class="s2">&quot;))});&quot;</span>
        <span class="k">else</span>
          <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
              <span class="k">throw</span> <span class="nx">err</span>
            <span class="k">else</span>
              <span class="nx">callback</span> <span class="nv">data: </span><span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>The <em>file</em> handler must be the only handler in a <strong>HandlerSet</strong> or it must come 
at the end of a handler sequence where a file is read.</p>

<p>The <em>file</em> handler calls file.content() to read data from a file. Calls to
file.content() are coordinated by a queue system to stay within a limit
for simultaneously open files. (See the content method of the <strong>File</strong> class
and the global readFile() and related functions).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">file:</span>
    <span class="nv">exec: </span><span class="nf">(file, request, callback) -&gt;</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(err, data) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="k">throw</span> <span class="nx">err</span>
        <span class="k">else</span>
          <span class="nx">callback</span> <span class="nv">data: </span><span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>The global <strong>Busser</strong> instance is created.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">busser = </span><span class="k">new</span> <span class="nx">Busser</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p><em>availableHandlerNames</em> is a convenience method for use by developers in listing
handlers defined in the <strong>Busser</strong> class. The global instance of busser is queried
for its own properties, which will include variables and methods, and the
list returned is filtered for known non-handler properties and methods.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">availableHandlerNames  = </span><span class="o">-&gt;</span>
  <span class="p">(</span><span class="nx">h</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">h</span> <span class="k">of</span> <span class="nx">busser</span> <span class="k">when</span> <span class="nx">h</span> <span class="o">not</span> <span class="k">in</span> <span class="p">[</span> <span class="s2">&quot;constructor&quot;</span><span class="p">,</span> <span class="s2">&quot;handlerSet&quot;</span><span class="p">,</span> <span class="s2">&quot;mtimeScanner&quot;</span><span class="p">,</span> <span class="s2">&quot;minifyStylesheet&quot;</span><span class="p">,</span> <span class="s2">&quot;minifyScript&quot;</span><span class="p">,</span> <span class="s2">&quot;rewriteStatic&quot;</span><span class="p">,</span> <span class="s2">&quot;lessify&quot;</span> <span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p><strong>HandlerSet</strong> singletons are used in the specialized File subclasses defined
below. The names of the handlerSets match the <strong>File</strong> subclasses, generally,
and there are several with descriptive names.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">rootContentHtmlHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;root content html&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span> <span class="p">])</span>
<span class="nv">rootSymlinkHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;root symlink&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;symlink&quot;</span> <span class="p">])</span>

<span class="nv">stylesheetHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;stylesheet&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ifModifiedSince&quot;</span><span class="p">,</span> <span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;less&quot;</span><span class="p">,</span> <span class="s2">&quot;rewriteStaticInStylesheet&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">])</span>
<span class="nv">minifiedStylesheetHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;stylesheet&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ifModifiedSince&quot;</span><span class="p">,</span> <span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;minify&quot;</span><span class="p">,</span> <span class="s2">&quot;less&quot;</span><span class="p">,</span> <span class="s2">&quot;rewriteStaticInStylesheet&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">])</span>
<span class="nv">virtualStylesheetHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;virtual stylesheet&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;join&quot;</span> <span class="p">])</span>

<span class="nv">scriptHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ifModifiedSince&quot;</span><span class="p">,</span> <span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;rewriteSuper&quot;</span><span class="p">,</span> <span class="s2">&quot;rewriteStaticInScript&quot;</span><span class="p">,</span> <span class="s2">&quot;handlebars&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">])</span>
<span class="nv">minifiedScriptHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ifModifiedSince&quot;</span><span class="p">,</span> <span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;minify&quot;</span><span class="p">,</span> <span class="s2">&quot;rewriteSuper&quot;</span><span class="p">,</span> <span class="s2">&quot;rewriteStaticInScript&quot;</span><span class="p">,</span> <span class="s2">&quot;handlebars&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">])</span>
<span class="nv">virtualScriptHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;virtual script&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;join&quot;</span> <span class="p">])</span>

<span class="nv">testHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;rewriteFile&quot;</span><span class="p">,</span> <span class="s2">&quot;wrapTest&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span> <span class="p">])</span>
<span class="nv">resourceHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;ifModifiedSince&quot;</span><span class="p">,</span> <span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span> <span class="p">])</span>
<span class="nv">uncombinedScriptHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;uncombined script&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span> <span class="p">])</span>
<span class="nv">joinHandlerSet = </span><span class="nx">busser</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">(</span><span class="s2">&quot;join only&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s2">&quot;join&quot;</span> <span class="p">])</span> <span class="c1"># [TODO] urlPrefix needs to be custom for app?</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h1>Main Classes</h1>

<h2>Framework</h2>

<p>The <strong>Framework</strong> class contains the build() method and related methods for
processing files in an on-disk project framework, which is a directory with
javascript, css, and image files. Frameworks constitute different parts of
SproutCore itself, such as runtime, foundation, and desktop, as well as 
add-ons, such as themes like Ace. An application can also be divided into
frameworks, or it can have dependent frameworks, such as sproutcore-flot,
a graph-plotting library.</p>

<p>Properties of <strong>Framework</strong> specify basic data and build parameters:</p>

<ul>
<li><p><em>name</em> -- For SproutCore, e.g., runtime, foundation. Otherwise the name
       should be the name of the on-disk directory for the framework.</p></li>
<li><p><em>path</em> -- The path of the framework from the project root directory. For
       example, if the project name is MyApp, we would expect that the
       MyApp directory contains an apps directory and a frameworks
       directory, and perhaps others, such as themes or design. For
       most projects, all frameworks are kept in frameworks. So,
       the path for the SproutCore runtime framework would be:</p>

<blockquote>
  <p>frameworks/sproutcore/frameworks/
  (And, the same for sproutcore-flot, if used in MyApp).</p>
</blockquote></li>
<li><p><em>combineStylesheets</em> -- If true, a virtual file (one not on disk in the
                     original project) will be created during build to
                     hold all stylesheets in the framework, concatenated
                     as a single in-memory file. A save operation can
                     later write this out to disk for deployment.</p></li>
<li><p><em>combineScripts</em> -- Same as combineStylesheets, but for javascript files.</p></li>
<li><p><em>minifyStylesheets</em> -- If true, stylesheets will be minified with the
                    yuicompressor utility, whether files are kept
                    as individual files or combined.</p></li>
<li><p><em>minifyScripts</em> -- Same as <em>minifyStylesheets</em>, but for javascript files.</p></li>
<li><p><em>buildLanguage</em> -- [TODO] When would you want to have a build language
                different for frameworks? If not, remove from here
                and leave as an App class property.</p></li>
</ul>

<p>The <strong>Framework</strong> class contains arrays for basic types of files:</p>

<blockquote>
  <p>stylesheetFiles, scriptFiles, resourceFiles, testFiles</p>
</blockquote>

<p>and for the sorted arrays for stylesheets and scripts, where the sorting
is done during the build process to sort by dependencies:</p>

<blockquote>
  <p>orderedStylesheetFiles, orderedScriptFiles</p>
</blockquote>

<p>and for two possible virtual files containing combined stylesheets or
scripts, if the booleans for these are set:</p>

<blockquote>
  <p><em>virtualStylesheetReference</em> -- These two are instances of Reference,
  <em>virtualScriptReference</em>        which is a url-to-file couplet.</p>
</blockquote>

<p>The <strong>Framework</strong> class has a <em>pathsToExlude</em> property, which is
an array of paths or regular expressions used to exclude directories. For
example, a "fixtures" path can be allowed for a development build, but
excluded for a production build.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Framework</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="vi">@name = </span><span class="kc">null</span>
    <span class="vi">@path = </span><span class="kc">null</span>

    <span class="vi">@combineStylesheets = </span><span class="kc">false</span>
    <span class="vi">@combineScripts = </span><span class="kc">false</span>
    <span class="vi">@minifyStylesheets = </span><span class="kc">false</span>
    <span class="vi">@minifyScripts = </span><span class="kc">false</span>

    <span class="vi">@buildLanguage = </span><span class="s2">&quot;english&quot;</span>

    <span class="vi">@stylesheetFiles = </span><span class="p">[]</span>
    <span class="vi">@scriptFiles = </span><span class="p">[]</span>
    <span class="vi">@resourceFiles = </span><span class="p">[]</span>
    <span class="vi">@testFiles = </span><span class="p">[]</span>

    <span class="vi">@orderedStylesheetFiles = </span><span class="p">[]</span>
    <span class="vi">@orderedScriptFiles = </span><span class="p">[]</span>

    <span class="vi">@virtualStylesheetReference = </span><span class="kc">null</span>
    <span class="vi">@virtualScriptReference = </span><span class="kc">null</span>

    <span class="vi">@pathsToExclude = </span><span class="p">[</span> <span class="sr">/(^\.|\/\.|tmp\/|debug\/|tests\/|test_suites\/|setup_body_class_names)/</span> <span class="p">]</span>

    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span>

    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pathsToExclude</span><span class="o">?</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pathsToExclude</span> <span class="k">instanceof</span> <span class="nb">Array</span>
        <span class="vi">@pathsToExclude = </span><span class="nx">@pathsToExclude</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">pathsToExclude</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">@pathsToExclude</span><span class="p">.</span><span class="nx">push</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pathsToExclude</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">pathsToExclude</span> <span class="k">instanceof</span> <span class="nb">RegExp</span>

  <span class="nv">addStylesheetFile: </span><span class="nf">(path) -&gt;</span>
    <span class="k">if</span> <span class="nx">@minifyStylesheets</span>
      <span class="nx">@stylesheetFiles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">MinifiedStylesheetFile</span><span class="p">({</span> <span class="nv">path: </span><span class="nx">path</span><span class="p">,</span> <span class="nv">framework: </span><span class="k">this</span> <span class="p">}))</span>
    <span class="k">else</span>
      <span class="nx">@stylesheetFiles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">StylesheetFile</span><span class="p">({</span> <span class="nv">path: </span><span class="nx">path</span><span class="p">,</span> <span class="nv">framework: </span><span class="k">this</span> <span class="p">}))</span>

  <span class="nv">addScriptFile: </span><span class="nf">(path) -&gt;</span>
    <span class="k">if</span> <span class="nx">@minifyScripts</span>
      <span class="nx">@scriptFiles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">MinifiedScriptFile</span><span class="p">({</span> <span class="nv">path: </span><span class="nx">path</span><span class="p">,</span> <span class="nv">framework: </span><span class="k">this</span> <span class="p">}))</span>
    <span class="k">else</span>
      <span class="nx">@scriptFiles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">ScriptFile</span><span class="p">({</span> <span class="nv">path: </span><span class="nx">path</span><span class="p">,</span> <span class="nv">framework: </span><span class="k">this</span> <span class="p">}))</span>

  <span class="nv">addTestFile: </span><span class="nf">(path) -&gt;</span>
    <span class="nx">@testFiles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">TestFile</span><span class="p">({</span> <span class="nv">path: </span><span class="nx">path</span><span class="p">,</span> <span class="nv">framework: </span><span class="k">this</span> <span class="p">}))</span>

  <span class="nv">addResourceFile: </span><span class="nf">(path) -&gt;</span>
    <span class="nx">@resourceFiles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">ResourceFile</span><span class="p">({</span> <span class="nv">path: </span><span class="nx">path</span><span class="p">,</span> <span class="nv">framework: </span><span class="k">this</span> <span class="p">}))</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>The allFiles method returns virtual (combined) files, if defined, and also
the individual stylesheet, script, test, and resource files, as a concatenated
list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allFiles: </span><span class="o">-&gt;</span>
    <span class="nv">all = </span><span class="p">[]</span>
    <span class="nx">all</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@virtualStylesheetReference</span><span class="p">.</span><span class="nx">file</span> <span class="k">if</span> <span class="nx">@virtualStylesheetReference</span><span class="o">?</span>
    <span class="nx">all</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@virtualScriptReference</span><span class="p">.</span><span class="nx">file</span> <span class="k">if</span> <span class="nx">@virtualScriptReference</span><span class="o">?</span>
    <span class="nx">all</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@stylesheetFiles</span> <span class="c1"># [TODO] Should this be ordered?</span>
    <span class="nx">all</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@scriptFiles</span>
    <span class="nx">all</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@testFiles</span>
    <span class="nx">all</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@resourceFiles</span>
    <span class="nx">all</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Frameworks are known in a built or deployed project by their names and are
referred to with file urls, so the paths in the original project can be
simplified by omitting common path elements. For example,</p>

<pre><code>'/frameworks/sproutcore/frameworks/runtime/system/index_set.js'
</code></pre>

<p>becomes</p>

<pre><code>'/sproutcore/runtime/system/index_set.js'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reducedPathFor: </span><span class="nf">(path) -&gt;</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(^apps|frameworks|^themes|([a-z]+)\.lproj|resources)\//g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>A url consists of the joined buildVersion and reducedPath.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">urlFor: </span><span class="nf">(path) -&gt;</span>
    <span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span> <span class="nx">@buildVersion</span><span class="p">,</span> <span class="nx">@reducedPathFor</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Same as <em>reducedPathFor</em>, as a convenience call for reducedPathFor(@path).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reducedPath: </span><span class="o">-&gt;</span>
    <span class="nx">@reducedPathFor</span><span class="p">(</span><span class="nx">@path</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>The url for this framework is made by urlFor @path, reduced.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">url: </span><span class="o">-&gt;</span>
    <span class="nx">@urlFor</span><span class="p">(</span><span class="nx">@reducedPath</span><span class="p">())</span>
  </pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p><em>shouldExcludeFile</em> first operates on <em>pathsToExclude</em>, checking if the path 
matches any exluded path. Then it checks if <em>buildLanguage</em> is in allowed
lists.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">shouldExcludeFile: </span><span class="nf">(path) -&gt;</span>
    <span class="k">for</span> <span class="nx">re</span> <span class="k">in</span> <span class="nx">@pathsToExclude</span>
      <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">lang = </span><span class="nx">languageInPath</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">lang</span><span class="o">?</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">lang</span> <span class="k">in</span> <span class="p">[</span> <span class="nx">@buildLanguage</span><span class="p">,</span> <span class="nx">defaultLanguage</span><span class="p">,</span> <span class="nx">buildLanguageAbbreviation</span><span class="p">(</span><span class="nx">@buildLanguage</span><span class="p">)</span> <span class="p">]</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="kc">true</span>
  
  <span class="nv">headFile: </span><span class="o">-&gt;</span>
    <span class="kc">null</span>

  <span class="nv">tailFile: </span><span class="o">-&gt;</span>
    <span class="k">new</span> <span class="nx">File</span><span class="p">(</span>
      <span class="nv">path: </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@path</span><span class="p">,</span> <span class="s2">&quot;after.js&quot;</span><span class="p">)</span>
      <span class="nv">framework: </span><span class="k">this</span>
      <span class="nv">content: </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;; if ((typeof SC !== \&quot;undefined\&quot;) &amp;&amp; SC &amp;&amp; SC.bundleDidLoad) SC.bundleDidLoad(\&quot;#{@reducedPath()}\&quot;);\n&quot;</span>
      <span class="nv">handlerSet: </span><span class="nx">uncombinedScriptHandlerSet</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p><em>computeDependencies</em> uses a <strong>DependenciesComputer</strong> class and its compute
method to read a list of files, parsing each for require statements,
and making a list of urls, built from paths of dependencies, with .js 
added, in each file's new deps array.</p>

<p>When finished, the callback is fired with the list of files, which then
have their .deps arrays added.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">computeDependencies: </span><span class="nf">(files, callback) -&gt;</span>
    <span class="k">class</span> <span class="nx">FileDependenciesComputer</span>
      <span class="nv">constructor: </span><span class="nf">(@file, @framework) -&gt;</span>

      <span class="nv">readFileAndCompute: </span><span class="nf">(callbackAfterFileDependencies) -&gt;</span>
        <span class="nx">readFile</span> <span class="nx">@file</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>
          <span class="vi">@file.deps = </span><span class="p">[]</span>
          <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;require\\([\&quot;&#39;](.*?)[\&quot;&#39;]\\)&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">)</span>
          <span class="k">while</span> <span class="nv">match = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
            <span class="nv">path = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="nx">path</span> <span class="o">+=</span> <span class="s2">&quot;.js&quot;</span>  <span class="nx">unless</span> <span class="sr">/\.js$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
            <span class="nx">@file</span><span class="p">.</span><span class="nx">deps</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">urlFor</span><span class="p">(</span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@framework</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">path</span><span class="p">))</span>
          <span class="nx">callbackAfterFileDependencies</span><span class="p">()</span>

    <span class="k">class</span> <span class="nx">DependenciesComputer</span> <span class="k">extends</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span>
      <span class="nv">constructor: </span><span class="nf">(@files=[], @framework) -&gt;</span>
        <span class="vi">@count = </span><span class="nx">@files</span><span class="p">.</span><span class="nx">length</span>

      <span class="nv">compute: </span><span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">@count</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@files</span>
            <span class="nv">fdc = </span><span class="k">new</span> <span class="nx">FileDependenciesComputer</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">@framework</span><span class="p">)</span>
            <span class="nx">fdc</span><span class="p">.</span><span class="nx">readFileAndCompute</span> <span class="o">=&gt;</span>
              <span class="nx">@count</span> <span class="o">-=</span> <span class="mi">1</span>
              <span class="nx">@emit</span> <span class="s1">&#39;end&#39;</span> <span class="k">if</span> <span class="nx">@count</span> <span class="o">&lt;=</span> <span class="mi">0</span>
        <span class="k">else</span>
          <span class="nx">@emit</span> <span class="s1">&#39;end&#39;</span>

    <span class="nv">dependencyComputer = </span><span class="k">new</span> <span class="nx">DependenciesComputer</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">callback</span><span class="o">?</span>
      <span class="nx">dependencyComputer</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="nx">files</span>
    <span class="nx">dependencyComputer</span><span class="p">.</span><span class="nx">compute</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p><em>sortDependencies</em> is a recursive method working on a list of javascript files
received from <em>computeDependencies</em>, which has added a .deps array for each file.
<em>sortDependencies</em> searches the dependency urls in deps for the matching
file for each, recursively continuing until a file with no dependencies is found
and added to the sorted results. In this way, dependent files are added to the
orderedFiles array ahead of files requiring them.</p>

<p>In the event of a failed find, a console warning is issued for the dependency.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sortDependencies: </span><span class="nf">(file, orderedFiles, files, recursionHistory) -&gt;</span>
    <span class="nv">recursionHistory = </span><span class="p">[]</span>  <span class="k">if</span> <span class="o">not</span> <span class="nx">recursionHistory</span><span class="o">?</span>

    <span class="k">return</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">recursionHistory</span> <span class="k">else</span> <span class="nx">recursionHistory</span><span class="p">.</span><span class="nx">push</span> <span class="nx">file</span>

    <span class="k">if</span> <span class="nx">file</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">orderedFiles</span>
      <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">deps</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">url</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">deps</span>
          <span class="nv">len = </span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span>
          <span class="nv">found = </span><span class="kc">false</span>
          <span class="nv">i = </span><span class="mi">0</span>
          <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span>
            <span class="k">if</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">url</span><span class="p">()</span> <span class="o">is</span> <span class="nx">url</span>
              <span class="nv">found = </span><span class="kc">true</span>
              <span class="nx">@sortDependencies</span> <span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">orderedFiles</span><span class="p">,</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">recursionHistory</span>
              <span class="k">break</span>
            <span class="o">++</span><span class="nx">i</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">found</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;WARNING: #{url} is required in #{file.url()} but does not exist.&quot;</span>
      <span class="nx">orderedFiles</span><span class="p">.</span><span class="nx">push</span> <span class="nx">file</span>
  </pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>The <em>orderScripts</em> method calls <em>computeDependencies</em> on a list of javascript files,
receiving the resulting files, which have had a .deps array added for each, in a
callback function which first sorts alphabetically on path, then calls
<em>sortDependencies</em>, layering the sorting calls based on dependencies of strings.js
and core.js, before generally adding the rest. This is to prioritize for i18n
definitions in strings.js and then focusing on the most important code, as should
be specified in each framework's core.js file.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">orderScripts: </span><span class="nf">(scripts, callback) -&gt;</span>
    <span class="nx">@computeDependencies</span> <span class="nx">scripts</span><span class="p">,</span> <span class="p">(</span><span class="nx">scripts</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">orderedScriptFiles = </span><span class="p">[]</span>
      <span class="nv">coreJs = </span><span class="kc">null</span>
      <span class="nv">coreJsPath = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@path</span><span class="p">,</span> <span class="s2">&quot;core.js&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Order scripts alphabetically by path.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">sortedScripts = </span><span class="nx">scripts</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nf">(a, b) -&gt;</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">localeCompare</span> <span class="nx">b</span><span class="p">.</span><span class="nx">path</span>
      <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Do strings.js first.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">script</span> <span class="k">in</span> <span class="nx">sortedScripts</span>
        <span class="nx">@sortDependencies</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">orderedScriptFiles</span><span class="p">,</span> <span class="nx">sortedScripts</span><span class="p">)</span> <span class="k">if</span> <span class="sr">/strings\.js$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span>
        <span class="nv">coreJs = </span><span class="nx">script</span>  <span class="k">if</span> <span class="nx">script</span><span class="p">.</span><span class="nx">path</span> <span class="o">is</span> <span class="nx">coreJsPath</span>
  </pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Then do core.js and its dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">coreJs</span><span class="o">?</span>
        <span class="nx">@sortDependencies</span><span class="p">(</span><span class="nx">coreJs</span><span class="p">,</span> <span class="nx">orderedScriptFiles</span><span class="p">,</span> <span class="nx">sortedScripts</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">script</span> <span class="k">in</span> <span class="nx">sortedScripts</span>
          <span class="nx">@sortDependencies</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">orderedScriptFiles</span><span class="p">,</span> <span class="nx">sortedScripts</span><span class="p">)</span> <span class="k">if</span> <span class="nx">script</span><span class="p">.</span><span class="nx">deps</span><span class="o">?</span> <span class="o">and</span> <span class="nx">coreJs</span><span class="p">.</span><span class="nx">path</span> <span class="k">in</span> <span class="nx">script</span><span class="p">.</span><span class="nx">deps</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Then do the rest.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@sortDependencies</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">orderedScriptFiles</span><span class="p">,</span> <span class="nx">sortedScripts</span><span class="p">)</span> <span class="k">for</span> <span class="nx">script</span> <span class="k">in</span> <span class="nx">sortedScripts</span>
  
      <span class="k">continue</span>  <span class="k">while</span> <span class="nx">scripts</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="nx">scripts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">i</span>  <span class="k">while</span> <span class="nv">i = </span><span class="nx">orderedScriptFiles</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="nx">callback</span><span class="p">()</span>
 </pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>The <em>bundleInfo</em> method is unused in the martoche version of garcon, but bundle support was
support was added in a branch of the mauritslamers version. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bundleInfo: </span><span class="o">-&gt;</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ;SC.BUNDLE_INFO[&#39;#{@reducedPath()}&#39;] = {</span>
<span class="s2">      requires: [],</span>
<span class="s2">      scripts: [#{(script.url() for script in @orderedScriptFiles)}],</span>
<span class="s2">      styles: [#{(stylesheet.url() for stylesheet in @orderedStylesheetFiles)}]</span>
<span class="s2">    };</span>
<span class="s2">    &quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>The <em>sproutcoreFrameworks</em> static method returns a default list of Framework instances, 
either with or without jquery, testing for jquery in the project. This method is used
in testing, or when a build configuration file is not provided to the build process.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@sproutcoreFrameworks: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@_sproutcoreFrameworks</span><span class="o">?</span>
      <span class="nv">opts =</span>
        <span class="nv">combineScripts: </span><span class="kc">true</span>
        <span class="nv">pathsToExclude: </span><span class="p">[</span> <span class="sr">/fixtures\//</span> <span class="p">]</span>
  
      <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span>
        <span class="k">if</span> <span class="nx">key</span> <span class="o">is</span> <span class="s2">&quot;pathsToExclude&quot;</span>
          <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>
          <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">]</span>  <span class="k">if</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">RegExp</span>
          <span class="nx">opts</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
        <span class="k">else</span>
          <span class="nx">opts</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">try</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="s2">&quot;frameworks/sproutcore/frameworks/jquery&quot;</span>
        <span class="nv">frameworkNames = </span><span class="p">[</span> <span class="s2">&quot;jquery&quot;</span><span class="p">,</span> <span class="s2">&quot;runtime&quot;</span><span class="p">,</span> <span class="s2">&quot;core_foundation&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;foundation&quot;</span><span class="p">,</span> <span class="s2">&quot;datastore&quot;</span><span class="p">,</span> <span class="s2">&quot;desktop&quot;</span><span class="p">,</span> <span class="s2">&quot;template_view&quot;</span> <span class="p">]</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="nv">frameworkNames = </span><span class="p">[</span> <span class="s2">&quot;runtime&quot;</span><span class="p">,</span> <span class="s2">&quot;foundation&quot;</span><span class="p">,</span> <span class="s2">&quot;datastore&quot;</span><span class="p">,</span> <span class="s2">&quot;desktop&quot;</span><span class="p">,</span> <span class="s2">&quot;animation&quot;</span> <span class="p">]</span>

      <span class="vi">@_sproutcoreFrameworks = </span><span class="p">[</span> <span class="k">new</span> <span class="nx">BootstrapFramework</span><span class="p">()</span> <span class="p">]</span>
      <span class="k">for</span> <span class="nx">frameworkName</span> <span class="k">in</span> <span class="nx">frameworkNames</span>
        <span class="nv">opts.name = </span><span class="nx">frameworkName</span>
        <span class="nv">opts.path = </span><span class="s2">&quot;frameworks/sproutcore/frameworks/#{frameworkName}&quot;</span>
        <span class="nx">@_sproutcoreFrameworks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Framework</span><span class="p">(</span><span class="nx">opts</span><span class="p">))</span>

    <span class="nx">@_sproutcoreFrameworks</span>
  </pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>The <em>build</em> method for frameworks first scans for files, adding basic File
objects into arrays, excluding files based on checks in <em>shouldExcludeFile</em>.</p>

<p>Separate arrays are created for stylesheets, scripts, tests, and resources.</p>

<p>The finalization steps will order stylesheets and scripts, and prepare any
combined virtual files needed.</p>

<p>When done, <em>callbackAfterBuild</em> is called, if defined.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">build: </span><span class="p">(</span><span class="nx">callbackAfterBuild</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>The <em>createBasicFiles</em> method scans the framework directory for all files,
filtering by <em>shouldExcludeFile</em>, and creates basic File objects: stylesheets, 
scripts, tests, and resources.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">createBasicFiles = </span><span class="p">(</span><span class="nx">callbackAfterBuild</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">class</span> <span class="nx">Scanner</span> <span class="k">extends</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span>
        <span class="nv">constructor: </span><span class="nf">(@framework) -&gt;</span>
          <span class="vi">@count = </span><span class="mi">0</span>
  
        <span class="nv">scan: </span><span class="nf">(path) -&gt;</span>
          <span class="nx">@count</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>
            <span class="k">if</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span>
              <span class="nx">@count</span> <span class="o">+=</span> <span class="mi">1</span>
              <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">subpaths</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@count</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>
                <span class="nx">@scan</span> <span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">subpath</span><span class="p">)</span> <span class="k">for</span> <span class="nx">subpath</span> <span class="k">in</span> <span class="nx">subpaths</span> <span class="k">when</span> <span class="nx">subpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">isnt</span> <span class="s2">&quot;.&quot;</span>
              <span class="nx">@emit</span> <span class="s2">&quot;end&quot;</span> <span class="k">if</span> <span class="nx">@count</span> <span class="o">&lt;=</span> <span class="mi">0</span>
            <span class="k">else</span>
              <span class="k">if</span> <span class="o">not</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">shouldExcludeFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
                <span class="k">switch</span> <span class="nx">fileType</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
                  <span class="k">when</span> <span class="s2">&quot;stylesheet&quot;</span> <span class="k">then</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">addStylesheetFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
                  <span class="k">when</span> <span class="s2">&quot;script&quot;</span> <span class="k">then</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">addScriptFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
                  <span class="k">when</span> <span class="s2">&quot;test&quot;</span> <span class="k">then</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">addTestFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
                  <span class="k">when</span> <span class="s2">&quot;resource&quot;</span> <span class="k">then</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">addResourceFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
            <span class="nx">@emit</span> <span class="s2">&quot;end&quot;</span> <span class="k">if</span> <span class="nx">@count</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    
      <span class="nv">scanner = </span><span class="k">new</span> <span class="nx">Scanner</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="nx">scanner</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nx">finalizeBuild</span> <span class="nx">callbackAfterBuild</span>
      <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="nx">@path</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>The <em>finalizeBuild</em> method performs ordering and combining steps after
basic files have been created.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">finalizeBuild = </span><span class="p">(</span><span class="nx">callbackAfterBuild</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Create a virtual stylesheets file if combineStylesheets is set, or sort
individual stylesheet files alphabetically. </p>

<p><em>orderedStylesheets</em> will hold either the single virtual file or the sorted 
individual stylesheets.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@orderedStylesheetFiles = </span><span class="p">[]</span>

      <span class="k">if</span> <span class="nx">@stylesheetFiles</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nx">@combineStylesheets</span> <span class="o">is</span> <span class="kc">true</span>
          <span class="nv">virtualStylesheetFile = </span><span class="k">new</span> <span class="nx">VirtualStylesheetFile</span>
            <span class="nv">path: </span><span class="s2">&quot;#{@path}.css&quot;</span>
            <span class="nv">framework: </span><span class="k">this</span>
            <span class="nv">children: </span><span class="nx">@stylesheetFiles</span>
          <span class="vi">@virtualStylesheetReference = </span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="nx">virtualStylesheetFile</span><span class="p">.</span><span class="nx">url</span><span class="p">(),</span> <span class="nx">virtualStylesheetFile</span><span class="p">)</span>
          <span class="vi">@orderedStylesheetFiles = </span><span class="p">[</span> <span class="nx">virtualStylesheetFile</span> <span class="p">]</span>
        <span class="k">else</span>
          <span class="vi">@orderedStylesheetFiles = </span><span class="nx">@stylesheetFiles</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">localeCompare</span> <span class="nx">b</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Call <em>orderScripts</em> to sort scripts alphabetically then by dependencies.
Then create a virtual scripts file if <em>combineScripts</em> is set.</p>

<p><em>orderedScriptFiles</em> will hold either the single virtual file or the ordered
individual script files.</p>

<p>Ordering scripts is the last build task before firing the after-build
callback, if defined.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@orderedScriptFiles = </span><span class="p">[]</span>

      <span class="k">if</span> <span class="nx">@scriptFiles</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">@orderScripts</span> <span class="nx">@scriptFiles</span><span class="p">,</span> <span class="o">=&gt;</span>
          <span class="k">if</span> <span class="nx">@combineScripts</span> <span class="o">is</span> <span class="kc">true</span>
            <span class="nv">virtualScriptFile = </span><span class="k">new</span> <span class="nx">VirtualScriptFile</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>path: @path + ".js"</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nv">path: </span><span class="k">if</span> <span class="sr">/\.js$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">@path</span><span class="p">)</span> <span class="k">then</span> <span class="nx">@path</span> <span class="k">else</span> <span class="s2">&quot;#{@path}.js&quot;</span> <span class="c1"># added for temporary special theme.js case [TODO] keep or delete.</span>
              <span class="nv">framework: </span><span class="k">this</span>
              <span class="nv">children: </span><span class="p">(</span><span class="nx">child</span> <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@headFile</span><span class="p">(),</span> <span class="nx">@scriptFiles</span><span class="p">...,</span> <span class="nx">@tailFile</span><span class="p">()]</span> <span class="k">when</span> <span class="nx">child</span><span class="o">?</span><span class="p">)</span>
            <span class="vi">@virtualScriptReference = </span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="nx">virtualScriptFile</span><span class="p">.</span><span class="nx">url</span><span class="p">(),</span> <span class="nx">virtualScriptFile</span><span class="p">)</span>
            <span class="vi">@orderedScriptFiles = </span><span class="p">[</span> <span class="nx">virtualScriptFile</span> <span class="p">]</span>
          <span class="k">else</span>
            <span class="vi">@orderedScriptFiles = </span><span class="p">(</span><span class="nx">child</span> <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="p">[</span><span class="nx">@headFile</span><span class="p">(),</span> <span class="nx">@scriptFiles</span><span class="p">...,</span> <span class="nx">@tailFile</span><span class="p">()]</span> <span class="k">when</span> <span class="nx">child</span><span class="o">?</span><span class="p">)</span>
          
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;  #{@name} &quot;</span><span class="p">,</span> <span class="s2">&quot;built.&quot;</span><span class="p">.</span><span class="nx">red</span>

          <span class="nx">callbackAfterBuild</span><span class="p">()</span> <span class="k">if</span> <span class="nx">callbackAfterBuild</span><span class="o">?</span>
      <span class="k">else</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;  #{@name} &quot;</span><span class="p">,</span> <span class="s2">&quot;built.&quot;</span><span class="p">.</span><span class="nx">red</span>

        <span class="nx">callbackAfterBuild</span><span class="p">()</span> <span class="k">if</span> <span class="nx">callbackAfterBuild</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Fire the build methods, passing the provided <em>callbackAfterBuild</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">createBasicFiles</span> <span class="nx">callbackAfterBuild</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <h2>Reference</h2>

<p>The <strong>Reference</strong> class is a url/file couplet. It is used for html and symlink files, 
and for the virtual stylesheet and script files.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Reference</span>
  <span class="nv">constructor: </span><span class="nf">(@url, @file) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <h2>File</h2>

<p>The <strong>File</strong> class holds information about an on-disk file or a virtual file, which is
an abstraction for a framework directory. The children array is used for virtual
files, either the <strong>VirtualStylesheetFile</strong> or <strong>VirtualScriptFile</strong> derived classes. The
handlerSet property has one of the <strong>HandlerSet</strong> singletons defined above, which
controls the build process for a given file type. A file can be a symlink to the
root html file, which is only used in <strong>SymlinkFile</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="vi">@path = </span><span class="kc">null</span>
    <span class="vi">@framework = </span><span class="kc">null</span>
    <span class="vi">@children = </span><span class="kc">null</span>
    <span class="vi">@handlerSet = </span><span class="kc">null</span>
    <span class="vi">@isHtml = </span><span class="kc">false</span>
    <span class="vi">@isVirtual = </span><span class="kc">false</span>
    <span class="vi">@symlink = </span><span class="kc">null</span>

    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span>

  <span class="nv">url: </span><span class="o">-&gt;</span>
    <span class="nx">@framework</span><span class="p">.</span><span class="nx">urlFor</span><span class="p">(</span><span class="nx">@path</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>In <em>pathForSave</em>, we see the use of url(), which by itself is used in file lookup,
but the file that is saved for <em>RootContentHtmlFile</em> needs a ".html" extension to allow
http://localhost:8000/myapp instead of http://localhost:8000/myapp/myapp.html.
The symlink handler is involved in linking to the root content.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pathForSave: </span><span class="o">-&gt;</span>
    <span class="s2">&quot;#{@url()}.html&quot;</span> <span class="k">if</span> <span class="nx">@isHtml</span> <span class="k">else</span> <span class="nx">@url</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>The <em>content</em> method is coordinated with the queue system for managing the number
of open files, via the call to readFile to read an on-disk file. This method is 
overridden in the <strong>RootContentHtmlFile</strong> subclass to return html content.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">content: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">readFile</span> <span class="nx">@path</span><span class="p">,</span> <span class="nx">callback</span>
  </pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Create a directory, checking the prefix of the path for "." and "/".</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@createDirectory: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">prefix = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nx">File</span><span class="p">.</span><span class="nx">createDirectory</span> <span class="nx">prefix</span>  <span class="k">if</span> <span class="nx">prefix</span> <span class="o">isnt</span> <span class="s2">&quot;.&quot;</span> <span class="o">and</span> <span class="nx">prefix</span> <span class="o">isnt</span> <span class="s2">&quot;/&quot;</span>
    <span class="k">try</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span> <span class="nx">path</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="s2">&quot;0755&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="k">throw</span> <span class="nx">e</span>  <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">isnt</span> <span class="s2">&quot;EEXIST&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h2>SymlinkFile</h2>

<p><strong>SymlinkFile</strong> is used for the instance of a symlink to the root html file.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">SymlinkFile</span> <span class="k">extends</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@handlerSet = </span><span class="nx">rootSymlinkHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <h2>RootContentHtmlFile</h2>

<p>The <strong>RootContentHtmlFile</strong> contains the html with main links to a project's stylesheets,
scripts, and resources. Its rootContentHtmlHandlerSet has cache, contentType, and file
handlers, so that during serving it is read once, then cached. The <strong>RootContentHtmlFile</strong>
is created at the end of the build process, when links to files and resources are known.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">RootContentHtmlFile</span> <span class="k">extends</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@handlerSet = </span><span class="nx">rootContentHtmlHandlerSet</span>
    <span class="vi">@app = </span><span class="kc">null</span>
    <span class="vi">@isHtml = </span><span class="kc">true</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span>

  <span class="nv">pathForSave: </span><span class="o">-&gt;</span>
    <span class="s2">&quot;#{@app.url()}.html&quot;</span>

  <span class="nv">content: </span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">html = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Load html for document, head, and meta sections. [TODO] Fix the paths in apple-touch links.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&quot;&quot; &lt;!DOCTYPE html&gt;</span>
<span class="s2">                  &lt;html lang=\&quot;#{buildLanguageAbbreviation()}\&quot;&gt;</span>
<span class="s2">                    &lt;head&gt;</span>
<span class="s2">                      &lt;meta charset=\&quot;utf-8\&quot;&gt;,</span>
<span class="s2">                      &lt;meta http-equiv=\&quot;X-UA-Compatible\&quot; content=\&quot;IE=edge,chrome=1\&quot;&gt;</span>

<span class="s2">                      &lt;script&gt;</span>
<span class="s2">                        var SC_benchmarkPreloadEvents = { headStart: new Date().getTime() };</span>
<span class="s2">                      &lt;/script&gt;</span>

<span class="s2">                      &lt;meta http-equiv=\&quot;Content-type\&quot; content=\&quot;text/html; charset=utf-8\&quot; /&gt;</span>
<span class="s2">                      &lt;meta http-equiv=\&quot;Content-Script-Type\&quot; content=\&quot;text/javascript\&quot; /&gt;</span>
<span class="s2">                      &lt;meta name=\&quot;apple-mobile-web-app-capable\&quot; content=\&quot;yes\&quot; /&gt;</span>
<span class="s2">                      &lt;meta name=\&quot;apple-mobile-web-app-status-bar-style\&quot; content=\&quot;default\&quot; /&gt;</span>
<span class="s2">                      &lt;meta name=\&quot;viewport\&quot; content=\&quot;initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no\&quot; /&gt;</span>

<span class="s2">                      &lt;link rel=\&quot;apple-touch-icon\&quot; href=\&quot;/static/sproutcore/foundation/en/current/source/resources/images/sproutcore-logo.png?1317844275\&quot; /&gt;</span>
<span class="s2">                      &lt;link rel=\&quot;apple-touch-startup-image\&quot; media=\&quot;screen and (orientation:portrait)\&quot; href=\&quot;/static/sproutcore/foundation/en/current/source/resources/images/sproutcore-startup-portrait.png?1317844275\&quot; /&gt; </span>
<span class="s2">                      &lt;link rel=\&quot;apple-touch-startup-image\&quot; media=\&quot;screen and (orientation:landscape)\&quot; href=\&quot;/static/sproutcore/foundation/en/current/source/resources/images/sproutcore-startup-landscape.png?1317844275\&quot; /&gt;</span>
<span class="s2">                      &lt;link rel=\&quot;shortcut icon\&quot; href=\&quot;/static/sproutcore/foundation/en/current/resources/images/favicon.ico?1317844275\&quot; type=\&quot;image/x-icon\&quot; /&gt;</span>
<span class="s2">              &quot;&quot;&quot;</span>

    <span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&lt;title&gt;#{@title}&lt;/title&gt;&quot;</span> <span class="k">if</span> <span class="nx">@title</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Load references to the virtual stylesheet for each framework.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">framework</span> <span class="k">in</span> <span class="nx">@app</span><span class="p">.</span><span class="nx">frameworks</span>
      <span class="k">for</span> <span class="nx">stylesheet</span> <span class="k">in</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">orderedStylesheetFiles</span>
        <span class="k">if</span> <span class="nx">stylesheet</span><span class="p">.</span><span class="nx">framework</span> <span class="o">is</span> <span class="nx">framework</span>
          <span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&lt;link href=\&quot;#{@app.urlPrefix + stylesheet.url()}\&quot; rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot;&gt;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Close the head and begin the body.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&lt;/head&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;body class=\&quot;#{@app.theme} focus\&quot;&gt;&quot;</span>
    <span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;String.preferredLanguage = \&quot;#{buildLanguage}\&quot;;&lt;/script&gt;&quot;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Load references to the virtual scripts for each framework.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">framework</span> <span class="k">in</span> <span class="nx">@app</span><span class="p">.</span><span class="nx">frameworks</span>
      <span class="k">for</span> <span class="nx">script</span> <span class="k">in</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">orderedScriptFiles</span>
        <span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;#{@app.urlPrefix + script.url()}\&quot;&gt;&lt;/script&gt;&quot;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Close the body and page.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">html</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&quot;&quot; </span>
<span class="s2">                  &lt;script&gt;</span>
<span class="s2">                    SC.benchmarkPreloadEvents[&#39;bodyEnd&#39;] = new Date().getTime();</span>
<span class="s2">                  &lt;/script&gt;</span>
<span class="s2">                &lt;/body&gt;</span>
<span class="s2">              &lt;/html&gt;</span>
<span class="s2">              &quot;&quot;&quot;</span>
    <span class="nv">html = </span><span class="nx">html</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span>
      
    <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">html</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <h2>StylesheetFile</h2>

<p><em>*StylesheetFile</em> is a class for .css and related file types.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">StylesheetFile</span> <span class="k">extends</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@handlerSet = </span><span class="nx">stylesheetHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <h2>MinifiedStylesheetFile </h2>

<p><strong>MinifiedStylesheetFile</strong> is a class for .css and related file types, minified.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">MinifiedStylesheetFile</span> <span class="k">extends</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@handlerSet = </span><span class="nx">minifiedStylesheetHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <h2>ScriptFile</h2>

<p><strong>ScriptFile</strong> is a class for .js files.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ScriptFile</span> <span class="k">extends</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@handlerSet = </span><span class="nx">scriptHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <h2>MinifiedScriptFile</h2>

<p><strong>MinifiedScriptFile</strong> is a class for .js files, minified.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">MinifiedScriptFile</span> <span class="k">extends</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@handlerSet = </span><span class="nx">minifiedScriptHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <h2>TestFile</h2>

<p><strong>TestFile</strong> is a class for .js files used in testing, and are idendified
as such by matching against a set of known directory names in paths.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">TestFile</span> <span class="k">extends</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@handlerSet = </span><span class="nx">testHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <h2>ResourceFile</h2>

<p><strong>ResourceFile</strong> is a class for a variety of image types used in a project,
defined in the static property resourceExtensions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ResourceFile</span> <span class="k">extends</span> <span class="nx">File</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@handlerSet = </span><span class="nx">resourceHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span>

  <span class="vi">@resourceExtensions = </span><span class="p">[</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.gif&#39;</span><span class="p">,</span> <span class="s1">&#39;.svg&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <h2>VirtualStylesheetFile</h2>

<p>The <strong>VirtualStylesheetFile</strong> class is an extension of StylesheetFile, for use in
handling framework directories that contain individual stylesheet files. So,
by virtual here, we refer to the fact that the file is not actually found on
disk in the original project, and exists either only in memory or also as a
saved combined file, if save operations are directed to make one.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">VirtualStylesheetFile</span> <span class="k">extends</span> <span class="nx">StylesheetFile</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@isVirtual = </span><span class="kc">true</span>
    <span class="vi">@children = </span><span class="p">[]</span>
    <span class="vi">@handlerSet = </span><span class="nx">virtualStylesheetHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <h2>VirtualScriptFile</h2>

<p>The <strong>VirtualScriptFile</strong> extends <strong>ScriptFile</strong>, for use in handling script files in
a framework. It is identical in structure to <strong>VirtualStylesheetFile</strong>, with the
addition of two methods, headFile and tailFile, which contain javascript to be
inserted at the head or tail of the children list of contained scripts. This
head and tail javascript covers such needs as defining variables and namespaces
before contained child scripts load and reporting after scripts have loaded.</p>

<p><strong>VirtualScriptFile</strong> only has tailFile defined, for inclusion of a did-load check.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">VirtualScriptFile</span> <span class="k">extends</span> <span class="nx">ScriptFile</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="k">super</span> <span class="nx">options</span>
    <span class="vi">@isVirtual = </span><span class="kc">true</span>
    <span class="vi">@children = </span><span class="p">[]</span>
    <span class="vi">@handlerSet = </span><span class="nx">virtualScriptHandlerSet</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <h2>BootstrapFramework</h2>

<p>The <strong>BootstrapFramework</strong> class has headFile and tailFile methods that return
needed script fragments before and after child files in the bootstrap
framework, the files of which are read from disk in the build procedure.
headFile and tailFile override methods of the Framework superclass. The
head file contains main declarations of SC and require. Tail file code
calls SC.setupBodyClassNames(), once bootrap code has loaded. This function
is in bootstrap/system/loader.js, where browser-specific tweaks are made for
setting up the body of the main app html page.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">BootstrapFramework</span> <span class="k">extends</span> <span class="nx">Framework</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="nv">options.name = </span><span class="s2">&quot;bootstrap&quot;</span>
    <span class="nv">options.path = </span><span class="s2">&quot;frameworks/sproutcore/frameworks/bootstrap&quot;</span>
    <span class="nv">options.combineScripts = </span><span class="kc">true</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>

  <span class="nv">headFile: </span><span class="o">=&gt;</span>
    <span class="k">new</span> <span class="nx">File</span>
      <span class="nv">path: </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@path</span><span class="p">,</span> <span class="s2">&quot;before.js&quot;</span><span class="p">)</span>
      <span class="nv">framework: </span><span class="k">this</span>
      <span class="nv">content: </span><span class="nf">(callback) -&gt;</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                       var SC = SC || { BUNDLE_INFO: {}, LAZY_INSTANTIATION: {} };</span>
<span class="s2">                       var require = require || function require() {};</span>
<span class="s2">                       &quot;&quot;&quot;</span>
      <span class="nv">handlerSet: </span><span class="nx">uncombinedScriptHandlerSet</span>
  
  <span class="nv">tailFile: </span><span class="o">=&gt;</span>
    <span class="k">new</span> <span class="nx">File</span>
      <span class="nv">path: </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@path</span><span class="p">,</span> <span class="s2">&quot;after.js&quot;</span><span class="p">)</span>
      <span class="nv">framework: </span><span class="k">this</span>
      <span class="nv">content: </span><span class="nf">(callback) -&gt;</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;; if (SC.setupBodyClassNames) SC.setupBodyClassNames();&quot;</span>
      <span class="nv">handlerSet: </span><span class="nx">uncombinedScriptHandlerSet</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <h2>App</h2>

<p>The <strong>App</strong> class contains metadata properties for a single SproutCore application, along
with build-specific properties and their default values. An <strong>App</strong> is <strong>Framework</strong>-like, in
the similarity of properties. It contains a list of frameworks and a files associative
array of urls to files, which is set up by a call to registerFiles after the build
processes complete. This files array is exposed to a server.</p>

<p><em>htmlFileReference</em> and <em>htmlSymlinkReference</em> hold links to the root html file.</p>

<p>Principal methods are <em>build</em> and <em>save</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">App</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="vi">@name = </span><span class="kc">null</span>
    <span class="vi">@title = </span><span class="kc">null</span>
    <span class="vi">@path = </span><span class="kc">null</span>
    <span class="vi">@buildLanguage = </span><span class="s2">&quot;english&quot;</span>
    <span class="vi">@combineStylesheets = </span><span class="kc">true</span>
    <span class="vi">@combineScripts = </span><span class="kc">true</span>
    <span class="vi">@minifyScripts = </span><span class="kc">false</span>
    <span class="vi">@minifyStylesheets = </span><span class="kc">false</span>

    <span class="vi">@urlPrefix = </span><span class="s2">&quot;&quot;</span>
    <span class="vi">@theme = </span><span class="s2">&quot;sc-theme&quot;</span>
    <span class="vi">@pathForSave = </span><span class="s2">&quot;./build&quot;</span>

    <span class="vi">@frameworks = </span><span class="p">[]</span>

    <span class="vi">@files = </span><span class="p">[]</span>

    <span class="vi">@htmlFileReference = </span><span class="kc">null</span>
    <span class="vi">@htmlSymlinkReference = </span><span class="kc">null</span>

    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span>

  <span class="vi">@buildVersion: </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>The <em>reducedPathFor</em>, <em>urlFor</em>, and <em>url</em> methods are the same as those for
the <strong>Framework</strong> class, tied here to the prototype definitions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reducedPathFor: </span><span class="nx">Framework</span><span class="o">::</span><span class="nx">reducedPathFor</span>
  <span class="nv">reducedPath: </span><span class="nx">Framework</span><span class="o">::</span><span class="nx">reducedPath</span>
  <span class="nv">urlFor: </span><span class="nx">Framework</span><span class="o">::</span><span class="nx">urlFor</span>
  <span class="nv">url: </span><span class="o">-&gt;</span> <span class="nx">Framework</span><span class="o">::</span><span class="nx">urlFor</span><span class="p">(</span><span class="nx">@name</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>The <em>addSproutCore</em> convenience method adds frameworks returned by the static function
<em>sproutcoreFrameworks</em> defined in the <strong>Framework</strong> class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addSproutCore: </span><span class="nf">(options={}) -&gt;</span>
    <span class="nx">@frameworks</span><span class="p">.</span><span class="nx">push</span> <span class="nx">framework</span> <span class="k">for</span> <span class="nx">framework</span> <span class="k">in</span> <span class="nx">Framework</span><span class="p">.</span><span class="nx">sproutcoreFrameworks</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p><em>buildRoot</em> creates the root html file and a symlink to it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buildRoot: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Set a file for the root html content.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">file = </span><span class="k">new</span> <span class="nx">RootContentHtmlFile</span>
      <span class="nv">path: </span><span class="nx">@name</span>
      <span class="nv">app: </span><span class="k">this</span>
      <span class="nv">framework: </span><span class="k">this</span>
    <span class="vi">@htmlFileReference = </span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">(),</span> <span class="nx">file</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Set a file for a symlink to the root html file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">symlink = </span><span class="k">new</span> <span class="nx">SymlinkFile</span>
      <span class="nv">path: </span><span class="nx">@name</span>
      <span class="nv">app: </span><span class="k">this</span>
      <span class="nv">symlink: </span><span class="nx">file</span>
      <span class="nv">framework: </span><span class="k">this</span>
    <span class="vi">@htmlSymlinkReference = </span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="nx">@name</span><span class="p">,</span> <span class="nx">symlink</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>The <em>build</em> method uses the contained <strong>FrameworksBuilder</strong> class to build an app, first
calling the app's buildRoot method, then building frameworks in the app.
When finished, the callback is called if it is defined.</p>

<p>The <strong>FrameworksBuilder</strong> class for the app execs the build methods for the
root html content and for the content of each framework.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">build: </span><span class="nf">(callbackAfterBuild) -&gt;</span>
    <span class="k">class</span> <span class="nx">FrameworksBuilder</span> <span class="k">extends</span> <span class="nx">process</span><span class="p">.</span><span class="nx">EventEmitter</span>
      <span class="nv">constructor: </span><span class="nf">(@frameworks) -&gt;</span>
        <span class="vi">@count = </span><span class="nx">@frameworks</span><span class="p">.</span><span class="nx">length</span>

      <span class="nv">build: </span><span class="o">-&gt;</span>
        <span class="k">for</span> <span class="nx">framework</span> <span class="k">in</span> <span class="nx">@frameworks</span>
          <span class="nx">framework</span><span class="p">.</span><span class="nx">build</span> <span class="o">=&gt;</span>
            <span class="nx">@count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="nx">@emit</span> <span class="s1">&#39;end&#39;</span>  <span class="k">if</span> <span class="nx">@count</span> <span class="o">&lt;=</span> <span class="mi">0</span>

    <span class="nx">@buildRoot</span><span class="p">()</span>
    <span class="nv">builder = </span><span class="k">new</span> <span class="nx">FrameworksBuilder</span><span class="p">(</span><span class="nx">@frameworks</span><span class="p">)</span>
    <span class="nx">builder</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Build for #{@path} is complete.&quot;</span>
      <span class="k">if</span> <span class="nx">callbackAfterBuild</span><span class="o">?</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Registering files.&quot;</span>
        <span class="nx">@registerFiles</span><span class="p">()</span>
        <span class="nx">callbackAfterBuild</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Build for #{@path} has started.&quot;</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">build</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p><em>registerFile</em> sets the url of the file as the key in the files associative
array, which is exposed to the server for file requests.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">registerFile: </span><span class="nf">(url, file) -&gt;</span>
    <span class="nx">@files</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">file</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p><em>registerFiles</em> is called after the build process has completed. It resets the 
files array, then calls <em>registerFile</em> to add back references for the root file
and symlink and for the files in child frameworks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">registerFiles: </span><span class="o">-&gt;</span>
    <span class="vi">@files = </span><span class="p">[]</span>
    <span class="nx">@registerFile</span> <span class="nx">@htmlFileReference</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">(),</span> <span class="nx">@htmlFileReference</span><span class="p">.</span><span class="nx">file</span>
    <span class="nx">@registerFile</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">@htmlSymlinkReference</span><span class="p">.</span><span class="nx">file</span>
    <span class="k">for</span> <span class="nx">framework</span> <span class="k">in</span> <span class="nx">@frameworks</span>
      <span class="nx">@registerFile</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">(),</span> <span class="nx">file</span><span class="p">)</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">allFiles</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>The <em>save</em> method first creates a fresh unique <em>buildVersion</em> as a long <strong>Date</strong> instance
for the current time, then the contained <strong>Saver</strong> class is used to save child
frameworks and usually some combination of combined virtual files. The logic for
combining and bundling frameworks and application code flows in a series of if
else blocks until the main root html file is writen.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">save: </span><span class="o">=&gt;</span>
    <span class="vi">@buildVersion = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>

    <span class="k">class</span> <span class="nx">Saver</span>
      <span class="nv">constructor: </span><span class="nf">(@buildVersion, @app, @file) -&gt;</span>
        
      <span class="nv">save: </span><span class="o">-&gt;</span>
        <span class="nx">@file</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">@file</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span> <span class="o">and</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nv">path = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@app</span><span class="p">.</span><span class="nx">pathForSave</span><span class="p">,</span> <span class="nx">@buildVersion</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">@file</span><span class="p">.</span><span class="nx">pathForSave</span><span class="p">())</span>
            <span class="nx">File</span><span class="p">.</span><span class="nx">createDirectory</span> <span class="nx">path_module</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
              <span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span>

    <span class="k">for</span> <span class="nx">framework</span> <span class="k">in</span> <span class="nx">@frameworks</span>
      <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">resourceFiles</span>
        <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">file</span><span class="p">).</span><span class="nx">save</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">combineStylesheets</span>
        <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">virtualStylesheetReference</span><span class="p">.</span><span class="nx">file</span><span class="p">)</span> <span class="k">if</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">virtualStyleSheetReference</span><span class="o">?</span>
      <span class="k">else</span>
        <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">orderedStylesheetFiles</span>
      <span class="k">if</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">combineScripts</span>
        <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">virtualScriptReference</span><span class="p">.</span><span class="nx">file</span><span class="p">)</span> <span class="k">if</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">virtualScriptReference</span><span class="o">?</span>
      <span class="k">else</span>
        <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">orderedScriptFiles</span>

    <span class="k">if</span> <span class="nx">@combineStylesheets</span>
      <span class="nv">virtualStylesheetFile = </span><span class="k">new</span> <span class="nx">VirtualStylesheetFile</span>
        <span class="nv">path: </span><span class="s2">&quot;#{@name}.css&quot;</span>
        <span class="nv">framework: </span><span class="k">this</span>
        <span class="nv">handlerSet: </span><span class="nx">joinHandlerSet</span>
        <span class="nv">children: </span><span class="p">(</span><span class="nx">fw</span><span class="p">.</span><span class="nx">virtualStylesheetReference</span><span class="p">.</span><span class="nx">file</span> <span class="k">for</span> <span class="nx">fw</span> <span class="k">in</span> <span class="nx">@frameworks</span> <span class="k">when</span> <span class="nx">fw</span><span class="p">.</span><span class="nx">virtualStylesheetReference</span><span class="o">?</span><span class="p">)</span>
      <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">virtualStylesheetFile</span><span class="p">).</span><span class="nx">save</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="k">for</span> <span class="nx">framework</span> <span class="k">in</span> <span class="nx">@frameworks</span>
        <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">orderedStylesheetFiles</span>
          <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">file</span><span class="p">).</span><span class="nx">save</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">@combineScripts</span>
      <span class="nv">virtualScriptFile = </span><span class="k">new</span> <span class="nx">VirtualScriptFile</span>
        <span class="nv">path: </span><span class="s2">&quot;{@name}.js&quot;</span>
        <span class="nv">framework: </span><span class="k">this</span>
        <span class="nv">handlerSet: </span><span class="nx">joinHandlerSet</span>
        <span class="nv">children: </span><span class="p">(</span><span class="nx">fw</span><span class="p">.</span><span class="nx">virtualScriptReference</span><span class="p">.</span><span class="nx">file</span> <span class="k">for</span> <span class="nx">fw</span> <span class="k">in</span> <span class="nx">@frameworks</span> <span class="k">when</span> <span class="nx">fw</span><span class="p">.</span><span class="nx">virtualScriptReference</span><span class="o">?</span><span class="p">)</span>
      <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">virtualScriptFile</span><span class="p">).</span><span class="nx">save</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="k">for</span> <span class="nx">framework</span> <span class="k">in</span> <span class="nx">@frameworks</span>
        <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">orderedScriptFiles</span>
          <span class="k">new</span> <span class="nx">Saver</span><span class="p">(</span><span class="nx">@buildVersion</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">file</span><span class="p">).</span><span class="nx">save</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">virtualStylesheetFile</span><span class="o">?</span>
      <span class="nv">htmlStylesheetLinks = </span><span class="s2">&quot;&lt;link href=\&quot;#{@urlPrefix + virtualStylesheetFile.url()}\&quot; rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot;&gt;&quot;</span>
    <span class="k">else</span>
      <span class="nv">htmlStylesheetLinks = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">fw</span> <span class="k">in</span> <span class="nx">@frameworks</span>
        <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">fw</span><span class="p">.</span><span class="nx">orderedStylesheetFiles</span>
          <span class="nx">htmlStylesheetLinks</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&lt;link href=\&quot;#{@urlPrefix + file.url()}\&quot; rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot;&gt;&quot;</span>
      <span class="nx">htmlStylesheetLinks</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">virtualScriptFile</span><span class="o">?</span>
      <span class="nv">htmlScriptLinks = </span><span class="s2">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;#{@urlPrefix + virtualScriptFile.url()}\&quot;&gt;&lt;/script&gt;&quot;</span>
    <span class="k">else</span>
      <span class="nv">htmlScriptLinks = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">fw</span> <span class="k">in</span> <span class="nx">@frameworks</span>
        <span class="k">if</span> <span class="nx">fw</span><span class="p">.</span><span class="nx">virtualScriptFile</span><span class="o">?</span>
          <span class="nx">htmlScriptLinks</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&lt;link href=\&quot;#{@urlPrefix + fw.virtualScriptFile.url()}\&quot; rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot;&gt;&quot;</span>
      <span class="nx">htmlScriptLinks</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>

    <span class="nv">htmlFile = </span><span class="k">new</span> <span class="nx">RootContentHtmlFile</span>
      <span class="nv">path: </span><span class="nx">@name</span>
      <span class="nv">app: </span><span class="k">this</span>
      <span class="nv">framework: </span><span class="k">this</span>

    <span class="nv">path = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@pathForSave</span><span class="p">,</span> <span class="nx">@buildVersion</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">htmlFile</span><span class="p">.</span><span class="nx">pathForSave</span><span class="p">())</span>
    <span class="nx">File</span><span class="p">.</span><span class="nx">createDirectory</span> <span class="nx">path_module</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nx">htmlFile</span><span class="p">.</span><span class="nx">content</span> <span class="nf">(data) -&gt;</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="k">throw</span> <span class="nx">err</span>  <span class="k">if</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <h1>Server</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Server</span>
  <span class="nv">constructor: </span><span class="nf">(options={}) -&gt;</span>
    <span class="vi">@port = </span><span class="mi">8000</span>
    <span class="vi">@hostname = </span><span class="s2">&quot;localhost&quot;</span>
    <span class="vi">@proxyHost = </span><span class="kc">null</span>
    <span class="vi">@proxyPort = </span><span class="kc">null</span>
    <span class="vi">@proxyPrefix = </span><span class="s2">&quot;&quot;</span>
    <span class="vi">@allowCrossSiteRequests = </span><span class="kc">false</span>
    <span class="vi">@apps = </span><span class="p">[]</span>

    <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span>

  <span class="nv">shouldProxy: </span><span class="o">-&gt;</span>
    <span class="nx">@proxyHost</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@proxyPort</span><span class="o">?</span>

  <span class="nv">addApp: </span><span class="nf">(app) -&gt;</span>
    <span class="nv">app = </span><span class="k">new</span> <span class="nx">App</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">app</span> <span class="k">instanceof</span> <span class="nx">App</span>
    <span class="nv">app.server = </span><span class="k">this</span>
    <span class="nx">@apps</span><span class="p">.</span><span class="nx">push</span> <span class="nx">app</span>
    <span class="nx">app</span>

  <span class="nv">setDirectory: </span><span class="nf">(path) -&gt;</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">chdir</span> <span class="nx">path</span>

  <span class="nv">serve: </span><span class="nf">(file, request, response) -&gt;</span>
    <span class="nx">file</span><span class="p">.</span><span class="nx">handlerSet</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nf">(r) -&gt;</span>
      <span class="nv">headers = </span><span class="p">{}</span>
      <span class="nv">status = </span><span class="mi">200</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">contentType</span>  <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">contentType</span><span class="o">?</span>
      <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">lastModified</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;httpDateTime&quot;</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">lastModified</span><span class="o">?</span>
      <span class="nv">status = </span><span class="nx">r</span><span class="p">.</span><span class="nx">status</span>  <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">status</span><span class="o">?</span>
      <span class="k">if</span> <span class="nx">@allowCrossSiteRequests</span>
        <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
        <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;access-control-request-headers&quot;</span><span class="p">]</span>
          <span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;access-control-request-headers&quot;</span><span class="p">]</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">headers</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">write</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span>  <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
  
  <span class="nv">proxy: </span><span class="nf">(request, response) -&gt;</span>
    <span class="nv">proxy_url = </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">proxy_url = </span><span class="nx">@proxyPrefix</span> <span class="o">+</span> <span class="nx">proxy_url</span>  <span class="k">if</span> <span class="nx">@proxyPrefix</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">proxy_url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@proxyPrefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nv">proxyClient = </span><span class="nx">http</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="nx">@proxyPort</span><span class="p">,</span> <span class="nx">@proxyHost</span><span class="p">)</span>
    <span class="nx">proxyClient</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;ERROR: \&quot;#{err.message}\&quot; for proxy request on #{@proxyHost}:#{@proxyPort}&quot;</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">404</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

    <span class="nv">request.headers.host = </span><span class="nx">@proxyHost</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">+=</span> <span class="s2">&quot;:#{@proxyPort}&quot;</span>  <span class="nx">unless</span> <span class="nx">@proxyPort</span> <span class="o">is</span> <span class="mi">80</span>
    <span class="nv">proxyRequest = </span><span class="nx">proxyClient</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span>
    <span class="nx">request</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
      <span class="nx">proxyRequest</span><span class="p">.</span><span class="nx">write</span> <span class="nx">chunk</span>

    <span class="nx">request</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">proxyRequest</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
  
    <span class="nx">proxyRequest</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="nf">(proxyResponse) -&gt;</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span> <span class="nx">proxyResponse</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">proxyResponse</span><span class="p">.</span><span class="nx">headers</span>
      <span class="nx">proxyResponse</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">write</span> <span class="nx">chunk</span>

      <span class="nx">proxyResponse</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
  
  <span class="nv">file: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">file = </span><span class="kc">null</span>
    <span class="k">for</span> <span class="nx">app</span> <span class="k">in</span> <span class="nx">@apps</span>
      <span class="nv">file = </span><span class="nx">app</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">file</span> <span class="k">if</span> <span class="nx">file</span><span class="o">?</span>
    <span class="nx">file</span>

  <span class="nv">run: </span><span class="o">-&gt;</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">path = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nv">file = </span><span class="nx">@file</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">file</span><span class="o">?</span>
          <span class="k">if</span> <span class="nx">@shouldProxy</span><span class="p">()</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;Proxying #{request.url}&quot;</span>
            <span class="nx">@proxy</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span>
          <span class="k">else</span>
            <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">404</span>
            <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
        <span class="k">else</span>
          <span class="nx">@serve</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span>
    <span class="p">).</span><span class="nx">listen</span> <span class="nx">@port</span><span class="p">,</span> <span class="nx">@hostname</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nv">app_url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">format</span>
        <span class="nv">protocol: </span><span class="s2">&quot;http&quot;</span>
        <span class="nv">hostname: </span><span class="nx">@hostname</span>
        <span class="nv">port: </span><span class="nx">@port</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Server started on #{app_url}/APPLICATION_NAME&quot;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;  HOSTNAME:&#39;</span><span class="p">,</span> <span class="nx">@hostname</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;  PORT:&#39;</span><span class="p">,</span> <span class="nx">@port</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre> </pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <h1>Instantiation and Execution</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exec = </span><span class="nf">(appTargets, actionItems) -&gt;</span>
  <span class="nv">defaultAppDevConf = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;default-app-dev&quot;</span><span class="p">)</span>
  <span class="nv">defaultAppProdConf = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;default-app-prod&quot;</span><span class="p">)</span>
  <span class="nv">defaultFrameworksDevConf = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;default-sc-frameworks-dev&quot;</span><span class="p">)</span>
  <span class="nv">defaultFrameworksProdConf = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;default-sc-frameworks-prod&quot;</span><span class="p">)</span>
  
  <span class="nv">apps = </span><span class="p">[]</span>
  <span class="nv">appConfigurations = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;apps&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">appConfigurations</span>
    <span class="nv">appKey = </span><span class="nx">key</span>
    <span class="k">if</span> <span class="nx">appKey</span> <span class="k">in</span> <span class="nx">appTargets</span>
      <span class="nv">appConf = </span><span class="nx">appConfigurations</span><span class="p">[</span><span class="nx">appKey</span><span class="p">]</span>
      <span class="nv">myApp = </span><span class="k">new</span> <span class="nx">App</span>
        <span class="nv">name: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="nv">title: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
        <span class="nv">path: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
        <span class="nv">theme: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span>
        <span class="nv">buildLanguage: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;buildLanguage&quot;</span><span class="p">]</span>
        <span class="nv">combineScripts: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;combineScripts&quot;</span><span class="p">]</span>
        <span class="nv">combineStylesheets: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;combineStylesheets&quot;</span><span class="p">]</span>
        <span class="nv">minifyScripts: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;minifyScripts&quot;</span><span class="p">]</span>
        <span class="nv">minifyStylesheets: </span><span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;minifyStylesheets&quot;</span><span class="p">]</span>
  
      <span class="nv">myApp.frameworks = </span><span class="p">[]</span>
      <span class="nx">myApp</span><span class="p">.</span><span class="nx">frameworks</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">BootstrapFramework</span><span class="p">()</span>
  
      <span class="k">for</span> <span class="nx">fwConf</span> <span class="k">in</span> <span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;sc-frameworks&quot;</span><span class="p">]</span>
        <span class="k">switch</span> <span class="nx">fwConf</span><span class="p">.</span><span class="nx">conf</span>
          <span class="k">when</span> <span class="s2">&quot;dev&quot;</span> <span class="k">then</span> <span class="nx">myApp</span><span class="p">.</span><span class="nx">frameworks</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Framework</span><span class="p">(</span><span class="nx">defaultFrameworksDevConf</span><span class="p">[</span><span class="nx">fwConf</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span>
          <span class="k">when</span> <span class="s2">&quot;prod&quot;</span> <span class="k">then</span> <span class="nx">myApp</span><span class="p">.</span><span class="nx">frameworks</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Framework</span><span class="p">(</span><span class="nx">defaultFrameworksProdConf</span><span class="p">[</span><span class="nx">fwConf</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span>
          <span class="k">when</span> <span class="nx">fwConf</span><span class="p">.</span><span class="nx">conf</span> <span class="k">instanceof</span> <span class="nb">String</span> <span class="c1"># The default for unknown is dev.</span>
            <span class="nx">myApp</span><span class="p">.</span><span class="nx">frameworks</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Framework</span><span class="p">(</span><span class="nx">defaultFrameworksDevConf</span><span class="p">[</span><span class="nx">fwConf</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span>
          <span class="k">when</span> <span class="nx">fwConf</span><span class="p">.</span><span class="nx">conf</span> <span class="k">instanceof</span> <span class="nb">Object</span>
            <span class="nx">myApp</span><span class="p">.</span><span class="nx">frameworks</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Framework</span><span class="p">(</span><span class="nx">fwConf</span><span class="p">.</span><span class="nx">conf</span><span class="p">)</span>
  
      <span class="k">for</span> <span class="nx">fwConf</span> <span class="k">in</span> <span class="nx">appConf</span><span class="p">[</span><span class="s2">&quot;custom-frameworks&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">fwConf</span><span class="p">.</span><span class="nx">conf</span> <span class="k">instanceof</span> <span class="nb">Object</span>
          <span class="nx">myApp</span><span class="p">.</span><span class="nx">frameworks</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Framework</span><span class="p">(</span><span class="nx">fwConf</span><span class="p">.</span><span class="nx">conf</span><span class="p">)</span>
    
      <span class="nx">myApp</span><span class="p">.</span><span class="nx">frameworks</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Framework</span>
        <span class="nv">name: </span><span class="nx">myApp</span><span class="p">.</span><span class="nx">name</span>
        <span class="nv">path: </span><span class="s2">&quot;apps/#{myApp.name}&quot;</span>
        <span class="nv">combineScripts: </span><span class="kc">true</span>
        <span class="nv">combineStylesheets: </span><span class="kc">true</span>
        <span class="nv">minifyScripts: </span><span class="kc">false</span>
        <span class="nv">minifyStylesheets: </span><span class="kc">false</span>
        
      <span class="k">switch</span> <span class="nx">actionItems</span>
        <span class="k">when</span> <span class="s2">&quot;build&quot;</span> <span class="k">then</span> <span class="nx">myApp</span><span class="p">.</span><span class="nx">build</span><span class="p">()</span>
        <span class="k">when</span> <span class="s2">&quot;buildsave&quot;</span> <span class="k">then</span> <span class="nx">myApp</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">myApp</span><span class="p">.</span><span class="nx">save</span><span class="p">)</span>
        <span class="k">when</span> <span class="s2">&quot;buildrun&quot;</span> <span class="k">then</span> <span class="nx">myApp</span><span class="p">.</span><span class="nx">build</span> <span class="o">-&gt;</span>
          <span class="nv">server = </span><span class="k">new</span> <span class="nx">Server</span><span class="p">()</span>
          <span class="nx">server</span><span class="p">.</span><span class="nx">addApp</span><span class="p">(</span><span class="nx">myApp</span><span class="p">)</span>
          <span class="nx">server</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>
        <span class="k">when</span> <span class="s2">&quot;buildsaverun&quot;</span> <span class="k">then</span> <span class="nx">myApp</span><span class="p">.</span><span class="nx">build</span> <span class="o">-&gt;</span>
          <span class="nx">myApp</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
          <span class="nv">server = </span><span class="k">new</span> <span class="nx">Server</span><span class="p">()</span>
          <span class="nx">server</span><span class="p">.</span><span class="nx">addApp</span><span class="p">(</span><span class="nx">myApp</span><span class="p">)</span>
          <span class="nx">server</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Initialize nconf for command line arguments and for environmental settings</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">nconf</span><span class="p">.</span><span class="nx">argv</span><span class="p">().</span><span class="nx">env</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>If the operating mode is to use prompt, which we determine by checking for 
an arg length of 2 (node bin/busser.js), we use the prompt system. Otherwise,
in the else below, startup will initialize from command line arguments and/or
environment settings.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">2</span>
  <span class="nv">prompt.message = </span><span class="s2">&quot;Question!&quot;</span><span class="p">.</span><span class="nx">blue</span>
  <span class="nv">prompt.delimiter = </span><span class="s2">&quot;&gt;|&quot;</span><span class="p">.</span><span class="nx">green</span>

  <span class="nx">prompt</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
  
  <span class="nv">prompts = </span><span class="p">[]</span>

  <span class="nx">prompts</span><span class="p">.</span><span class="nx">push</span>
    <span class="nv">name: </span><span class="s2">&quot;configPath&quot;</span>
    <span class="nv">message: </span><span class="s2">&quot;Config path?&quot;</span><span class="p">.</span><span class="nx">magenta</span>
  <span class="nx">prompts</span><span class="p">.</span><span class="nx">push</span>
    <span class="nv">name: </span><span class="s2">&quot;appTargets&quot;</span>
    <span class="nv">validator: </span><span class="nx">appTargetsValidator</span>
    <span class="nv">warning: </span><span class="s1">&#39;Target names have letters, numbers, or dashes, and are comma-delimited. No quotes are needed.&#39;</span>
    <span class="nv">message: </span><span class="s2">&quot;Target(s)?&quot;</span><span class="p">.</span><span class="nx">magenta</span>
  <span class="nx">prompts</span><span class="p">.</span><span class="nx">push</span>
    <span class="nv">name: </span><span class="s2">&quot;actions&quot;</span>
    <span class="nv">validator: </span><span class="nx">actionsValidator</span>
    <span class="nv">warning: </span><span class="s1">&#39;Actions are one or more of: build, save, and run, in any order, and comma-delimited. No quotes are needed.&#39;</span>
    <span class="nv">message: </span><span class="s2">&quot;Action(s)?&quot;</span><span class="p">.</span><span class="nx">magenta</span>

  <span class="nx">prompt</span><span class="p">.</span><span class="nx">get</span> <span class="nx">prompts</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
    <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">configPath</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;You said your config path is: &quot;</span><span class="p">.</span><span class="nx">cyan</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">configPath</span><span class="p">.</span><span class="nx">cyan</span>
      <span class="k">try</span>
        <span class="nv">config_file = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">configPath</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="nx">nconf</span><span class="p">.</span><span class="nx">argv</span><span class="p">().</span><span class="nx">env</span><span class="p">().</span><span class="nx">file</span> <span class="nv">file: </span><span class="nx">result</span><span class="p">.</span><span class="nx">configPath</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Problem reading custom config file&quot;</span>
    
    <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">appTargets</span><span class="o">?</span> <span class="o">and</span> <span class="nx">result</span><span class="p">.</span><span class="nx">actions</span><span class="o">?</span>
      <span class="nv">appTargets = </span><span class="nx">parseAppTargetsArgument</span> <span class="nx">result</span><span class="p">.</span><span class="nx">appTargets</span>
      <span class="nv">actionItems = </span><span class="nx">parseActionsArgument</span> <span class="nx">result</span><span class="p">.</span><span class="nx">actions</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Performing: #{actionItems}&quot;</span><span class="p">.</span><span class="nx">cyan</span>
      
      <span class="nx">exec</span> <span class="nx">appTargets</span><span class="p">,</span> <span class="nx">actionItems</span>
    <span class="k">else</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Valid target(s) and action are needed... Please try again... Aborting.&quot;</span>
<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>All info is provided as command line arguments, or from environment settings. nconf
will be initialized with these, and will also be given the config file specified in
the config command line argument.</p>

<p>First, parse the config path, which for the command line argument '--config' is used,
and not the configPath internal name used in the prompt menu. The default config path
is conf/busser.json.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span><span class="o">?</span>
    <span class="k">try</span>
      <span class="nv">config_file = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">),</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
      <span class="nx">nconf</span><span class="p">.</span><span class="nx">argv</span><span class="p">().</span><span class="nx">env</span><span class="p">().</span><span class="nx">file</span> <span class="nv">file: </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>
    <span class="k">catch</span> <span class="nx">err</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Problem reading custom config file&quot;</span>
  <span class="k">else</span>
    <span class="nx">nconf</span><span class="p">.</span><span class="nx">argv</span><span class="p">().</span><span class="nx">env</span><span class="p">().</span><span class="nx">file</span> <span class="nv">file: </span><span class="s2">&quot;./conf/busser.json&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Prepare to catch command line argument parsing errors, for appTargets and actions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">errors = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Parse appTargets.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;appTargets&#39;</span><span class="p">)</span><span class="o">?</span>
    <span class="k">if</span> <span class="nx">appTargetsValidator</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;appTargets&#39;</span><span class="p">))</span>
      <span class="nv">appTargets = </span><span class="nx">parseAppTargetsArgument</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;appTargets&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;appTargets did not parse.&quot;</span>
  <span class="k">else</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;appTargets argument is missing.&quot;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Parse actions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;actions&#39;</span><span class="p">)</span><span class="o">?</span>
    <span class="k">if</span> <span class="nx">actionsValidator</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;actions&#39;</span><span class="p">))</span>
      <span class="nv">actionItems = </span><span class="nx">parseActionsArgument</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;actions&#39;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;actions did not parse.&quot;</span>
  <span class="k">else</span>
    <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;actions argument is missing.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Report errors or execute.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">errors</span>
  <span class="k">else</span>
    <span class="nx">exec</span> <span class="nx">appTargets</span><span class="p">,</span> <span class="nx">actionItems</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 