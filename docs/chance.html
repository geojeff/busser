<!DOCTYPE html>  <html> <head>   <title>chance.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="busser.html">                 busser.coffee               </a>                                           <a class="source" href="chance.html">                 chance.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               chance.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">util          = </span><span class="nx">require</span> <span class="s2">&quot;util&quot;</span>
<span class="nv">fs            = </span><span class="nx">require</span> <span class="s2">&quot;fs&quot;</span>
<span class="nv">path_module   = </span><span class="nx">require</span> <span class="s2">&quot;path&quot;</span>
<span class="nv">microtime     = </span><span class="nx">require</span> <span class="s2">&quot;microtime&quot;</span>
<span class="nv">sys           = </span><span class="nx">require</span> <span class="s2">&quot;sys&quot;</span>
<span class="nv">_             = </span><span class="nx">require</span> <span class="s2">&quot;underscore&quot;</span>
<span class="nv">gm            = </span><span class="nx">require</span> <span class="s2">&quot;../node_modules/gm&quot;</span>
<span class="nv">scss          = </span><span class="nx">require</span> <span class="s2">&quot;scss&quot;</span>
<span class="nv">stylus        = </span><span class="nx">require</span> <span class="s2">&quot;stylus&quot;</span>
<span class="nv">mkdirp        = </span><span class="nx">require</span> <span class="s2">&quot;mkdirp&quot;</span>
<span class="nv">StringScanner = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;strscan&quot;</span><span class="p">).</span><span class="nx">StringScanner</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>PORTING NOTE: Porting the Ruby code in the original Chance proceeded by first
concatenating all code into this source file, followed by arrangment in several
CoffeeScript classes matching main Ruby modules, with some combining as noted:</p>

<ul>
<li><strong>ChanceParser</strong>, from <em>abbot/vendor/chance/lib/chance/parser.rb</em></li>
<li><strong>ChanceProcessor</strong>, from <em>abbot/vendor/chance/lib/chance/instance</em>, combining here:
<ul><li><em>abbot/vendor/lib/chance/instance/data_url.rb</em></li>
<li><em>abbot/vendor/lib/chance/instance/javascript.rb</em></li>
<li><em>abbot/vendor/lib/chance/instance/slicing.rb</em></li>
<li><em>abbot/vendor/lib/chance/instance/spriting.rb</em></li></ul></li>
<li><strong>ChanceProcessorFactory</strong>, from <em>abbot/vendor/chance/lib/chance/factory.rb</em></li>
<li><strong>Chance</strong>, from the <em>abbot/vendor/chance/lib/chance</em> main module, and chance.rb</li>
</ul>

<p>Comments and function names were kept largely intact. Ruby and CoffeeScript are
similar in many respects, so the port was fairly direct, leaving only a few 
challenging conversions.</p>

<p>Javascript code examples and projects were found to match those used in Ruby Chance:</p>

<ul>
<li>LeastCommonMultiple, a class here, to match Ruby's lcm</li>
<li>String::gsub, a String prototype extension</li>
<li>String::beginsWith, a String prototype extension</li>
<li>String::endsWith, a String prototype extension</li>
<li>strscan.StringScanner, a port of Ruby's StringScanner</li>
<li>extname, a function which uses the node.js path module</li>
<li>microtime.nowDouble(), replacing Time.now.to_f in Ruby</li>
<li>underscore sortBy, a convenience array sorting function, replacing the Ruby sortBy</li>
</ul>

<p>The graphics handling parts of Ruby Chance were more challenging to write in 
CoffeeScript Chance, not just for the style of programming, but for finding a 
suitable easy-to-install replacement system. At the time of this writing, the node.js
graphicsmagick wrapper, gm, is being tried as the main workhorse.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>mkdir_p, as used in Ruby Chance, ported to CoffeeScript from:</p>

<p>https://gist.github.com/742162</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">mkdir_p = </span><span class="nf">(path, mode, callback, position) -&gt;</span>
  <span class="nv">mode = </span><span class="nx">mode</span> <span class="o">or</span> <span class="mi">0777</span>
  <span class="nv">position = </span><span class="nx">position</span> <span class="o">or</span> <span class="mi">0</span>
  <span class="nv">parts = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">position</span> <span class="o">&gt;=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">callback</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="kc">true</span>
  <span class="nv">directory = </span><span class="nx">parts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">directory</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">err</span><span class="o">?</span>
      <span class="nx">mkdir_p</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">position</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdir</span> <span class="nx">directory</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="k">if</span> <span class="nx">callback</span>
            <span class="nx">callback</span> <span class="nx">err</span>
          <span class="k">else</span>
            <span class="k">throw</span> <span class="nx">err</span>
        <span class="k">else</span>
          <span class="nx">mkdir_p</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">position</span> <span class="o">+</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Least Common Multiple</p>

<p>Converted from http://en.wikipedia.org/wiki/JavaScript</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">LCMCalculator</span>
  <span class="nv">constructor: </span><span class="nf">(x, y) -&gt;</span>
    <span class="nv">checkInt = </span><span class="nf">(x) -&gt;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; is not an integer&quot;</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">x</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nx">x</span>
    <span class="vi">@a = </span><span class="nx">checkInt</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="vi">@b = </span><span class="nx">checkInt</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span>

  <span class="nv">gcd: </span><span class="o">-&gt;</span>
    <span class="nv">a = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">@a</span><span class="p">)</span>
    <span class="nv">b = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">@b</span><span class="p">)</span>
    <span class="nv">t = </span><span class="kc">undefined</span>
    <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span>
      <span class="nv">t = </span><span class="nx">b</span>
      <span class="nv">b = </span><span class="nx">a</span>
      <span class="nv">a = </span><span class="nx">t</span>
    <span class="k">while</span> <span class="nx">b</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nv">t = </span><span class="nx">b</span>
      <span class="nv">b = </span><span class="nx">a</span> <span class="o">%</span> <span class="nx">b</span>
      <span class="nv">a = </span><span class="nx">t</span>
    <span class="k">this</span><span class="p">[</span><span class="s2">&quot;gcd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
      <span class="nx">a</span>
    <span class="nx">a</span>

  <span class="nv">lcm: </span><span class="o">-&gt;</span>
    <span class="nv">lcm = </span><span class="nx">@a</span> <span class="err">/ @gcd() * @b</span>
    <span class="vi">@lcm = </span><span class="o">-&gt;</span>
      <span class="nx">lcm</span>
    <span class="nx">lcm</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>String Substitution</h2>

<p><em>gsub</em>, from Ruby, is added to the prototyp of String here. See:
http://flochip.com/2011/09/06/rubys-string-gsub-in-javascript/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">String</span><span class="o">::</span><span class="nv">gsub = </span><span class="nf">(re, callback) -&gt;</span>
  <span class="nv">result = </span><span class="s2">&quot;&quot;</span>
  <span class="nv">source = </span><span class="k">this</span>
  <span class="k">while</span> <span class="nx">source</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nv">match = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">source</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">callback</span> <span class="nx">match</span>
      <span class="nv">source = </span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">source</span>
      <span class="nv">source = </span><span class="s2">&quot;&quot;</span>
  <span class="nx">result</span>

<span class="nb">String</span><span class="o">::</span><span class="nv">beginsWith = </span><span class="nf">(str) -&gt;</span> <span class="k">if</span> <span class="nx">@match</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s2">&quot;^#{str}&quot;</span><span class="p">)</span> <span class="k">then</span> <span class="kc">true</span> <span class="k">else</span> <span class="kc">false</span>
<span class="nb">String</span><span class="o">::</span><span class="nv">endsWith = </span><span class="nf">(str) -&gt;</span> <span class="k">if</span> <span class="nx">@match</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s2">&quot;#{str}$&quot;</span><span class="p">)</span> <span class="k">then</span> <span class="kc">true</span> <span class="k">else</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Use the node.js path module to pull the file extension from the path.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">extname = </span><span class="nf">(path) -&gt;</span>
  <span class="nx">path_module</span><span class="p">.</span><span class="nx">extname</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>THE CHANCE PARSER</p>

<p>The parser will not bother splitting into tokens. We are <em>a</em>
step up from Regular Expressions, not a thousand steps.</p>

<p>In short, we keep track of two things: { } and strings.</p>

<p>Other than that, we look for @theme, slices(), and slice(),
in their various forms.</p>

<p>Our method is to scan until we hit a delimiter followed by any
of the following:</p>

<ul>
<li>@theme</li>
<li>@include slices(</li>
<li>slices(</li>
<li>slice(</li>
</ul>

<h2>Options</h2>

<p>You may pass a few configuration options to a Chance instance:</p>

<ul>
<li>:theme: a selector that will make up the initial value of the $theme
variable. For example: :theme => "ace.test-controls"</li>
</ul>

<h2>How Slice &amp; Slices work</h2>

<p>@include slice() and @include slices() are not actually responsible
for slicing the image. They do not know the image's width or height.</p>

<p>All that they do is determine the slice's configuration, including
its file name, the rectangle to slice, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ChanceParser</span>
  <span class="nv">constructor: </span><span class="nf">(@input, @opts={theme:&quot;&quot;}) -&gt;</span>
    <span class="vi">@path = </span><span class="s2">&quot;&quot;</span>
    <span class="vi">@css = </span><span class="s2">&quot;&quot;</span>
    <span class="vi">@scanner = </span><span class="kc">null</span>
    <span class="vi">@image_names = </span><span class="p">{}</span>

    <span class="nx">@opts</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@opts</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">@opts</span>

    <span class="vi">@slices = </span><span class="nx">@opts</span><span class="p">[</span><span class="s2">&quot;slices&quot;</span><span class="p">]</span>  <span class="c1"># we update the slices given to us</span>
    <span class="vi">@theme = </span><span class="nx">@opts</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span>

  <span class="vi">@UNTIL_SINGLE_QUOTE: </span><span class="sr">/(?!\\)&#39;/</span>
  <span class="vi">@UNTIL_DOUBLE_QUOTE: </span><span class="sr">/(?!\\)&quot;/</span>
  <span class="vi">@BEGIN_SCOPE: </span><span class="sr">/\{/</span>
  <span class="vi">@END_SCOPE: </span><span class="sr">/\}/</span>
  <span class="vi">@THEME_DIRECTIVE: </span><span class="sr">/@theme\s*/</span>
  <span class="vi">@SELECTOR_THEME_VARIABLE: </span><span class="sr">/\$theme(?=[^\w:-])/</span>
  <span class="vi">@INCLUDE_SLICES_DIRECTIVE: </span><span class="sr">/@include\s+slices\s*/</span>
  <span class="vi">@INCLUDE_SLICE_DIRECTIVE: </span><span class="sr">/@include\s+slice\s*/</span>
  <span class="vi">@CHANCE_FILE_DIRECTIVE: </span><span class="sr">/@_chance_file /</span>
  <span class="vi">@NORMAL_SCAN_UNTIL: </span><span class="sr">/[^{}@$]+/</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>SLICE MANAGEMENT</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">create_slice: </span><span class="nf">(opts) -&gt;</span>
    <span class="nv">filename = </span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>get current relative path</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">relative = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">@path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Create a path</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">path = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">relative</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span>
    <span class="nv">path = </span><span class="nx">path</span><span class="p">[</span><span class="mi">2</span><span class="p">...</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">if</span> <span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">1</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;./&quot;</span>

    <span class="nx">opts</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">path</span>
    <span class="nv">opts = </span><span class="nx">@normalize_rectangle</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>

    <span class="nv">slice_path = </span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">...(</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">extname</span><span class="p">(</span><span class="nx">filename</span><span class="p">).</span><span class="nx">length</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>we add a bit to the path: the slice info</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">rect_params = </span><span class="p">[</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_x&quot;</span><span class="p">,</span> <span class="s2">&quot;offset_y&quot;</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Generate string-compatible params</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">slice_name_params = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">rect_params</span>
      <span class="nx">slice_name_params</span><span class="p">.</span><span class="nx">push</span> <span class="nx">opts</span><span class="p">[</span><span class="nx">param</span><span class="p">]</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span>
    <span class="nx">slice_name_params</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">slice_path</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>validate and convert to integers</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">rect_params</span>
      <span class="nv">value = </span><span class="nx">opts</span><span class="p">[</span><span class="nx">param</span><span class="p">]</span>
      <span class="nx">opts</span><span class="p">[</span><span class="nx">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="k">if</span> <span class="nx">value</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>it is too expensive to open the images and get their sizes at this point, though
I rather would like to.transform the rectangle into absolute coordinates
(left top width height) and use that instead of showing all six digits.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">slice_path = </span><span class="p">(</span><span class="s2">&quot;#{param}&quot;</span> <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">slice_name_params</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">slice_path</span> <span class="k">of</span> <span class="nx">@slices</span>
      <span class="nv">slice = </span><span class="nx">@slices</span><span class="p">[</span><span class="nx">slice_path</span><span class="p">]</span>
      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;min_offset_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="p">[</span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;min_offset_x&quot;</span><span class="p">],</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;offset_x&quot;</span><span class="p">]]...</span>
      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;min_offset_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="p">[</span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;min_offset_y&quot;</span><span class="p">],</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;offset_y&quot;</span><span class="p">]]...</span>

      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;max_offset_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="p">[</span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;max_offset_x&quot;</span><span class="p">],</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;offset_x&quot;</span><span class="p">]]...</span>
      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;max_offset_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="p">[</span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;max_offset_y&quot;</span><span class="p">],</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;offset_y&quot;</span><span class="p">]]...</span>
    <span class="k">else</span>
      <span class="nv">modified_path = </span><span class="s2">&quot;#{@opts[&quot;</span><span class="nx">instance_id</span><span class="s2">&quot;]}&quot;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^a-zA-Z0-9]/</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nx">slice_path</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^a-zA-Z0-9]/</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
      <span class="nv">css_name = </span><span class="s2">&quot;__chance_slice_#{modified_path}&quot;</span>

      <span class="nv">newOpts =</span>
        <span class="nv">name: </span><span class="nx">slice_path</span>
        <span class="nv">path: </span><span class="nx">path</span>
        <span class="nv">css_name: </span><span class="nx">css_name</span>
        <span class="nv">min_offset_x: </span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;offset_x&quot;</span><span class="p">]</span> <span class="c1"># these will be taken into account when spriting.</span>
        <span class="nv">min_offset_y: </span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;offset_y&quot;</span><span class="p">]</span>
        <span class="nv">max_offset_x: </span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;offset_x&quot;</span><span class="p">]</span>
        <span class="nv">max_offset_y: </span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;offset_y&quot;</span><span class="p">]</span>
        <span class="nv">imaged_offset_x: </span><span class="mi">0</span> <span class="c1"># the imaging process will re-define these.</span>
        <span class="nv">imaged_offset_y: </span><span class="mi">0</span>
        <span class="nv">used_by: </span><span class="p">[]</span>

      <span class="nx">opts</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">newOpts</span>

      <span class="nv">slice = </span><span class="nx">opts</span>

      <span class="nx">@slices</span><span class="p">[</span><span class="nx">slice_path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">slice</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Register target path with this slice.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;used_by&quot;</span><span class="p">].</span><span class="nx">push</span> <span class="p">{</span> <span class="nv">path: </span><span class="nx">@path</span> <span class="p">}</span>
    <span class="nx">slice</span>

  <span class="nv">normalize_rectangle: </span><span class="nf">(rect) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>try to make the rectangle somewhat standard: that is, make it have
all units which make sense</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>it must have either a left or a right, no matter what</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>if there is no width, it must have a both left and right</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>it must have either a top or a bottom, no matter what</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>if there is no height, it must have <em>both</em> top and bottom</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">?</span>

    <span class="nx">rect</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h2>PARSING</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parse: </span><span class="o">-&gt;</span>
    <span class="vi">@scanner = </span><span class="k">new</span> <span class="nx">StringScanner</span><span class="p">(</span><span class="nx">@input</span><span class="p">)</span>
    <span class="vi">@image_names = </span><span class="p">{}</span>
    <span class="vi">@css = </span><span class="nx">@_parse</span><span class="p">()</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">@scanner</span><span class="p">.</span><span class="nx">hasTerminated</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>how do we do an error?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Found end of block; expecting end of file.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>_parse will parse until it finds either the end or until it finds
an unmatched ending brace. An unmatched ending brace is assumed
to mean that this is a recursive call.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_parse: </span><span class="o">-&gt;</span>
    <span class="nv">scanner = </span><span class="nx">@scanner</span>

    <span class="nv">output = </span><span class="p">[]</span>

    <span class="k">while</span> <span class="o">not</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">hasTerminated</span><span class="p">()</span>
      <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@handle_empty</span><span class="p">()</span>
      <span class="k">break</span> <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">hasTerminated</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>console.log 'rem', scanner.getPosition()</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">BEGIN_SCOPE</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@handle_scope</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">THEME_DIRECTIVE</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@handle_theme</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">SELECTOR_THEME_VARIABLE</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@handle_theme_variable</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">INCLUDE_SLICES_DIRECTIVE</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@handle_slices</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">INCLUDE_SLICE_DIRECTIVE</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@handle_slice_include</span><span class="p">()</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">CHANCE_FILE_DIRECTIVE</span>
        <span class="nx">@handle_file_change</span><span class="p">()</span>

      <span class="k">break</span> <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">END_SCOPE</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>skip over anything that our tokens do not start with</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">res = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">NORMAL_SCAN_UNTIL</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">res</span><span class="o">?</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scanChar</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="nx">res</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>console.log 'output', output.length</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">output = </span><span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nx">output</span>

  <span class="nv">handle_comment: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>console.log 'handle_comment'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scanChar</span><span class="p">()</span> <span class="c1"># /</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scanChar</span><span class="p">()</span> <span class="c1"># *</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scanUntil</span> <span class="sr">/\*\//</span>

  <span class="nv">parse_string: </span><span class="nf">(cssString) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>console.log 'parse_string', cssString, 'that was cssString'
I cheat: to parse strings, I use JSON.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">cssString</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;&#39;&quot;</span> <span class="c1">#[TODO] indices?</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>We should still be able to use json to parse single-quoted strings
if we replace the quotes with double-quotes. The methodology should
be identical so long as we replace any unescaped quotes...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">cssString = </span><span class="s2">&quot;\&quot;#{cssString[1...cssString.length-1].replace(/^&quot;</span><span class="o">|</span><span class="p">([</span><span class="o">^</span><span class="err">\\</span><span class="p">]</span><span class="s2">&quot;)/, &#39;\1\\&quot;</span><span class="s1">&#39;)}\&quot;&quot;</span>

<span class="s1">#DIVIDER</span>
<span class="s1">    else if cssString[0..0] isnt &#39;</span><span class="s2">&quot;&#39;</span>

<span class="s2">#DIVIDER</span>
<span class="s2">      return cssString</span>


<span class="s2">#DIVIDER</span>
<span class="s2">    JSON.parse(&quot;</span><span class="p">[</span><span class="c1">#{cssString}]&quot;)[0]</span>

  <span class="nv">handle_string: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>console.log 'replaced single with double quotes:', cssString</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span>

    <span class="nv">str = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">scanChar</span><span class="p">()</span>
    <span class="nx">str</span> <span class="o">+=</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scanUntil</span><span class="p">(</span><span class="k">if</span> <span class="nx">str</span> <span class="o">is</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">then</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">UNTIL_SINGLE_QUOTE</span> <span class="k">else</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">UNTIL_DOUBLE_QUOTE</span><span class="p">)</span>
    <span class="nx">str</span>

  <span class="nv">handle_empty: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>console.log 'ERROR string is not delimited by quotes!', cssString # This is not an error -- if not in quotes, just return cssString.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span>
    <span class="nv">output = </span><span class="s2">&quot;&quot;</span>

    <span class="k">while</span> <span class="kc">true</span> <span class="c1"># [TODO] do? break? next statements were removed, and else if statements added</span>
      <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="sr">/\s+/</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\s+/</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="sr">/\/\//</span>
        <span class="nx">scanner</span><span class="p">.</span><span class="nx">scanUntil</span> <span class="sr">/\n/</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span> <span class="sr">/\/\*/</span>
        <span class="nx">@handle_comment</span><span class="p">()</span>
        <span class="k">continue</span>
      <span class="k">break</span>

    <span class="nx">output</span>

  <span class="nv">handle_scope: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>console.log 'JSON parsed string', JSON.parse("[#{cssString}]")[0]</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span>

    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\{/</span>

    <span class="nv">output = </span><span class="s1">&#39;{&#39;</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@_parse</span><span class="p">()</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="s1">&#39;}&#39;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Expected end of block.&quot;</span> <span class="nx">unless</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\}/</span>

    <span class="nx">output</span>

  <span class="nv">handle_theme: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>console.log 'handle_string'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">THEME_DIRECTIVE</span>

    <span class="nv">theme_name = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\((.+?)\)\s*/</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">theme_name</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Expected (theme-name) after @theme&quot;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Expected { after @theme.&quot;</span> <span class="nx">unless</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\{/</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>console.log 'handle_empty'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">old_theme = </span><span class="nx">@theme</span>
    <span class="vi">@theme = </span><span class="nx">old_theme</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">theme_name</span>

    <span class="nv">output = </span><span class="s2">&quot;&quot;</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n$theme: &#39;#{@theme}&#39;;\n&quot;</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@_parse</span><span class="p">()</span>

    <span class="vi">@theme = </span><span class="nx">old_theme</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;$theme: &#39;#{@theme}&#39;;\n&quot;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Expected end of block.&quot;</span> <span class="nx">unless</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\}/</span>
    <span class="nx">output</span>

  <span class="nv">handle_theme_variable: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>console.log 'handle_scope'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">SELECTOR_THEME_VARIABLE</span>

    <span class="nv">output = </span><span class="s2">&quot;\#{$theme}&quot;</span> <span class="c1"># [TODO] Careful, this is literal.</span>
    <span class="nx">output</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>console.log 'handle_theme'</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handle_file_change: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>calculate new theme name</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="nx">ChanceParser</span><span class="p">.</span><span class="nx">CHANCE_FILE_DIRECTIVE</span>

    <span class="nv">path = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">scanUntil</span> <span class="sr">/;/</span>
    <span class="nv">path = </span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>console.log 'handle<em>theme</em>variable'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@path = </span><span class="nx">path</span>

  <span class="nv">parse_argument: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>when we receive a @<em>chance</em>file directive, it means that our current file
scope has changed. We need to know this because we parse the combined file
rather than the individual pieces, yet we have paths relative to the original
files.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>console.log 'handle<em>file</em>change'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@handle_empty</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>console.log 'path', path</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">value = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>console.log 'parse_argument'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">parsing_value = </span><span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>We do not care for whitespace or comments</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">key = </span><span class="s2">&quot;no_key&quot;</span>
    <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="sr">/\$/</span><span class="p">)</span>
      <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\$/</span>

      <span class="nx">@handle_empty</span><span class="p">()</span>
      <span class="nv">parsing_value = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span><span class="p">(</span><span class="sr">/[a-zA-Z_-][a-zA-Z0-9+_-]*/</span><span class="p">)</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Expected a valid key.&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">parsing_value</span><span class="o">?</span> <span class="c1"># [TODO] Why if not key? in Ruby code? Look at Ruby Chance.</span>

      <span class="nx">@handle_empty</span><span class="p">()</span>

      <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span><span class="p">(</span><span class="sr">/:/</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>this is the final value; we won't actually set it until
the very end.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">key = </span><span class="nx">parsing_value</span> <span class="c1"># [TODO] In ruby, was key = parsing_value.intern; that just converts key to string, apparently.</span>
        <span class="nv">parsing_value = </span><span class="s2">&quot;&quot;</span>

        <span class="nx">@handle_empty</span><span class="p">()</span>

    <span class="nv">value = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>this holds the value as we are parsing it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">parsing_value</span> <span class="o">+=</span> <span class="nx">@handle_empty</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>The key MAY be present if we are starting with a $.
But remember: it could be $abc: $abc + $def</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">until</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="sr">/[,)]/</span><span class="p">)</span> <span class="o">or</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">hasTerminated</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="sr">/[&quot;&#39;]/</span><span class="p">)</span>
        <span class="nx">parsing_value</span> <span class="o">+=</span> <span class="nx">@handle_string</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>ok, it was a key</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">parsing_value</span> <span class="o">+=</span> <span class="nx">@handle_empty</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>we stop when we either a) reach the end of the arglist, or
b) reach the end of the argument. Argument ends at ',', list ends
at ')'</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">continue</span>

      <span class="nx">parsing_value</span> <span class="o">+=</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scanChar</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>console.log 'parsing<em>value</em>1', parsing_value</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">parsing_value</span> <span class="o">+=</span> <span class="nx">@handle_empty</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>console.log 'parsing<em>value</em>2', parsing_value</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">value = </span><span class="nx">parsing_value</span> <span class="nx">unless</span> <span class="nx">parsing_value</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>console.log 'parsing<em>value</em>3', parsing_value</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">{</span> <span class="nv">key: </span><span class="nx">key</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">value</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>console.log 'parsing<em>value</em>4', parsing_value</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parse_argument_list: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>console.log 'parsing<em>value</em>5', parsing_value</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">scanner = </span><span class="nx">@scanner</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Expected ( to begin argument list.&quot;</span> <span class="nx">unless</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\(/</span>

    <span class="nv">idx = </span><span class="mi">0</span>
    <span class="nv">args = </span><span class="p">{}</span>
    <span class="nx">until</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="sr">/\)/</span><span class="p">)</span> <span class="o">or</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">hasTerminated</span><span class="p">()</span>
      <span class="nv">arg = </span><span class="nx">@parse_argument</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">arg</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;no_key&quot;</span>
        <span class="nx">arg</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">idx</span>
        <span class="nx">idx</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>console.log "key: #{key}, value: #{value}"</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">args</span><span class="p">[</span><span class="nx">arg</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">].</span><span class="nx">trim</span><span class="p">()</span>

      <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/,/</span>

    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/\)/</span>

    <span class="nx">args</span>

  <span class="nv">generate_slice_include: </span><span class="nf">(slice) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Parses a list of arguments, INCLUDING beginning AND ending parentheses.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0 0&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;no-repeat&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>console.log 'parse<em>argument</em>list'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">offset = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">].</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span> <span class="c1"># [TODO] does javascript split take re?</span>
    <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;offset_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;offset_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nv">slice = </span><span class="nx">@create_slice</span> <span class="nx">slice</span>

    <span class="nv">output = </span><span class="s2">&quot;&quot;</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;@extend .#{slice[&quot;</span><span class="nx">css_name</span><span class="s2">&quot;].replace(/\//g, &#39;|&#39;)};\n&quot;</span> <span class="c1"># [TODO] hack to replace / with |, because stylus errors on /</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>console.log "key: #{arg['key']}, value: #{arg['value']}"</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\t  -chance-offset: \&quot;#{slice[&quot;</span><span class="nx">name</span><span class="s2">&quot;]}\&quot; #{offset[0]} #{offset[1]};\n&quot;</span> <span class="c1"># [TODO] Fix missing indent and also \n in Ruby Chance.</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\t  background-repeat: #{slice[&quot;</span><span class="nx">repeat</span><span class="s2">&quot;]}&quot;</span>
    <span class="nx">output</span>
    
  <span class="nv">handle_slice_include: </span><span class="o">-&gt;</span>
    <span class="nv">scanner = </span><span class="nx">@scanner</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/@include slice\s*/</span>

    <span class="nv">slice = </span><span class="nx">@parse_argument_list</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>The argument list is rather raw. We need to combine it with default values,
and preprocess any arguments, before we can call create_slice to get the real
slice definition.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@parse_string</span> <span class="nx">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>The offset will be given to us as one string; however, it has two parts.
splitting by whitespace doesn't handle everything, so we may want to refine
this at some point unless we could just pass the whole offset to the offset
function somehow.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@generate_slice_include</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span>

  <span class="nv">should_include_slice: </span><span class="nf">(slice) -&gt;</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span><span class="o">?</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="o">?</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="kc">true</span>

  <span class="nv">slice_layout: </span><span class="nf">(slice)-&gt;</span>
    <span class="nv">output = </span><span class="s2">&quot;&quot;</span>

    <span class="nv">layout_properties = </span><span class="p">[</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span> <span class="p">]</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">layout_properties</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">layout_properties</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">layout_properties</span>
      <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span><span class="o">?</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;  #{prop}: #{slice[prop]}px; \n&quot;</span> <span class="c1"># [TODO] Added two leading spaces</span>

    <span class="nx">output</span>

  <span class="nv">handle_slices: </span><span class="o">-&gt;</span>
    <span class="nv">scanner = </span><span class="nx">@scanner</span>
    <span class="nx">scanner</span><span class="p">.</span><span class="nx">scan</span> <span class="sr">/@include slices\s*/</span>

    <span class="nv">arguments = </span><span class="nx">@parse_argument_list</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>We prefix with -chance; this should let everything be passed through more
or less as-is. Postprocessing will turn it into -background-position.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="p">[</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span> <span class="p">]</span>
      <span class="nx">arguments</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="nv">values = </span><span class="nx">arguments</span><span class="p">.</span><span class="nx">values</span>

    <span class="nv">left = </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
    <span class="nv">top = </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span>
    <span class="nv">right = </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span>
    <span class="nv">bottom = </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>the image could be quoted or not; in any case, use parse_string to
parse it. Sure, at the moment, we don't parse quoted strings properly,
but it should work for most cases. single-quoted strings are out, though...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">fill = </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;fill&quot;</span><span class="p">]</span> <span class="o">?</span> <span class="s2">&quot;1 0&quot;</span>
    <span class="nv">fill = </span><span class="nx">fill</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">)</span>
    <span class="nv">fill_width = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nv">fill_height = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">fill</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>now that we have all of the info, we can get the actual slice information.
This process will create a slice entry if needed.
console.log 'handle<em>slice</em>include'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">skip = </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;skip&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">skip</span><span class="o">?</span>
      <span class="nv">skip = </span><span class="p">[]</span>
    <span class="k">else</span>
      <span class="nv">skip = </span><span class="nx">skip</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\s+/</span>

    <span class="nv">skip_top_left = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;top-left&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>
    <span class="nv">skip_top = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>
    <span class="nv">skip_top_right = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;top-right&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>

    <span class="nv">skip_left = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>
    <span class="nv">skip_middle = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>
    <span class="nv">skip_right = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>

    <span class="nv">skip_bottom_left = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;bottom-left&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>
    <span class="nv">skip_bottom = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>
    <span class="nv">skip_bottom_right = </span><span class="nx">skip</span><span class="p">[</span><span class="s1">&#39;bottom-right&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>

    <span class="nv">filename = </span><span class="nx">@parse_string</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>slices() only supports four-param, left top right bottom rectangles.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>determine fill method</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">top_left_slice =</span>
      <span class="nv">left: </span><span class="mi">0</span>
      <span class="nv">top: </span><span class="mi">0</span>
      <span class="nv">width: </span><span class="nx">left</span>
      <span class="nv">height: </span><span class="nx">top</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-left-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-left-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-left-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>

    <span class="nv">left_slice =</span>
      <span class="nv">left: </span><span class="mi">0</span>
      <span class="nv">top: </span><span class="nx">top</span>
      <span class="nv">width: </span><span class="nx">left</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;left-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;left-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;left-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>
      <span class="nv">repeat: </span><span class="k">if</span> <span class="nx">fill_height</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="s2">&quot;repeat-y&quot;</span> <span class="c1"># [TODO] using null where nil was in ruby</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>skip control</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">bottom_left_slice =</span>
      <span class="nv">left: </span><span class="mi">0</span>
      <span class="nv">bottom: </span><span class="mi">0</span>
      <span class="nv">width: </span><span class="nx">left</span>
      <span class="nv">height: </span><span class="nx">bottom</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-left-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-left-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-left-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>

    <span class="nv">top_slice =</span>
      <span class="nv">left: </span><span class="nx">left</span>
      <span class="nv">top: </span><span class="mi">0</span>
      <span class="nv">height: </span><span class="nx">top</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>
      <span class="nv">repeat: </span><span class="k">if</span> <span class="nx">fill_width</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="s2">&quot;repeat-x&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>we are going to form 9 slices. If any are empty we'll skip them</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">middle_slice =</span>
      <span class="nv">left: </span><span class="nx">left</span>
      <span class="nv">top: </span><span class="nx">top</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;middle-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;middle-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;middle-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>
      <span class="nv">repeat: </span><span class="k">if</span> <span class="nx">fill_height</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="k">then</span> <span class="p">(</span><span class="k">if</span> <span class="nx">fill_width</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="k">then</span> <span class="s2">&quot;repeat&quot;</span> <span class="k">else</span> <span class="s2">&quot;repeat-y&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="k">if</span> <span class="nx">fill_width</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="k">then</span> <span class="s2">&quot;repeat-x&quot;</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>top-left</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">bottom_slice =</span>
      <span class="nv">left: </span><span class="nx">left</span>
      <span class="nv">bottom: </span><span class="mi">0</span>
      <span class="nv">height: </span><span class="nx">bottom</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>
      <span class="nv">repeat: </span><span class="k">if</span> <span class="nx">fill_width</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="s2">&quot;repeat-x&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>we fill in either height or bottom, depending on fill</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">top_right_slice =</span>
      <span class="nv">right: </span><span class="mi">0</span>
      <span class="nv">top: </span><span class="mi">0</span>
      <span class="nv">width: </span><span class="nx">right</span>
      <span class="nv">height: </span><span class="nx">top</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-right-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-right-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;top-right-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>

    <span class="nv">right_slice =</span>
      <span class="nv">right: </span><span class="mi">0</span>
      <span class="nv">top: </span><span class="nx">top</span>
      <span class="nv">width: </span><span class="nx">right</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;right-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;right-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;right-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>
      <span class="nv">repeat: </span><span class="k">if</span> <span class="nx">fill_height</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="s2">&quot;repeat-y&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>we fill in either width or right, depending on fill</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">bottom_right_slice =</span>
      <span class="nv">right: </span><span class="mi">0</span>
      <span class="nv">bottom: </span><span class="mi">0</span>
      <span class="nv">width: </span><span class="nx">right</span>
      <span class="nv">height: </span><span class="nx">bottom</span>
      <span class="nv">sprite_anchor: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-right-anchor&quot;</span><span class="p">]</span>
      <span class="nv">sprite_padding: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-right-padding&quot;</span><span class="p">]</span>
      <span class="nv">offset: </span><span class="nx">arguments</span><span class="p">[</span><span class="s2">&quot;bottom-right-offset&quot;</span><span class="p">]</span>
      <span class="nv">filename: </span><span class="nx">filename</span>

    <span class="k">if</span> <span class="nx">fill_width</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nx">top_slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">right</span>
      <span class="nx">middle_slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">right</span>
      <span class="nx">bottom_slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">right</span>
    <span class="k">else</span>
      <span class="nx">top_slice</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fill_width</span>
      <span class="nx">middle_slice</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fill_width</span>
      <span class="nx">bottom_slice</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fill_width</span>

    <span class="k">if</span> <span class="nx">fill_height</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nx">left_slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bottom</span>
      <span class="nx">middle_slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bottom</span>
      <span class="nx">right_slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bottom</span>
    <span class="k">else</span>
      <span class="nx">left_slice</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fill_height</span>
      <span class="nx">middle_slice</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fill_height</span>
      <span class="nx">right_slice</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fill_height</span>

    <span class="nv">output = </span><span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>fill in width, height or right, bottom depending on fill settings</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">top_left_slice</span>  <span class="c1"># [TODO] in ruby was, should_include_slice?(top_left_slice), but it is just a boolean call?</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .top-left {\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>we fill in width or right depending on fill settings</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_top_left</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include top_left_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">top_left_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span>

    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">left_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .left {\n&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_left</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include left_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">left_slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bottom</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">left_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span>

    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">bottom_left_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .bottom-left {\n&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_bottom_left</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include bottom_left_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">bottom_left_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>we fill in either height or top depending on fill settings</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">top_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .top {\n&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_top</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include top_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">top_slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">right</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">top_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span>

    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">middle_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .middle {\n&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_middle</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include middle_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">middle_slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bottom</span>
      <span class="nx">middle_slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">right</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">middle_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span>

    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">bottom_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .bottom {\n&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_bottom</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include bottom_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">bottom_slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">right</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">bottom_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>LEFT
NOTE: we write it even if we are supposed to skip; we only wrap the slice include portion in </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">top_right_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .top-right {\n&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_top_right</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include top_right_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">top_right_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span>

    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">right_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .right {\n&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_right</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include right_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">right_slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bottom</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">right_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span>

    <span class="k">if</span> <span class="nx">@should_include_slice</span> <span class="nx">bottom_right_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;&amp; &gt; .bottom-right {\n&quot;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">skip_bottom_right</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;#{@generate_slice_include bottom_right_slice};&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n  position: absolute;\n&quot;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="nx">@slice_layout</span> <span class="nx">bottom_right_slice</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;}\n&quot;</span>

    <span class="nx">output</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>IF we are skipping the top left slice, we don't want the actual slice include-- but the layout
information we still want. So, only bracket the generate<em>slice</em>include.</p>

<p>Potential issue: slice_layout doesn't handle repeat settings. In theory, this should rarely be
an issue (because you aren't setting a background for the skipped slice.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ChanceProcessor</span>
  <span class="vi">@CHANCE_FILES =</span>
    <span class="s2">&quot;chance.css&quot;</span><span class="o">:</span>
      <span class="nv">method: </span><span class="s2">&quot;css&quot;</span>
    <span class="s2">&quot;chance@2x.css&quot;</span><span class="o">:</span>
      <span class="nv">method: </span><span class="s2">&quot;css&quot;</span>
      <span class="nv">x2: </span><span class="kc">true</span>
    <span class="s2">&quot;chance-sprited.css&quot;</span><span class="o">:</span>
      <span class="nv">method: </span><span class="s2">&quot;css&quot;</span>
      <span class="nv">sprited: </span><span class="kc">true</span>
    <span class="s2">&quot;chance-sprited@2x.css&quot;</span><span class="o">:</span>
      <span class="nv">method: </span><span class="s2">&quot;css&quot;</span>
      <span class="nv">sprited: </span><span class="kc">true</span>
      <span class="nv">x2: </span><span class="kc">true</span>
    <span class="s2">&quot;chance-test.css&quot;</span><span class="o">:</span>       <span class="c1"># For Testing Purposes...</span>
      <span class="nv">method: </span><span class="s2">&quot;chance_test&quot;</span>

  <span class="vi">@uid: </span><span class="mi">0</span>
  <span class="vi">@generation: </span><span class="mi">0</span>

  <span class="nv">constructor: </span><span class="nf">(chance, options={}) -&gt;</span>
    <span class="vi">@chance = </span><span class="nx">chance</span>
    <span class="vi">@options = </span><span class="p">{}</span>
    <span class="nx">@options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">options</span>
    <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span> <span class="o">?=</span> <span class="s2">&quot;&quot;</span>
    <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;pad_sprites_for_debugging&quot;</span><span class="p">]</span> <span class="o">?=</span> <span class="kc">true</span>
    <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;optimize_sprites&quot;</span><span class="p">]</span> <span class="o">?=</span> <span class="kc">true</span>
    <span class="k">if</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">isnt</span> <span class="s2">&quot;.&quot;</span>
      <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.#{options[&quot;</span><span class="nx">theme</span><span class="s2">&quot;]}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>MIDDLE</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ChanceProcessor</span><span class="p">.</span><span class="nx">uid</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="vi">@uid = </span><span class="nx">ChanceProcessor</span><span class="p">.</span><span class="nx">uid</span>
    <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">@uid</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>RIGHT</p>             </td>             <td class="code">               <div class="highlight"><pre>      </pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>In a SproutCore package, a ChanceProcessor "instance" would likely be a language folder.</p>

<p>An instance has a list of files (instance-relative paths mapped
to paths already registered). This collection of files
should include CSS files, image files, and any other kind of file
needed to generate the output.</p>

<p>When you call update(), ChanceProcessor will process everything (or
re-process it) and put the result in its "css" property.</p>

<p>NOTE: The x2 machinery is for retina displays.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@mapped_files = </span><span class="p">{}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>console.log 'cssTheme', @options["theme"]</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@file_mtimes = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>console.log 'options[instance<em>id] is', @options["instance</em>id"]</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@files = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>The mapped files are a map from file names in the ChanceProcessor instance to
their identifiers in the system.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@slices = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>The file mtimes are a collection of mtimes for all the files we have. Each time we
read a file we record the mtime, and then we compare on check<em>all</em>files</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@has_rendered = </span><span class="kc">false</span>
      </pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>The @files set is a set cached generated output files, used by the output_for
method.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@render_cycle = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>The @slices hash maps slice names to hashes defining the slices. As the
processing occurs, the slice hashes may contain actual sliced image canvases,
may be 2x or 1x versions, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@cssParsed = </span><span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Tracks whether _render has been called.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">map_file: </span><span class="nf">(path, identifier) -&gt;</span>
    <span class="k">if</span> <span class="nx">@mapped_files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">is</span> <span class="nx">identifier</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>A generation number for the current render. This allows the slicing and spriting
to be invalidated smartly.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span>
      
    <span class="nv">path = </span><span class="s2">&quot;#{path}&quot;</span> <span class="c1"># [TODO] doesn&#39;t this accomplish a conversion to string?</span>
    <span class="nv">file = </span><span class="nx">@chance</span><span class="p">.</span><span class="nx">has_file</span><span class="p">(</span><span class="nx">identifier</span><span class="p">)</span>

    <span class="k">new</span> <span class="nx">FileNotFoundError</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">message</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">file</span><span class="o">?</span>

    <span class="nx">@mapped_files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">identifier</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>The parsed css.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@clean</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>maps a path relative to the instance to a file identifier
registered with chance via ChanceProcessor.addFile.</p>

<p>If a ChanceProcessor instance represents a SproutCore language folder,
the relative path would be the path inside of that folder.
The identifier would be a name of a file that you added to
to the system using add_file.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unmap_file: </span><span class="nf">(path) -&gt;</span>
    <span class="k">if</span> <span class="nx">path</span> <span class="o">not</span> <span class="k">of</span> <span class="nx">@mapped_files</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Don't do anything if there is nothing to do.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span>
    
    <span class="nv">path = </span><span class="s2">&quot;#{path}&quot;</span>
    <span class="nx">@mapped_files</span><span class="p">.</span><span class="k">delete</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Invalidate our render because things have changed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@clean</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>unmaps a path from its identifier. In short, removes a file
from this ChanceProcessor instance. The file will remain in the system's "virtual filesystem".</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unmap_all: </span><span class="o">-&gt;</span>
    <span class="vi">@mapped_files = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Don't do anything if there is nothing to do</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">check_all_files: </span><span class="o">-&gt;</span>
    <span class="nv">needs_clean = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">p</span><span class="p">,</span><span class="nx">f</span> <span class="k">of</span> <span class="nx">@mapped_files</span>
      <span class="nv">mtime = </span><span class="nx">@chance</span><span class="p">.</span><span class="nx">update_file_if_needed</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@file_mtimes</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span><span class="o">?</span> <span class="o">or</span> <span class="nx">mtime</span> <span class="o">&gt;</span> <span class="nx">@file_mtimes</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span>
        <span class="nv">needs_clean = </span><span class="kc">true</span>
    
    <span class="nx">@clean</span><span class="p">()</span> <span class="k">if</span> <span class="nx">needs_clean</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Invalidate our render because things have changed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_file: </span><span class="nf">(path) -&gt;</span>
    <span class="k">new</span> <span class="nx">FileNotFoundError</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">message</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">path</span> <span class="k">of</span> <span class="nx">@mapped_files</span>
    <span class="nx">@chance</span><span class="p">.</span><span class="nx">get_file</span><span class="p">(</span><span class="nx">@mapped_files</span><span class="p">[</span><span class="nx">path</span><span class="p">])</span>

  <span class="nv">output_for: </span><span class="nf">(file) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;output_for&#39;</span><span class="p">,</span> <span class="nx">@chance</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span><span class="o">?</span><span class="p">,</span> <span class="nx">file</span>
    <span class="k">return</span> <span class="nx">@chance</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@chance</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>unmaps all files</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">x2 = </span><span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s2">&quot;@2x&quot;</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="kc">true</span> <span class="k">else</span> <span class="kc">false</span>

    <span class="nv">opts = </span><span class="nx">ChanceProcessor</span><span class="p">.</span><span class="nx">CHANCE_FILES</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">opts</span><span class="o">?</span>
      <span class="err">@</span><span class="p">[</span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]]</span> <span class="nx">opts</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@sprite_names</span><span class="p">({</span> <span class="nv">x2: </span><span class="nx">x2</span> <span class="p">})</span>
      <span class="k">return</span> <span class="nx">@sprite_data</span><span class="p">({</span> <span class="nv">name: </span><span class="nx">file</span><span class="p">,</span> <span class="nv">x2: </span><span class="nx">x2</span> <span class="p">})</span>
    <span class="k">else</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;ChanceProcessor does not generate a file named &#39;#{file}&#39;&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">opts</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>checks all files to see if they have changed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">css: </span><span class="nf">(opts) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Using a path relative to this instance, gets an actual system file
hash, with any necessary preprocessing already performed. For instance,
content will have been read, and if it is an image file, will have been
loaded as an actual image.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@_render</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>small hack: we are going to determine whether it is x2 by whether it has
@2x in the name.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@slice_images</span> <span class="nx">opts</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Generates CSS output according to the options provided.</p>

<p>Possible options:</p>

<p>:x2         If true, will generate the @2x version.
  :sprited    If true, will use sprites rather than data uris.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ret = </span><span class="nx">@_postprocess_css</span> <span class="nx">opts</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>console.log 'chance css called'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ret</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>console.log 'after _render()'</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_slice: </span><span class="nf">(name) -&gt;</span>
    <span class="nx">@slices</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>console.log 'after slice_images'</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clean: </span><span class="o">-&gt;</span>
    <span class="vi">@has_rendered = </span><span class="kc">false</span>
    <span class="vi">@files = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>console.log 'after <em>postprocess</em>css', ret</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">chance_test: </span><span class="nf">(opts) -&gt;</span>
     <span class="s2">&quot;.hello { background: static_url(&#39;test.png&#39;); }&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Looks up a slice that has been found by parsing the CSS. This is used by
the Sass extensions that handle writing things like slice offset, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_render: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Cleans the current render, getting rid of all generated output.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="nx">@has_rendered</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Generates output for tests.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@render_cycle</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="vi">@files = </span><span class="p">{}</span>

    <span class="k">try</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Processes the input CSS, producing CSS ready for post-processing.
This is the first step in the ChanceProcessor build process, and is usually
called by the output_for() method. It produces a raw, unfinished CSS file.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">Chance._current_instance = </span><span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>console.log '<em>render, has</em>rendered is', @has_rendered</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">import_css = </span><span class="nx">@_preprocess</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Update the render cycle to invalidate sprites, slices, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>      </pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>console.log 'in the try'
SCSS code executing needs to know what the current instance of ChanceProcessor is,
so that lookups for slices, etc. work.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">image_css_path = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;./tmp/chance/image_css&#39;</span><span class="p">,</span> <span class="s2">&quot;#{@options[&quot;</span><span class="nx">instance_id</span><span class="s2">&quot;]}&quot;</span><span class="p">,</span> <span class="s1">&#39;_image_css.styl&#39;</span><span class="p">)</span>

      <span class="k">try</span>
        <span class="nx">mkdirp</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">path_module</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">image_css_path</span><span class="p">))</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="k">throw</span> <span class="nx">e</span>  <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">isnt</span> <span class="s2">&quot;EEXIST&quot;</span>
      
      <span class="nv">file = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">image_css_path</span><span class="p">,</span> <span class="nx">@_css_for_slices</span><span class="p">(),</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Step 1: preprocess CSS, determining order and parsing the slices out.
The output of this process is a "virtual" file that imports all of the 
SCSS files used by this ChanceProcessor instance. This also sets up the @slices hash.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>console.log 'import<em>css', import</em>css</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">cssWithImports = </span><span class="s2">&quot;@import \&quot;#{image_css_path}\&quot;;\n&quot;</span> <span class="o">+</span> <span class="nx">import_css</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Because we encapsulate with instance_id, we should not have collisions even IF another chance
instance were running at the same time (which it couldn't; if it were, there'd be MANY other issues)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">stylus</span><span class="p">.</span><span class="nx">render</span> <span class="nx">cssWithImports</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stylusResult</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
          <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="s2">&quot;ERROR: stylus &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span>
        <span class="k">else</span>
          <span class="vi">@cssParsed = </span><span class="nx">stylusResult</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>image<em>css</em>path = path<em>module.join('./tmp/chance/image</em>css', "#{@options["instance<em>id"]}", 'image</em>css') # [TODO] Is there some trick with the missing _ on image_css in Ruby Chance?</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="vi">@has_rendered = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>STEP 2: Preparing input CSS
The main CSS file we pass to the Sass Engine will have placeholder CSS for the
slices (the details will be postprocessed out).
After that, all of the individual files (using the import CSS generated in Step 1)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>[TODO] Replace #3 with ... something... stylus?</p>

<p>Step 3: Apply Sass Engine</p>

<p>console.log 'about to stylus', cssWithImports</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">catch</span> <span class="nx">err</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;ERROR in scss&#39;</span><span class="p">,</span> <span class="nx">err</span>
    <span class="k">finally</span>
      <span class="nv">Chance._current_instance = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>console.log "stylus.parse css: ", @cssParsed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_css_for_slices: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>engine = Sass::Engine.new(css, Compass.sass<em>engine</em>options.merge
 syntax: scss
 filename: "chance<em>main.css"
 cache</em>location: "./tmp/sass-cache"
 style: if @options["minify"] then compressed else expanded # [TODO] What are compressed, expanded? Ah, parameters to Compass.
)
css = engine.render()</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">output = </span><span class="p">[]</span>
    <span class="nv">slices = </span><span class="nx">@slices</span>

    <span class="k">for</span> <span class="nx">name</span><span class="p">,</span><span class="nx">slice</span> <span class="k">of</span> <span class="nx">slices</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>@css = css
@has_rendered = true</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">output = </span><span class="p">[]</span>
      <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;/* Slice #{name}, used in: \n&quot;</span>
      <span class="k">for</span> <span class="nx">used_by</span> <span class="k">in</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;used_by&quot;</span><span class="p">]</span>
        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;\t#{used_by[&quot;</span><span class="nx">path</span><span class="s2">&quot;]}\n&quot;</span>
      <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;*/\n&quot;</span>

      <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;css_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; { &quot;</span>
      <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;_sc_chance: \&quot;#{name}\&quot;;&quot;</span>
      <span class="nx">output</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;} \n&quot;</span>

    <span class="nx">output</span><span class="p">.</span><span class="nx">join</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Creates CSS for the slices to be provided to SCSS.
This CSS is incomplete; it will need postprocessing. This CSS
is generated with the set of slice definitions in @slices; the actual
slicing operation has not yet taken place. The postprocessing portion
receives sliced versions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_postprocess_css: </span><span class="nf">(opts) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>console.log '<em>css</em>for_slices'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;sprited&quot;</span><span class="p">]</span>
      <span class="nv">ret = </span><span class="nx">@postprocess_css_sprited</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nv">ret = </span><span class="nx">@postprocess_css_dataurl</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
    
    <span class="nv">ret = </span><span class="nx">@_strip_slice_class_names</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Write out comments specifying all the files the slice is used from</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_strip_slice_class_names: </span><span class="nf">(css) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>Postprocesses the CSS using either the spriting postprocessor or the
data url postprocessor, as specified by opts.</p>

<p>Opts:</p>

<p>:x2 => whether to generate @2x version.
:sprited => whether to use spriting instead of data uris.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">re = </span><span class="sr">/\.__chance_slice[^{]*?,/</span>
    <span class="nv">css = </span><span class="nx">css</span><span class="p">.</span><span class="nx">gsub</span> <span class="nx">re</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="nx">css</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>console.log '<em>postprocess</em>css'</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Strips dummy slice class names that were added to the system so that SCSS could do its magic,
but which are no longer needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">chance_header_for_file: </span><span class="nf">(file) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>console.log '<em>strip</em>slice<em>class</em>names'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">dir = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>COMBINING CSS</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Determines the "Chance Header" to add at the beginning of the file. The
Chance Header can set, for instance, the $theme variable.</p>

<p>The Chance Header is loaded from the nearest _theme.css file in this folder
or a containing folder (the file list specifically ignores such files; they are
only used for this purpose)</p>

<p>For backwards-compatibility, the fallback if no _theme.css file is present
is to return code setting $theme to the now-deprecated @options["theme"].</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">dir</span> <span class="o">isnt</span> <span class="s2">&quot;.&quot;</span>
      <span class="nv">header_file = </span><span class="nx">@mapped_files</span><span class="p">[</span><span class="nx">path_module</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="s2">&quot;_theme.css&quot;</span><span class="p">)]</span>
      <span class="k">if</span> <span class="nx">header_file</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">@get_file</span><span class="p">(</span><span class="nx">header_file</span><span class="p">)</span>
      
      <span class="nv">dir = </span><span class="nx">path_module</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>'file' is the name of a file, so we actually need to start at dirname(file)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">header_file = </span><span class="nx">@mapped_files</span><span class="p">[</span><span class="s2">&quot;_theme.css&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">@get_file</span><span class="p">(</span><span class="nx">header_file</span><span class="p">)</span> <span class="k">if</span> <span class="nx">header_file</span><span class="o">?</span>
    
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;chance_header_for_file _theme.css not found in mapped_files, so falling back.&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>console.log 'chance<em>header</em>for_file', dir</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="p">{</span> <span class="nv">mtime: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">content: </span><span class="s2">&quot;$theme: &#39;&quot;</span> <span class="o">+</span> <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;;\n&quot;</span> <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>This should not be slow, as this is just a hash lookup</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_include_file: </span><span class="nf">(file) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Make sure to look globally</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="sr">/\.css$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>mtime never changes (without a restart, at least)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p><em>include</em>file is the recursive method in the depth-first-search
that creates the ordered list of files.</p>

<p>To determine if a file is already included, we use the class variable
"generation", which we increment each pass.</p>

<p>The list is created in the variable @file_list.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="sr">/_theme\.css$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>console.log '<em>include</em>file -- does it end in .css', /.css$/.test(file)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">file = </span><span class="nx">@get_file</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>console.log 'this is a .css file alright -- is it a <em>theme.css file?', /</em>theme.css$/.test(file)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">file</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>skip _theme.css files</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="nx">ChanceProcessor</span><span class="p">.</span><span class="nx">generation</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>console.log 'no, it is not a _theme.css file'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">requires = </span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;requires&quot;</span><span class="p">]</span>

    <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;included&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ChanceProcessor</span><span class="p">.</span><span class="nx">generation</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>console.log 'get_file returned a file?', file?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">requires</span><span class="o">?</span>
      <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="nx">requires</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>console.log 'file[included] is @generation?', file["included"] is @generation</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">r = </span><span class="s2">&quot;#{r}.css&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="sr">/\.css$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>console.log 'setting requires'</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@_include_file</span><span class="p">(</span><span class="nx">@mapped_files</span><span class="p">[</span><span class="nx">r</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>console.log 'do we have any requries?', requires?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@file_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>

  <span class="nv">_convert_to_styl: </span><span class="nf">(css) -&gt;</span>
    <span class="nv">convertedLines = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">css</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
      <span class="nv">trimmed = </span><span class="nx">line</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">trimmed</span> <span class="o">is</span> <span class="s1">&#39;{&#39;</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">trimmed</span> <span class="o">is</span> <span class="s1">&#39;}&#39;</span>
      <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;\t&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
      <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;:0&#39;</span><span class="p">,</span> <span class="s1">&#39;: 0&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
      <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
      <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
      <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>Add the .css extension if needed. it is optional for sc_require</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot; progid:DXImageTransform.Microsoft.Alpha(Opacity=30)&quot;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39; progid&#39;</span><span class="p">,</span> <span class="s1">&#39; \&quot;progid&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
        <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;=30)&#39;</span><span class="p">,</span> <span class="s1">&#39;=30)\&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot; progid:DXImageTransform.Microsoft.Alpha(Opacity=40)&quot;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39; progid&#39;</span><span class="p">,</span> <span class="s1">&#39; \&quot;progid&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
        <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;=40)&#39;</span><span class="p">,</span> <span class="s1">&#39;=40)\&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot; progid:DXImageTransform.Microsoft.Alpha(Opacity=50)&quot;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39; progid&#39;</span><span class="p">,</span> <span class="s1">&#39; \&quot;progid&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
        <span class="nv">line = </span><span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;=50)&#39;</span><span class="p">,</span> <span class="s1">&#39;=50)\&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
      <span class="nx">convertedLines</span><span class="p">.</span><span class="nx">push</span> <span class="nx">line</span> <span class="k">if</span> <span class="nx">line</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>console.log 'including the require', r</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">nonBlankLines = </span><span class="p">(</span><span class="nx">line</span> <span class="k">if</span> <span class="nx">line</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">convertedLines</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">nonBlankLines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="nx">convertedLines</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>console.log 'including the file in the file_list'</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_preprocess: </span><span class="o">-&gt;</span>
    <span class="vi">@slices = </span><span class="p">{}</span>
    <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;slices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@slices</span>

    <span class="nx">ChanceProcessor</span><span class="p">.</span><span class="nx">generation</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>hacks: if the following string is unquoted, quote it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">files = </span><span class="p">(</span><span class="nx">@mapped_files</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">@mapped_files</span><span class="p">)</span> <span class="c1"># [TODO] files is not used here.</span>
    </pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>hack to check for an empty file, with only the $theme line</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>Determines the order of the files, parses them using ChanceParser,
and returns a file with an SCSS @import directive for each file.</p>

<p>It also creates and fills in the @slices hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">tmp_file_list = </span><span class="p">({</span><span class="nv">path: </span><span class="nx">p</span><span class="p">,</span> <span class="nv">file: </span><span class="nx">f</span><span class="p">}</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">p</span><span class="p">,</span><span class="nx">f</span> <span class="k">of</span> <span class="nx">@mapped_files</span><span class="p">)</span>
    <span class="nv">tmp_file_list = </span><span class="nx">_</span><span class="p">.</span><span class="nx">sortBy</span> <span class="nx">tmp_file_list</span><span class="p">,</span> <span class="nf">(pf) -&gt;</span> <span class="nx">pf</span><span class="p">.</span><span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p>console.log '_preprocess, generation:', ChanceProcessor.generation</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>console.log 'sorting...'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@file_list = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">path_and_file</span> <span class="k">in</span> <span class="nx">tmp_file_list</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>We have to sort alphabetically first...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">mtime = </span><span class="nx">@chance</span><span class="p">.</span><span class="nx">update_file_if_needed</span><span class="p">(</span><span class="nx">path_and_file</span><span class="p">.</span><span class="nx">file</span><span class="p">)</span>
      <span class="nx">@file_mtimes</span><span class="p">[</span><span class="nx">path_and_file</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mtime</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>console.log 'updating mtimes, and <em>including</em>files...'</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@_include_file</span><span class="p">(</span><span class="nx">path_and_file</span><span class="p">.</span><span class="nx">file</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>Empty file<em>list then refresh it with _include</em>file calls.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">relative_paths = </span><span class="p">{}</span>
    <span class="nx">relative_paths</span><span class="p">[</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">@mapped_files</span>

    <span class="nv">cssImportStatements = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>Save the mtime for caching</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@file_list</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>console.log path<em>and</em>file.path, mtime</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">header_file = </span><span class="nx">@chance_header_for_file</span><span class="p">(</span><span class="nx">relative_paths</span><span class="p">[</span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]])</span>
      
      <span class="nv">content = </span><span class="s2">&quot;@_chance_file &quot;</span> <span class="o">+</span> <span class="nx">relative_paths</span><span class="p">[</span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="s2">&quot;;\n&quot;</span>
      <span class="nx">content</span> <span class="o">+=</span> <span class="nx">header_file</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
      <span class="nx">content</span> <span class="o">+=</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>console.log 'setting relative_paths'</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">parser = </span><span class="k">new</span> <span class="nx">ChanceParser</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">@options</span><span class="p">)</span>
      <span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">()</span>
      <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;parsed_css&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">css</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>console.log 'after update<em>file</em>if<em>needed, and sorting', @file</em>list.length</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">re = </span><span class="sr">/[^a-zA-Z0-9\-_\\\/]/</span>
      <span class="nv">path_safe = </span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>

      <span class="nv">tmp_path = </span><span class="s2">&quot;./tmp/chance/#{path_safe}.styl&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>NOTE: WE MUST CALL CHANCE PARSER NOW, because it generates our slices.
We can't be picky and just call it if something has changed. Thankfully,
parser is fast. Unlike SCSS.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">try</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>console.log 'content', content</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">mkdirp</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">path_module</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">tmp_path</span><span class="p">))</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="k">throw</span> <span class="nx">e</span>  <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">isnt</span> <span class="s2">&quot;EEXIST&quot;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="o">not</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;mtime&quot;</span><span class="p">]</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;wtime&quot;</span><span class="p">]</span> <span class="o">or</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;wtime&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;mtime&quot;</span><span class="p">]</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">header_file</span><span class="p">[</span><span class="s2">&quot;mtime&quot;</span><span class="p">]</span> <span class="o">or</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;wtime&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">header_file</span><span class="p">[</span><span class="s2">&quot;mtime&quot;</span><span class="p">])</span>
        <span class="nv">f = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">tmp_path</span><span class="p">,</span> <span class="nx">@_convert_to_styl</span><span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">css</span><span class="p">),</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;wtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">microtime</span><span class="p">.</span><span class="nx">nowDouble</span><span class="p">()</span> <span class="c1"># replaces Time.now.to_f in Ruby</span>

      <span class="nv">cssImportStatement = </span><span class="s2">&quot;@import \&quot;#{tmp_path}\&quot;;&quot;</span>

      <span class="nx">cssImportStatements</span><span class="p">.</span><span class="nx">push</span> <span class="nx">cssImportStatement</span>

    <span class="nx">cssImportStatements</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>We used to use an md5 hash here, but this hides the original file name
from SCSS, which makes the file name + line number comments useless.</p>

<p>Instead, we sanitize the path.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">postprocess_css_dataurl: </span><span class="nf">(opts) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>[TODO] same as for other case of: FileUtils.mkdir<em>p(path</em>module.dirname(tmp_path))</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">re = </span><span class="sr">/_sc_chance\:\s*[&quot;&#39;](.*?)[&quot;&#39;]\s*/</span>
    <span class="nv">css = </span><span class="nx">@cssParsed</span><span class="p">.</span><span class="nx">gsub</span> <span class="nx">re</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">slice = </span><span class="nx">@slices</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

      <span class="nv">url = </span><span class="s1">&#39;data:&#39;</span> <span class="o">+</span> <span class="nx">@type_for</span><span class="p">(</span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;;base64,&quot;</span>
      <span class="nx">url</span> <span class="o">+=</span> <span class="nx">@base64_for</span><span class="p">(</span><span class="nx">slice</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

      <span class="nv">output = </span><span class="s2">&quot;background-image: url(\&quot;#{url}\&quot;);&quot;</span>

      <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>fs.mkdirSync path<em>module.dirname(tmp</em>path), parseInt("0755", 8)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span><span class="o">?</span>
        <span class="nv">width = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;target_width&quot;</span><span class="p">]</span>
        <span class="nv">height = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;target_height&quot;</span><span class="p">]</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;\n-webkit-background-size: #{width}px #{height}px;&quot;</span>

      <span class="nx">output</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>PORTING NOTE: from the original Chance data_url module within the instance module</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">re = </span><span class="sr">/-chance-offset:\s?&quot;(.*?)&quot; (-?[0-9]+) (-?[0-9]+)/</span>
    <span class="nv">css = </span><span class="nx">css</span><span class="p">.</span><span class="nx">gsub</span> <span class="nx">re</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;chance-offset matches&#39;</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># [TODO] Does this still work after replacing / with | in the css_name?</span>
      <span class="s2">&quot;background-position: #{match[2]}px #{match[3]}px&quot;</span>
    <span class="nx">css</span>

  <span class="nv">type_for: </span><span class="nf">(path) -&gt;</span>
    <span class="k">if</span> <span class="sr">/jpg$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="k">then</span> <span class="s2">&quot;image/jpeg&quot;</span> <span class="k">else</span> <span class="s2">&quot;image/#{extname(path)}&quot;</span>

  <span class="nv">base64_for: </span><span class="nf">(slice) -&gt;</span>
    <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>console.log 'postprocess<em>css</em>dataurl', @cssParsed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">contents = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="c1"># [TODO] was to_blob?</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>FOR 2X SLICES</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">contents = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>We do not modify the offset, so we can just pass the original through.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">contents</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)</span> <span class="c1"># replaces Base64.encode64(contents) in ruby</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>If the slice has a canvas, we must read from that.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">javascript: </span><span class="nf">(opts) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Otherwise, this implies the image has not been modified. So, we should
be able to write out the original contents from the slice's file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">preload_javascript</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p>[TODO] should use binary here? Depends on what is used in node.js land, probably.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">preload_javascript: </span><span class="nf">(opts) -&gt;</span>
    <span class="nv">output = </span><span class="s2">&quot;if (typeof CHANCE_SLICES === &#39;undefined&#39;) var CHANCE_SLICES = [];&quot;</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;CHANCE_SLICES = CHANCE_SLICES.concat([&quot;</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;&#39;#{slice[&quot;</span><span class="nx">css_name</span><span class="s2">&quot;]}&#39;&quot;</span> <span class="k">for</span> <span class="nx">name</span><span class="p">,</span><span class="nx">slice</span> <span class="k">of</span> <span class="nx">@slices</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,\n&quot;</span><span class="p">)</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;]);&quot;</span>
    <span class="nx">output</span></pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <p>PORTING NOTE: from the original Chance javascript module within the instance module</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add_canvas_to_cache: </span><span class="nf">(canvas, file, rect) -&gt;</span>
    <span class="vi">@canvas_cache = </span><span class="p">{}</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@canvas_cache</span><span class="o">?</span>
      
    <span class="nv">left = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
    <span class="nv">top = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span>
    <span class="nv">width = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
    <span class="nv">height = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
          
    <span class="nv">key = </span><span class="s2">&quot;#{file[&quot;</span><span class="nx">path</span><span class="s2">&quot;]}:#{left},#{top},#{width},#{height}&quot;</span>
    <span class="nx">@canvas_cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span>
      <span class="nv">mtime: </span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;mtime&quot;</span><span class="p">]</span>
      <span class="nv">canvas: </span><span class="nx">canvas</span>
    
  <span class="nv">get_canvas_from_cache: </span><span class="nf">(file, rect) -&gt;</span>
    <span class="vi">@canvas_cache = </span><span class="p">{}</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@canvas_cache</span><span class="o">?</span>
          
    <span class="nv">left = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
    <span class="nv">top = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span>
    <span class="nv">width = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
    <span class="nv">height = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
          
    <span class="nv">key = </span><span class="s2">&quot;#{file[&quot;</span><span class="nx">path</span><span class="s2">&quot;]}:#{left},#{top},#{width},#{height}&quot;</span>
    <span class="nv">hash = </span><span class="nx">@canvas_cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
          </pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p>Currently, we only include the preload JavaScript</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">hash</span><span class="o">?</span> <span class="o">and</span> <span class="nx">hash</span><span class="p">[</span><span class="s2">&quot;mtime&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;mtime&quot;</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">hash</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span>
          
    <span class="nx">@canvas_cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="kc">null</span> <span class="c1"># [TODO] Why an explicit null return?</span>
      </pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <p>Generates the preload JavaScript</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">slice_images: </span><span class="nf">(opts) -&gt;</span>
    <span class="nv">slices = </span><span class="nx">@slices</span>
    <span class="nv">output = </span><span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="nx">name</span><span class="p">,</span><span class="nx">slice</span> <span class="k">of</span> <span class="nx">slices</span></pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>PORTING NOTE: from the original Chance slicing module within the instance module</p>

<p>The Slicing module handles taking a collection of slice definitions to
produce sliced images. The sliced image is stored in the slice definition.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
          </pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <p>Check to see if it is new enough</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">canvas = </span><span class="nx">@canvas_for</span> <span class="nx">slice</span><span class="p">,</span> <span class="nx">opts</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <p>performs the slicing indicated by each slice definition, and puts the resulting
image in the slice definition's :image property.</p>

<p>if x2 is supplied, this will assume it is a second pass to locate any @2x images
and use them to replace the originals.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">must_slice = </span><span class="p">[</span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">],</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]].</span><span class="nx">some</span> <span class="nf">(bool) -&gt;</span> <span class="nx">bool</span>
      <span class="k">if</span> <span class="nx">must_slice</span> <span class="o">or</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">canvas</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <p>If we modify the canvas, we'll place the modified canvas here.
Otherwise, consumers will use slice["file"] ["canvas"] or ["contents"]
to get the original data as needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">throw</span> <span class="s2">&quot;ChanceProcessor could not load file &#39;#{slice[&quot;</span><span class="nx">path</span><span class="s2">&quot;]}&#39;. If it is not a PNG, RMagick is required to slice or use @2x mode.&quot;</span>

        <span class="nv">f = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;proportion&quot;</span><span class="p">]</span>

        <span class="nv">canvas_width = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span>
        <span class="nv">canvas_height = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span>

        <span class="k">if</span> <span class="nx">must_slice</span>
          <span class="nv">rect = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <p>In any case, if there is one, we need to get the original file and canvas;
this process also tells us if the slice is 2x, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">rect = </span><span class="nx">@slice_rect</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">canvas_width</span> <span class="sr">/ f, canvas_height /</span> <span class="nx">f</span><span class="p">)</span>

          <span class="k">if</span> <span class="nx">rect</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <p>Check if a canvas is required</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">file = </span><span class="nx">@file_for</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
            <span class="nv">cached_canvas = </span><span class="nx">@get_canvas_from_cache</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">rect</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">cached_canvas</span><span class="o">?</span>
              <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cached_canvas</span>
            <span class="k">else</span>
              <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gm</span><span class="p">(</span><span class="nx">canvas</span><span class="p">).</span><span class="nx">crop</span><span class="p">(</span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nx">f</span><span class="p">)</span>
              <span class="nx">@add_canvas_to_cache</span><span class="p">(</span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">],</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">rect</span><span class="p">)</span>
                
            <span class="nv">canvas_width = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nx">f</span>
            <span class="nv">canvas_height = </span><span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nx">f</span>

        <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;target_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">canvas_width</span> <span class="err">/ f</span>
        <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;target_height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">canvas_height</span> <span class="err">/ f</span></pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <p>[TODO] mention of RMagick, which will be replaced</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">canvas_for: </span><span class="nf">(slice, opts) -&gt;</span>
    <span class="nv">file = </span><span class="nx">@file_for</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
    <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <p>The math that uses canvas<em>width and canvas</em>height needs to return numbers that,
when multiplied by f, are valid. So, divide by f first.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">file_for: </span><span class="nf">(slice, opts) -&gt;</span>
    <span class="nv">path = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <h1>CHECK CACHE</h1>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span>
      <span class="k">try</span>
        <span class="nv">path_2x = </span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">extname</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">length</span><span class="p">)]</span> <span class="o">+</span> <span class="s2">&quot;@2x.png&quot;</span> <span class="c1"># [TODO] check end index; in ruby, was: path_2x = path[0..(-1 - File.extname(path).length)] + &quot;@2x.png&quot;</span>

        <span class="nv">file = </span><span class="nx">get_file</span><span class="p">(</span><span class="nx">path_2x</span><span class="p">)</span>
        <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;proportion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Problem making x2 version for #{path}&quot;</span>
    <span class="k">else</span>
      <span class="nv">file = </span><span class="nx">@get_file</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;proportion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;File does not exist: #{slice[&quot;</span><span class="nx">path</span><span class="s2">&quot;]}&quot;</span> <span class="nx">unless</span> <span class="nx">file</span><span class="o">?</span>

    <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">file</span>
    <span class="nx">file</span></pre></div>             </td>           </tr>                               <tr id="section-180">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-180">&#182;</a>               </div>               <p>Opts specify if x2, etc. is allowed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">slice_rect: </span><span class="nf">(slice, image_width, image_height) -&gt;</span>
    <span class="nv">left = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
    <span class="nv">top = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span>
    <span class="nv">bottom = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span>
    <span class="nv">right = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span>
    <span class="nv">width = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
    <span class="nv">height = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>

    <span class="nv">rect = </span><span class="p">{}</span>

    <span class="k">if</span> <span class="nx">left</span><span class="o">?</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">left</span></pre></div>             </td>           </tr>                               <tr id="section-181">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-181">&#182;</a>               </div>               <p>Returns the file to use for the specified slice (normal, or @2x)</p>

<p>The slice's file property will be set to the system file.
If @2x, the x2 flag on the slice is set to true.
opts specify if x2, etc. is allowed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">right</span><span class="o">?</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_width</span> <span class="o">-</span> <span class="nx">right</span> <span class="o">-</span> <span class="nx">left</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">width</span><span class="o">?</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">width</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-182">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-182">&#182;</a>               </div>               <p>Check for x2 version if we are in x2 mode</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_width</span> <span class="o">-</span> <span class="nx">left</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">right</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-183">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-183">&#182;</a>               </div>               <p>Creates the final slice rectangle from the image width and height
returns null if no rectangle or if the slice is the full image</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">width</span><span class="o">?</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_width</span> <span class="o">-</span> <span class="nx">width</span> <span class="o">-</span> <span class="nx">right</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">width</span>
      <span class="k">else</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_width</span> <span class="o">-</span> <span class="nx">right</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">right</span>
    <span class="k">else</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_width</span>

    <span class="k">if</span> <span class="nx">top</span><span class="o">?</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">top</span></pre></div>             </td>           </tr>                               <tr id="section-184">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-184">&#182;</a>               </div>               <p>in this case, it must be left+width or left+right, or left-to-end</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">bottom</span><span class="o">?</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_height</span> <span class="o">-</span> <span class="nx">bottom</span> <span class="o">-</span> <span class="nx">top</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">height</span><span class="o">?</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">height</span>
      <span class="k">else</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_height</span> <span class="o">-</span> <span class="nx">top</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">bottom</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-185">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-185">&#182;</a>               </div>               <p>then this is left-to-end</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">height</span><span class="o">?</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_height</span> <span class="o">-</span> <span class="nx">height</span> <span class="o">-</span> <span class="nx">bottom</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">height</span>
      <span class="k">else</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_height</span> <span class="o">-</span> <span class="nx">bottom</span>
        <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bottom</span>
    <span class="k">else</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">image_height</span>

    <span class="k">if</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="nx">image_width</span> <span class="o">and</span> <span class="nx">rect</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="nx">image_height</span>
      <span class="k">return</span> <span class="kc">null</span>

    <span class="k">return</span> <span class="nx">rect</span></pre></div>             </td>           </tr>                               <tr id="section-186">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-186">&#182;</a>               </div>               <p>in this case it must be right+width or right-to-end</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-187">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-187">&#182;</a>               </div>               <p>in this case, it must be top+height or top+bottom or top-to-bottom</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-188">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-188">&#182;</a>               </div>               <p>in this case it must be bottom+height</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-189">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-189">&#182;</a>               </div>               <p>PORTING NOTE: from the original Chance spriting module within the instance module</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">generate_sprite_definitions: </span><span class="nf">(opts) -&gt;</span>
    <span class="vi">@sprites = </span><span class="p">{}</span>

    <span class="nx">@group_slices_into_sprites</span> <span class="nx">opts</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span><span class="nx">sprite</span> <span class="k">of</span> <span class="nx">@sprites</span>
      <span class="nx">@layout_slices_in_sprite</span> <span class="nx">sprite</span><span class="p">,</span> <span class="nx">opts</span></pre></div>             </td>           </tr>                               <tr id="section-190">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-190">&#182;</a>               </div>               <p>Spriting support.</p>

<p>The sprite method performs the spriting. It creates collections of
images to sprite and then calls layout<em>sprite and generate</em>sprite.</p>

<p>The layout_sprite method arranges the slices, defining their positions
within the sprites.</p>

<p>The generate_sprite method combines the slices into an image.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">group_slices_into_sprites: </span><span class="nf">(opts) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span><span class="nx">slice</span> <span class="k">of</span> <span class="nx">@slices</span>
      <span class="nv">sprite = </span><span class="nx">@sprite_for_slice</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
      <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;slices&quot;</span><span class="p">].</span><span class="nx">push</span> <span class="nx">slice</span>

      <span class="nx">@sprites</span><span class="p">[</span><span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">sprite</span></pre></div>             </td>           </tr>                               <tr id="section-191">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-191">&#182;</a>               </div>               <p>The Spriting module handles sorting slices into sprites, laying them
out within the sprites, and generating the final sprite images.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sprite_for_slice: </span><span class="nf">(slice, opts) -&gt;</span>
    <span class="nv">sprite_name = </span><span class="nx">@sprite_name_for_slice</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>

    <span class="nv">newOpts =</span>
      <span class="nv">horizontal_layout: </span><span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;repeat-y&quot;</span> <span class="k">then</span> <span class="kc">true</span> <span class="k">else</span> <span class="kc">false</span>
    <span class="nx">opts</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">newOpts</span>

    <span class="nx">@get_sprite_named</span> <span class="nx">sprite_name</span><span class="p">,</span> <span class="nx">opts</span>

    <span class="nx">@sprites</span><span class="p">[</span><span class="nx">sprite_name</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-192">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-192">&#182;</a>               </div>               <p>Performs the spriting process on all of the @slices, creating sprite
images in the class's @sprites property and updating the individual slices 
with a :sprite property containing the identifier of the sprite, and offset
properties for the offsets within the image.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_sprite_named: </span><span class="nf">(sprite_name, opts) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@sprites</span><span class="p">[</span><span class="nx">sprite_name</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">@sprites</span><span class="p">[</span><span class="nx">sprite_name</span><span class="p">]</span> <span class="o">=</span>
        <span class="nv">name: </span><span class="nx">sprite_name</span>
        <span class="nv">slices: </span><span class="p">[]</span>
        <span class="nv">has_generated: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-193">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-193">&#182;</a>               </div>               <p>Determines the appropriate sprite for each slice, creating it if necessary,
and puts the slice into that sprite. The appropriate sprite may differ based
on the slice's repeat settings, for instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">use_horizontal_layout: </span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;horizontal_layout&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-194">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-194">&#182;</a>               </div>               <p>Returns the sprite to use for the given slice, creating the sprite if needed.
The sprite could differ based on repeat settings or file type, for instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sprite_name_for_slice: </span><span class="nf">(slice, opts) -&gt;</span>
    <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;repeat&quot;</span>
      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="k">if</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="k">then</span> <span class="s2">&quot;@2x&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="k">if</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="k">then</span> <span class="s2">&quot;@2x&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">extname</span><span class="p">(</span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-195">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-195">&#182;</a>               </div>               <p>Creates a sprite definition with a given name and set of options</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">layout_slices_in_sprite: </span><span class="nf">(sprite, opts) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-196">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-196">&#182;</a>               </div>               <p>The sprite will use horizontal layout under repeat-y, where images
must stretch all the way from the top to the bottom</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">pos = </span><span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-197">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-197">&#182;</a>               </div>               <p>Determines the name of the sprite for the given slice. The sprite
by this name may not exist yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">padding = </span><span class="k">if</span> <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;pad_sprites_for_debugging&quot;</span><span class="p">]</span> <span class="k">then</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-198">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-198">&#182;</a>               </div>               <p>Performs the layout operation, laying either up-to-down, or "
(for repeat-y slices) left-to-right.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">inset = </span><span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-199">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-199">&#182;</a>               </div>               <p>console.log 'layout<em>slices</em>in_sprite', sprite, opts
The position is the position in the layout direction. In vertical mode
(the usual) it is the Y position.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">row_length = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-200">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-200">&#182;</a>               </div>               <p>Adds some padding that will be painted with a pattern so that it is apparent that
CSS is wrong.
NOTE: though this is only in debug mode, we DO need to make sure it is on a 2px boundary.
This makes sure 2x works properly.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">size = </span><span class="mi">1</span>
    <span class="nv">smallest_size = </span><span class="kc">null</span>

    <span class="nv">is_horizontal = </span><span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;use_horizontal_layout&quot;</span><span class="p">]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-201">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-201">&#182;</a>               </div>               <p>The position within a row. It starts at 0 even if we have padding,
because we always just add padding when we set the individual x/y pos.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">slice</span> <span class="k">in</span> <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;slices&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-202">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-202">&#182;</a>               </div>               <p>The length of the row. Length, when layout out vertically (the usual), is the height</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">canvas = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">?</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-203">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-203">&#182;</a>               </div>               <p>The size is the current size of the sprite in the non-layout direction;
for example, in the usual, vertical mode, the size is the width.</p>

<p>Usually, this is computed as a simple max of itself and the width of any
given slice. However, when repeating, the least common multiple is used,
and the smallest item is stored as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">unless</span> <span class="nx">canvas</span>
        <span class="k">throw</span> <span class="s2">&quot;Could not sprite image #{slice[&quot;</span><span class="nx">path</span><span class="s2">&quot;]}; if it is not a PNG, make sure you have rmagick installed&quot;</span>
          
      <span class="nx">gm</span><span class="p">(</span><span class="nx">canvas</span><span class="p">).</span><span class="nx">size</span> <span class="nf">(err, data) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Error -- sizing canvas image&quot;</span>
        <span class="k">else</span>
          <span class="nv">slice_width = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span>
          <span class="nv">slice_height = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span>
      
          <span class="nv">slice_length = </span><span class="k">if</span> <span class="nx">is_horizontal</span> <span class="k">then</span> <span class="nx">slice_width</span> <span class="k">else</span> <span class="nx">slice_height</span>
          <span class="nv">slice_size = </span><span class="k">if</span> <span class="nx">is_horizontal</span> <span class="k">then</span> <span class="nx">slice_height</span> <span class="k">else</span> <span class="nx">slice_width</span>
          </pre></div>             </td>           </tr>                               <tr id="section-204">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-204">&#182;</a>               </div>               <p>Figure out slice width/heights. We cannot rely on slicing to do this for us
because some images may be being passed through as-is.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">isnt</span> <span class="s2">&quot;no-repeat&quot;</span>
            <span class="nv">smallest_size = </span><span class="nx">slice_size</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">smallest_size</span><span class="o">?</span>
            <span class="nv">smallest_size = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="p">[</span><span class="nx">slice_size</span><span class="p">,</span> <span class="nx">smallest_size</span><span class="p">]...</span>
    
            <span class="nv">lcmCalculator = </span><span class="k">new</span> <span class="nx">LCMCalculator</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">slice_size</span>
            <span class="nv">size = </span><span class="nx">lcmCalculator</span><span class="p">.</span><span class="nx">lcm</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="nv">size = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="p">[</span><span class="nx">size</span><span class="p">,</span> <span class="nx">slice_size</span> <span class="o">+</span> <span class="nx">padding</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]...</span>
          
          <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;slice_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="nx">slice_width</span>
          <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;slice_height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="nx">slice_height</span>
        </pre></div>             </td>           </tr>                               <tr id="section-205">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-205">&#182;</a>               </div>               <p>We must find a canvas either on the slice (if it was actually sliced),
or on the slice's file. Otherwise, we're in big shit.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;slices&quot;</span><span class="p">].</span><span class="nx">sort</span> <span class="nf">(a, b) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-206">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-206">&#182;</a>               </div>               <p>TODO: MAKE A BETTER ERROR.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">is_horizontal</span>
              <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="s2">&quot;slice_height&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">[</span><span class="s2">&quot;slice_height&quot;</span><span class="p">]</span>
              <span class="mi">0</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="s2">&quot;slice_height&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="nx">a</span><span class="p">[</span><span class="s2">&quot;slice_height&quot;</span><span class="p">]</span>
              <span class="mi">1</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="s2">&quot;slice_height&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">[</span><span class="s2">&quot;slice_height&quot;</span><span class="p">]</span>
            <span class="k">else</span>
              <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="s2">&quot;slice_width&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">[</span><span class="s2">&quot;slice_width&quot;</span><span class="p">]</span>
              <span class="mi">0</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="s2">&quot;slice_width&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="nx">a</span><span class="p">[</span><span class="s2">&quot;slice_width&quot;</span><span class="p">]</span>
              <span class="mi">1</span> <span class="k">if</span> <span class="nx">b</span><span class="p">[</span><span class="s2">&quot;slice_width&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">[</span><span class="s2">&quot;slice_width&quot;</span><span class="p">]</span>
      
          <span class="k">for</span> <span class="nx">slice</span> <span class="k">in</span> <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;slices&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-207">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-207">&#182;</a>               </div>               <p>When repeating, we must use the least common multiple so that
we can ensure the repeat pattern works even with multiple repeat
sizes. However, we should take into account how much extra we are
adding by tracking the smallest size item as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">canvas = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">or</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span>
                
            <span class="nv">slice_width = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;slice_width&quot;</span><span class="p">]</span>
            <span class="nv">slice_height = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;slice_height&quot;</span><span class="p">]</span>
                
            <span class="nv">slice_length = </span><span class="k">if</span> <span class="nx">is_horizontal</span> <span class="k">then</span> <span class="nx">slice_width</span> <span class="k">else</span> <span class="nx">slice_height</span>
            <span class="nv">slice_size = </span><span class="k">if</span> <span class="nx">is_horizontal</span> <span class="k">then</span> <span class="nx">slice_height</span> <span class="k">else</span> <span class="nx">slice_width</span>
                
            <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">isnt</span> <span class="s2">&quot;no-repeat&quot;</span> <span class="o">or</span> <span class="nx">inset</span> <span class="o">+</span> <span class="nx">slice_size</span> <span class="o">+</span> <span class="nx">padding</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="nx">size</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;optimize_sprites&quot;</span><span class="p">]</span>
              <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">row_length</span>
              <span class="nv">inset = </span><span class="mi">0</span>
              <span class="nv">row_length = </span><span class="mi">0</span>
                  
      </pre></div>             </td>           </tr>                               <tr id="section-208">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-208">&#182;</a>               </div>               <p>Sort slices from widest/tallest (dependent on is<em>horizontal) or is</em>vertical
NOTE: This means we are technically sorting reversed</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;min_offset_x&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">is_horizontal</span>
              <span class="nx">slice_length</span> <span class="o">-=</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;min_offset_x&quot;</span><span class="p">]</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;min_offset_y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">is_horizontal</span>
              <span class="nx">slice_length</span> <span class="o">-=</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;min_offset_y&quot;</span><span class="p">]</span>
      
            <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;max_offset_x&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">is_horizontal</span>
              <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;max_offset_x&quot;</span><span class="p">]</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;max_offset_y&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">is_horizontal</span>
              <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;max_offset_y&quot;</span><span class="p">]</span>
            
            <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">if</span> <span class="nx">is_horizontal</span> <span class="k">then</span> <span class="nx">pos</span> <span class="k">else</span> <span class="nx">inset</span><span class="p">)</span>
            <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">if</span> <span class="nx">is_horizontal</span> <span class="k">then</span> <span class="nx">inset</span> <span class="k">else</span> <span class="nx">pos</span><span class="p">)</span>
            </pre></div>             </td>           </tr>                               <tr id="section-209">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-209">&#182;</a>               </div>               <p>WHY &lt;=> NO WORK?</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;no-repeat&quot;</span> <span class="o">or</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;repeat-y&quot;</span>
              <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_x&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">padding</span>
            
            <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;no-repeat&quot;</span> <span class="o">or</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;repeat-x&quot;</span>
              <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_y&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">padding</span>
            
            <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">slice_width</span>
            <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">slice_height</span>
      
            <span class="nx">inset</span> <span class="o">+=</span> <span class="nx">slice_size</span> <span class="o">+</span> <span class="nx">padding</span> <span class="o">*</span> <span class="mi">2</span>
            </pre></div>             </td>           </tr>                               <tr id="section-210">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-210">&#182;</a>               </div>               <p>We must find a canvas either on the slice (if it was actually sliced),
or on the slice's file. Otherwise, we're in big shit.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">row_length = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="p">[</span><span class="nx">slice_length</span> <span class="o">+</span> <span class="p">(</span><span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">isnt</span> <span class="s2">&quot;repeat&quot;</span> <span class="k">then</span> <span class="nx">padding</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">row_length</span><span class="p">]...</span>
            </pre></div>             </td>           </tr>                               <tr id="section-211">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-211">&#182;</a>               </div>               <p>We have extras for manual tweaking of offsetx/y. We have to make sure there
is padding for this (on either side)</p>

<p>We have to add room for the minimum offset by adding to the end, and add
room for the max by adding to the front. We only care about it in our
layout direction. Otherwise, the slices are flush to the edge, so it won't
matter.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span>
              <span class="nv">row_length = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">row_length</span><span class="p">.</span><span class="nx">to_f</span> <span class="err">/ 2) * 2</span>
              <span class="nv">inset = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">inset</span><span class="p">.</span><span class="nx">to_f</span> <span class="err">/ 2) * 2</span>
      
          <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">row_length</span>
      </pre></div>             </td>           </tr>                               <tr id="section-212">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-212">&#182;</a>               </div>               <p>add padding for x, only if it a) doesn't repeat or b) repeats vertically because it has horizontal layout</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">smallest_size = </span><span class="nx">size</span> <span class="k">if</span> <span class="nx">smallest_size</span> <span class="o">is</span> <span class="kc">null</span>
          <span class="k">if</span> <span class="nx">size</span> <span class="o">-</span> <span class="nx">smallest_size</span> <span class="o">&gt;</span> <span class="mi">10</span>
            <span class="nx">puts</span> <span class="s2">&quot;WARNING: Used more than 10 extra rows or columns to accommodate repeating slices.&quot;</span>
            <span class="nx">puts</span> <span class="s2">&quot;Wasted up to #{(pos * size-smallest_size)} pixels&quot;</span>
      
          <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">is_horizontal</span> <span class="k">then</span> <span class="nx">pos</span> <span class="k">else</span> <span class="nx">size</span>
          <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">is_horizontal</span> <span class="k">then</span> <span class="nx">size</span> <span class="k">else</span> <span class="nx">pos</span>
      </pre></div>             </td>           </tr>                               <tr id="section-213">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-213">&#182;</a>               </div>               <p>We pad the row length ONLY if it is a repeat-x, repeat-y, or no-repeat image.
If it is 'repeat', we do not pad it, because it should be processed raw.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">generate_sprite: </span><span class="nf">(sprite) -&gt;</span>
    <span class="nv">canvas = </span><span class="nx">@canvas_for_sprite</span><span class="p">(</span><span class="nx">sprite</span><span class="p">)</span>
    <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">canvas</span>
        </pre></div>             </td>           </tr>                               <tr id="section-214">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-214">&#182;</a>               </div>               <p>In 2X, make sure we are aligned on a 2px grid.
We correct this AFTER positioning because we always position on an even grid anyway;
we just may leave that even grid if we have an odd-sized image. We do this after positioning
so that the next loop knows if there is space.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@options</span><span class="p">[</span><span class="s2">&quot;pad_sprites_for_debugging&quot;</span><span class="p">]</span>
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">region</span><span class="p">(</span><span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">stroke</span><span class="p">(</span><span class="s2">&quot;magenta&quot;</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">slice</span> <span class="k">in</span> <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;slices&quot;</span><span class="p">]</span>
      <span class="nv">x = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_x&quot;</span><span class="p">]</span>
      <span class="nv">y = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_y&quot;</span><span class="p">]</span>
      <span class="nv">width = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_width&quot;</span><span class="p">]</span>
      <span class="nv">height = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_height&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-215">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-215">&#182;</a>               </div>               <p>TODO: USE A CONSTANT FOR THIS WARNING</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;repeat-y&#39;</span>
        <span class="nv">height = </span><span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>

      <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;repeat&quot;</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;repeat-x&#39;</span>
        <span class="nv">width = </span><span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>

      <span class="nx">@compose_slice_on_canvas</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">slice</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span>

  <span class="nv">canvas_for_sprite: </span><span class="nf">(sprite) -&gt;</span>
    <span class="nx">gm</span> <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-216">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-216">&#182;</a>               </div>               <p>Generates the image for the specified sprite, putting it in the sprite's 
canvas property.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compose_slice_on_canvas: </span><span class="nf">(target, slice, x, y, width, height) -&gt;</span>
    <span class="nv">source_canvas = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">or</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span>
    <span class="nv">source_width = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_width&quot;</span><span class="p">]</span>
    <span class="nv">source_height = </span><span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_height&quot;</span><span class="p">]</span>

    <span class="nv">top = </span><span class="mi">0</span>
    <span class="nv">left = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-217">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-217">&#182;</a>               </div>               <p>If we are padding sprites, we should paint the background something really
obvious &amp; obnoxious. Say, magenta. That's obnoxious. A nice light purple wouldn't
be bad, but magenta... that will stick out like a sore thumb (I hope)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="nx">top</span> <span class="o">&lt;</span> <span class="nx">height</span>
      <span class="nv">left = </span><span class="mi">0</span>
      <span class="k">while</span> <span class="nx">left</span> <span class="o">&lt;</span> <span class="nx">width</span>
        <span class="nx">gm</span><span class="p">.</span><span class="nx">draw</span> <span class="s2">&quot;-geometry +#{left + x}+#{top + y} #{source_canvas} #{target}&quot;</span>
        <span class="nx">left</span> <span class="o">+=</span> <span class="nx">source_width</span>
        <span class="nx">top</span> <span class="o">+=</span> <span class="nx">source_height</span></pre></div>             </td>           </tr>                               <tr id="section-218">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-218">&#182;</a>               </div>               <p>If it repeats, it needs to go edge-to-edge in one direction</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">postprocess_css_sprited: </span><span class="nf">(opts) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-219">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-219">&#182;</a>               </div>               <p>Writes a slice to the target canvas, repeating it as necessary to fill the width/height.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-220">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-220">&#182;</a>               </div>               <p>Repeat the pattern to fill the width/height.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@generate_sprite_definitions</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>

    <span class="nv">re = </span><span class="sr">/_sc_chance:\s*[&quot;&#39;](.*?)[&quot;&#39;]/</span>
    <span class="nv">css = </span><span class="nx">@cssParsed</span><span class="p">.</span><span class="nx">gsub</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(match) -&gt;</span>
      <span class="nv">slice = </span><span class="nx">@slices</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
      <span class="nv">sprite = </span><span class="nx">@sprite_for_slice</span><span class="p">(</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>

      <span class="nv">output = </span><span class="s2">&quot;background-image: chance_file(&#39;#{sprite[&quot;</span><span class="nx">name</span><span class="s2">&quot;]}&#39;)\n&quot;</span>

      <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span>
        <span class="nv">width = </span><span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;proportion&quot;</span><span class="p">]</span>
        <span class="nv">height = </span><span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;proportion&quot;</span><span class="p">]</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="s2">&quot;;  -webkit-background-size: #{width}px #{height}px&quot;</span>

      <span class="nx">output</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;ggggggg&#39;</span><span class="p">,</span> <span class="nx">css</span>
    <span class="nv">re = </span><span class="sr">/-chance-offset:\s?&quot;(.*?)&quot; (-?[0-9]+) (-?[0-9]+)/</span>
    <span class="nv">css = </span><span class="nx">css</span><span class="p">.</span><span class="nx">gsub</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(match) -&gt;</span>
      <span class="nv">slice = </span><span class="nx">@slices</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

      <span class="nv">slice_x = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_x&quot;</span><span class="p">]</span>
      <span class="nv">slice_y = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;sprite_slice_y&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-221">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-221">&#182;</a>               </div>               <p>Postprocesses the CSS, inserting sprites and defining offsets.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span>
        <span class="nx">slice_x</span> <span class="err">/= slice[&quot;proportion&quot;]</span>
        <span class="nx">slice_y</span> <span class="err">/= slice[&quot;proportion&quot;]</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;replacing it&#39;</span>
      <span class="s2">&quot;background-position: #{slice_x}px #{slice_y}px&quot;</span>
    <span class="nx">css</span>

  <span class="nv">sprite_data: </span><span class="nf">(opts) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-222">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-222">&#182;</a>               </div>               <p>The images should already be sliced appropriately, as we are
called by the css method, which calls slice_images.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@_render</span><span class="p">()</span>
    <span class="nx">@slice_images</span> <span class="nx">opts</span>
    <span class="nx">@generate_sprite_definitions</span> <span class="nx">opts</span>

    <span class="nv">sprite = </span><span class="nx">@sprites</span><span class="p">[</span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span></pre></div>             </td>           </tr>                               <tr id="section-223">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-223">&#182;</a>               </div>               <p>We will need the position of all sprites, so generate the sprite
definitions now:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">sprite</span><span class="o">?</span>
      <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nx">@generate_sprite</span><span class="p">(</span><span class="nx">sprite</span><span class="p">)</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;has_generated&quot;</span><span class="p">]</span>

    <span class="nv">ret = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span> <span class="nx">slice</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="c1"># [TODO] was to_blob?</span>
        
    <span class="k">if</span> <span class="nx">ChanceProcessor</span><span class="p">.</span><span class="nx">clear_files_immediately</span>
      <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="nx">sprite</span><span class="p">[</span><span class="s2">&quot;has_generated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="nx">ret</span>

  <span class="nv">sprite_names: </span><span class="nf">(opts={}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-224">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-224">&#182;</a>               </div>               <p>If it is 2x, we are scaling the slice down by 2, making all of our
positions need to be 1/2 of what they were.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@_render</span><span class="p">()</span>
    <span class="nx">@slice_images</span> <span class="nx">opts</span>
    <span class="nx">@generate_sprite_definitions</span> <span class="nx">opts</span>

    <span class="nx">key</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span><span class="nx">value</span> <span class="k">of</span> <span class="nx">@sprites</span></pre></div>             </td>           </tr>                               <tr id="section-225">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-225">&#182;</a>               </div>               <p>console.log 'sprite_data', opts</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ChanceProcessorFactory</span>
  <span class="nv">constructor: </span><span class="nf">(chance) -&gt;</span>
    <span class="vi">@chance = </span><span class="nx">chance</span>
    <span class="vi">@instances = </span><span class="p">{}</span>
    <span class="vi">@file_hashes = </span><span class="p">{}</span>

  <span class="nv">clear_instances: </span><span class="o">-&gt;</span>
    <span class="vi">@instances = </span><span class="p">{}</span>
    <span class="vi">@file_hashes = </span><span class="p">{}</span>
    
  <span class="nv">instance_for_key: </span><span class="nf">(key, opts) -&gt;</span>
    <span class="k">if</span> <span class="nx">key</span> <span class="o">not</span> <span class="k">of</span> <span class="nx">@instances</span>
      <span class="nx">@instances</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ChanceProcessor</span><span class="p">(</span><span class="nx">@chance</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
      
    <span class="k">return</span> <span class="nx">@instances</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-226">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-226">&#182;</a>               </div>               <p>When the sprite is null, it simply means there weren't any images,
so this sprite is not needed. But build systems may still
expect this file to exist. We'll just make it empty.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">update_instance: </span><span class="nf">(key, opts, files) -&gt;</span>
    <span class="nv">instance = </span><span class="nx">@instance_for_key</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
    <span class="nv">last_hash = </span><span class="nx">@file_hashes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?</span> <span class="p">{}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-227">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-227">&#182;</a>               </div>               <p>console.log 'sprite_names', opts</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">last_hash</span> <span class="o">isnt</span> <span class="nx">files</span></pre></div>             </td>           </tr>                               <tr id="section-228">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-228">&#182;</a>               </div>               <p>PORTING NOTE: from the original Chance ProcessorFactory module.</p>

<p>The ChanceProcessorFactory class is the ChanceProcessor instance factory.</p>

<p>All methods require two parts: a key and a hash of options. The hash will be used in
the case of a cache missed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">instance</span><span class="p">.</span><span class="nx">unmap_all</span>
      <span class="nx">instance</span><span class="p">.</span><span class="nx">map_file</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">identifier</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">path</span><span class="p">,</span><span class="nx">identifier</span> <span class="k">of</span> <span class="nx">files</span>
      <span class="nx">@file_hashes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">files</span></pre></div>             </td>           </tr>                               <tr id="section-229">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-229">&#182;</a>               </div>               <p>Call with a hash that maps instance paths to absolute paths. This will compare with the last.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">FileNotFoundError</span>
  <span class="nv">constructor: </span><span class="nf">(@path) -&gt;</span>

  <span class="nv">message: </span><span class="o">-&gt;</span>
    <span class="s2">&quot;File not mapped in ChanceProcessor instance: #{@path}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-230">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-230">&#182;</a>               </div>               <p>If they are not equal, we might as well throw everything. The biggest cost is from
ChanceProcessor re-running, and it will have to anyway.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Chance</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@files = </span><span class="p">{}</span>
    <span class="vi">@_current_instance = </span><span class="kc">null</span>
    <span class="vi">@clear_files_immediately = </span><span class="kc">false</span>

  <span class="nv">add_file: </span><span class="nf">(path, content=null) -&gt;</span>
    <span class="k">if</span> <span class="nx">path</span> <span class="k">of</span> <span class="nx">@files</span>
      <span class="k">return</span> <span class="nx">@update_file_if_needed</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
      
    <span class="nv">mtime = </span><span class="mi">0</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">content</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-231">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-231">&#182;</a>               </div>               <p>console.log 'update<em>instance last</em>hash isnt files'</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">stats = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">path</span>

    <span class="nv">file =</span>
      <span class="nv">mtime: </span><span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span>
      <span class="nv">path: </span><span class="nx">path</span>
      <span class="nv">content: </span><span class="nx">content</span>
      <span class="nv">preprocessed: </span><span class="kc">false</span>
      
    <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">file</span></pre></div>             </td>           </tr>                               <tr id="section-232">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-232">&#182;</a>               </div>               <p>PORTING NOTE: simplified from the original Chance version.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">update_file: </span><span class="nf">(@path, @content=null) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-233">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-233">&#182;</a>               </div>               <p>PORTING NOTE: from the original Chance module.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Could not update #{path} because it is not in system.&quot;</span>
      <span class="k">return</span>
      
    <span class="nv">mtime = </span><span class="mi">0</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">content</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-234">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-234">&#182;</a>               </div>               <pre><code> fs.stat path, (err, stats) =&gt;  # [TODO] should use sync version?
</code></pre>

<p>if err
 util.puts "ERROR adding file: " + err.message
else
 mtime = stats.mtime # [TODO] replaces: mtime = File.mtime(path).to_f</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">stats = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">path</span>

    <span class="nv">file =</span>
      <span class="nv">mtime: </span><span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span>
      <span class="nv">path: </span><span class="nx">path</span>
      <span class="nv">content: </span><span class="nx">content</span>
      <span class="nv">preprocessed: </span><span class="kc">false</span>
      
    <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">file</span></pre></div>             </td>           </tr>                               <tr id="section-235">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-235">&#182;</a>               </div>               <p>console.log 'chance added', path</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">update_file_if_needed: </span><span class="nf">(path, content=null) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-236">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-236">&#182;</a>               </div>               <p>console.log 'update_file'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-237">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-237">&#182;</a>               </div>               <pre><code> fs.stat path, (err, stats) =&gt;  # [TODO] should use sync version?
</code></pre>

<p>if err
 util.puts "ERROR updating file: " + err.message
else
 mtime = stats.mtime # [TODO] replaces: mtime = File.mtime(path).to_f</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">stats = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">path</span>

    <span class="k">if</span> <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
      <span class="k">if</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span> <span class="o">&gt;</span> <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s2">&quot;mtime&quot;</span><span class="p">]</span>
        <span class="nx">@update_file</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
      <span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span>
    <span class="k">else</span>
      <span class="kc">false</span>
        
  <span class="nv">remove_file: </span><span class="nf">(path) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Could not remove #{path} because it is not in system.&quot;</span>
      <span class="k">return</span>

    <span class="nx">@files</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-238">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-238">&#182;</a>               </div>               <p>if the path is a valid filesystem path and the mtime has changed, this invalidates
the file. Returns the mtime if the file was updated.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">remove_all_files: </span><span class="o">-&gt;</span>
    <span class="vi">@files = </span><span class="p">{}</span>
    
  <span class="nv">has_file: </span><span class="nf">(path) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="kc">true</span>
    
  <span class="nv">get_file: </span><span class="nf">(path) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Could not find #{path} in Chance.&quot;</span>
      <span class="k">return</span> <span class="kc">null</span>
    
    <span class="nv">file = </span><span class="nx">@files</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
      
    <span class="k">if</span> <span class="o">not</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-239">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-239">&#182;</a>               </div>               <p>console.log 'update<em>file</em>if_needed'</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="k">if</span> <span class="sr">/css$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="k">then</span> <span class="s1">&#39;UTF-8&#39;</span> <span class="k">else</span> <span class="s1">&#39;binary&#39;</span><span class="p">)</span> <span class="c1"># [TODO] ruby version had rb for reading binary flag</span>
      
    <span class="k">if</span> <span class="o">not</span> <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;preprocessed&quot;</span><span class="p">]</span>
      <span class="nx">@_preprocess</span> <span class="nx">file</span>
      
    <span class="nx">file</span>

  <span class="nv">_preprocess: </span><span class="nf">(file) -&gt;</span>
    <span class="nx">@_preprocess_css</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="k">if</span> <span class="sr">/css$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
    <span class="nx">@_preprocess_image</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="k">if</span> <span class="sr">/png$|gif|jpg$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>

    <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;preprocessed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="nv">_preprocess_image: </span><span class="nf">(file) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-240">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-240">&#182;</a>               </div>               <pre><code> fs.stat path, (err, stats) =&gt;  # [TODO] should use sync version?
</code></pre>

<p>if err
 util.puts "ERROR updating file: " + err.message
else
 if @files[path]?
   if stats.mtime > @files[path]["mtime"]
     update_file(path, content)
   stats.mtime
 else
   false</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;canvas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="s1">&#39;binary&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)</span> <span class="c1"># replaces Base64.encode64(contents) in ruby</span>

  <span class="nv">_preprocess_css: </span><span class="nf">(file) -&gt;</span>
    <span class="nv">content = </span><span class="nx">file</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-241">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-241">&#182;</a>               </div>               <p>Removes all files from Chance; used to reset environment for testing.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">requires = </span><span class="p">[]</span>
    <span class="nv">re = </span><span class="sr">/(sc_)?require\([&#39;&quot;]?(.*?)[&#39;&quot;]?\);?/</span>
    <span class="nv">content = </span><span class="nx">content</span><span class="p">.</span><span class="nx">gsub</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(match) -&gt;</span>
      <span class="nx">requires</span><span class="p">.</span><span class="nx">push</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-242">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-242">&#182;</a>               </div>               <p>note: CSS files should be opened as UTF-8.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">re = </span><span class="sr">/sc_resource\([&#39;&quot;]?(.*?)[&#39;&quot;]?\);?/</span>
    <span class="nv">content = </span><span class="nx">content</span><span class="p">.</span><span class="nx">gsub</span> <span class="nx">re</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># [TODO] is this a replace?</span>

    <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;requires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">requires</span> <span class="c1"># [TODO] haven&#39;t seen requires get any hits.</span>
    <span class="nx">file</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">content</span>

<span class="nv">exports.ChanceParser = </span><span class="nx">ChanceParser</span>
<span class="nv">exports.ChanceProcessor = </span><span class="nx">ChanceProcessor</span>
<span class="nv">exports.ChanceProcessorFactory = </span><span class="nx">ChanceProcessorFactory</span>
<span class="nv">exports.Chance = </span><span class="nx">Chance</span>

</pre></div>             </td>           </tr>                               <tr id="section-243">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-243">&#182;</a>               </div>               <p>[TODO] was from_blob?  the Rmagick one needed file["content"][0]
console.log 'preprocessing image', file
console.log file["content"]</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-244">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-244">&#182;</a>               </div>               <p>console.log 'preprocessing css'</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-245">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-245">&#182;</a>               </div>               <p>sc_resource will already be handled by the build tool. We just need to ignore it.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 